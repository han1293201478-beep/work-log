<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆäº‘ç«¯åŒæ­¥ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ========== åŸæœ‰æ ·å¼ä¿ç•™ ========== */
    body {
      font-family: "Microsoft YaHei", sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 950px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #333;
    }
    h1 { text-align: center; }
    .nav-tabs button {
      margin: 0 6px;
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      border-radius: 4px;
    }
    .nav-tabs button.active {
      background: #1890ff;
      color: white;
      border-color: #1890ff;
    }

    /* ========== æ—¥å†ç›¸å…³æ ·å¼ ========== */
    .month-picker, .view-toggle, .import-export, .nav-tabs, .controls {
      text-align: center;
      margin: 10px 0;
    }
    .calendar {
      display: grid;
      gap: 4px;
      margin-top: 10px;
    }
    .day-header {
      text-align: center;
      font-weight: bold;
      padding: 6px;
      background: #eee;
      border-radius: 4px;
      font-size: 14px;
    }
    .day-cell {
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background: #fff;
      font-size: 14px;
      user-select: none;
      position: relative;
      padding: 4px;
      text-align: center;
    }
    .day-number { font-weight: bold; }
    .day-hours { font-size: 12px; color: #666; margin-top: 2px; }
    .day-extra { font-size: 11px; color: #999; }
    .day-total { font-size: 11px; color: #d46b08; font-weight: bold; margin-top: 2px; }
    .day-cell:hover { background: #e6f7ff; }
    .day-cell.selected-big { background: #ffe58f; border-color: #faad14; }
    .day-cell.selected-small { background: #b7eb8f; border-color: #52c41a; }
    .day-cell.custom { background: #ffd6e7; border-color: #eb2f96; }
    .day-cell.over-limit { box-shadow: 0 0 0 3px red; }
    .day-cell.multi-selected { outline: 2px solid blue; z-index: 2; }

    .controls button {
      margin: 5px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-big { background: #faad14; color: white; }
    .btn-small { background: #52c41a; color: white; }
    .btn-clear { background: #d9d9d9; color: black; }
    .btn-delete { background: #ff4d4f; color: white; }
    .btn-extra { background: #722ed1; color: white; }
    .btn-settings { background: #13c2c2; color: white; }
    .btn-sync { background: #52c41a; color: white; }

    .shift-info {
      margin-top: 20px;
      padding: 15px;
      background: #f0f9ff;
      border-radius: 6px;
    }
    .result {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    .ok { background: #f6ffed; color: #52c41a; }
    .warn { background: #fff2f0; color: #ff4d4f; }

    .week-summary {
      margin-top: 20px;
    }
    .week-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }
    .week-item {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    .week-item.violation {
      background: #fff2f0;
      color: #ff4d4f;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      text-align: left;
    }
    .modal h3 {
      text-align: center;
      margin-top: 0;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .modal-buttons {
      text-align: center;
      margin-top: 15px;
    }
    .modal-buttons button {
      margin: 0 8px;
    }

    #importFileInput { display: none; }

    /* ========== è®¾ç½®ä¸ç»Ÿè®¡é¢æ¿ ========== */
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }

    .settings-grid, .stats-controls, .stats-grid {
      display: grid;
      gap: 15px;
      margin-top: 15px;
    }
    .settings-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .setting-item, .stat-item {
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid #eee;
    }
    .setting-item label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      font-size: 14px;
    }
    .setting-item input, .setting-item select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #1890ff;
      margin-top: 6px;
    }

    /* ç»Ÿè®¡é¢æ¿ä¸“ç”¨ */
    .stats-controls {
      grid-template-columns: 1fr 1fr auto;
      align-items: end;
    }
    .stats-controls > div {
      display: flex;
      flex-direction: column;
    }
    .stats-controls label {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .stats-controls input[type="date"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .stats-controls button {
      height: 34px;
      margin-top: 22px;
    }

    #chartContainer {
      margin-top: 20px;
      position: relative;
      height: 300px;
    }

    /* å¤šé€‰æ¨¡å¼æŒ‡ç¤ºå™¨ */
    .selection-mode-indicator {
      background: #1890ff;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
    }

    /* åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .sync-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      background: #f0f9ff;
      border-radius: 4px;
      font-size: 14px;
      margin-left: 10px;
    }
    .sync-status.synced { color: #52c41a; }
    .sync-status.syncing { color: #1890ff; animation: pulse 1s infinite; }
    .sync-status.error { color: #ff4d4f; }
    @keyframes pulse { 50% { opacity: 0.5; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆäº‘ç«¯åŒæ­¥ç‰ˆï¼‰
      <span id="syncStatus" class="sync-status synced">âœ“ å·²åŒæ­¥</span>
    </h1>

    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="nav-tabs">
      <button id="tab-calendar" class="active" onclick="switchTab('calendar')">æ—¥å†</button>
      <button id="tab-stats" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
      <button id="tab-settings" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
    </div>

    <!-- æ—¥å†é¢æ¿ -->
    <div id="panel-calendar" class="panel active">
      <div class="month-picker">
        <label>é€‰æ‹©æœˆä»½ï¼š</label>
        <input type="month" id="monthInput" />
        <button onclick="renderCalendar()">ç¡®å®š</button>
        <button class="btn-sync" onclick="forceSync()">ğŸ”„ ç«‹å³åŒæ­¥</button>
      </div>

      <div class="import-export">
        <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½ï¼ˆJSONï¼‰</button>
        <button onclick="document.getElementById('importFileInput').click()">ğŸ“¥ æ‰‹åŠ¨å¯¼å…¥</button>
        <input type="file" id="importFileInput" accept=".json" onchange="importData(event)" />
        <p style="font-size:12px;color:#666;margin-top:6px;">
          â˜ï¸ æ•°æ®è‡ªåŠ¨äº‘ç«¯åŒæ­¥ | âœ“ ç¦»çº¿å¯ç”¨ | ID: <span id="userIdDisplay"></span>
        </p>
      </div>

      <div class="view-toggle">
        <button id="btn-week" class="active" onclick="switchView('week')">æ ‡å‡†å‘¨å†ï¼ˆ7å¤©/å‘¨ï¼‰</button>
        <button id="btn-cycle" onclick="switchView('cycle')">6å¤©å¾ªç¯å†</button>
      </div>

      <div class="controls">
        <p id="multiSelectHint">â€¢ é•¿æŒ‰ä»»æ„æ—¥æœŸè¿›å…¥å¤šé€‰æ¨¡å¼ â†’ ç‚¹å‡»åˆ‡æ¢é€‰ä¸­ï½œ<strong>å³é”®</strong> å•ä¸ªæ—¥æœŸ â†’ åˆ é™¤</p>
        <div id="selectionModeIndicator" class="selection-mode-indicator" style="display: none;">å¤šé€‰æ¨¡å¼ï¼ˆç‚¹å‡»æ—¥æœŸåˆ‡æ¢é€‰ä¸­ï¼‰</div>
        <button class="btn-big" onclick="applyShiftToSelected('big')">è®¾ä¸ºå¤§å¤œç­</button>
        <button class="btn-small" onclick="applyShiftToSelected('small')">è®¾ä¸ºå°å¤œç­</button>
        <button class="btn-delete" onclick="deleteSelected()">åˆ é™¤æ‰€é€‰</button>
        <button class="btn-extra" onclick="openExtraModal()">é¢å¤–è°ƒæ•´</button>
        <button class="btn-clear" onclick="clearSelected()">å–æ¶ˆå¤šé€‰</button>
      </div>

      <div class="calendar" id="calendar"></div>

      <div class="shift-info" id="shiftInfo"></div>

      <div class="week-summary">
        <h3>ğŸ“… è¿ç»­7å¤©å·¥æ—¶ç»Ÿè®¡ï¼ˆä»…å«å½“æœˆæ—¥æœŸçš„è½®æ¬¡ï¼‰</h3>
        <div class="week-list" id="weekList"></div>
      </div>
    </div>

    <!-- ç»Ÿè®¡åˆ†æé¢æ¿ -->
    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š é«˜çº§ç»Ÿè®¡åˆ†æ</h2>

      <div class="stats-controls">
        <div>
          <label>å¼€å§‹æ—¥æœŸ</label>
          <input type="date" id="statStartDate" />
        </div>
        <div>
          <label>ç»“æŸæ—¥æœŸ</label>
          <input type="date" id="statEndDate" />
        </div>
        <div>
          <button class="btn-settings" onclick="renderStatsWithRange()">ğŸ” åˆ†æ</button>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>

      <div id="chartContainer">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="panel-settings" class="panel">
      <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
      <p>ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ï¼Œæ‰€æœ‰è®¾å¤‡åŒæ­¥ç”Ÿæ•ˆã€‚</p>
      <div class="settings-grid">
        <div class="setting-item">
          <label>å¤§å¤œç­ä¸»æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label>
          <input type="number" step="0.1" id="settingBigMain" />
        </div>
        <div class="setting-item">
          <label>å¤§å¤œç­æ¬¡æ—¥æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label>
          <input type="number" step="0.1" id="settingBigNext" />
        </div>
        <div class="setting-item">
          <label>å°å¤œç­å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</label>
          <input type="number" step="0.1" id="settingSmall" />
        </div>
        <div class="setting-item">
          <label>åˆè§„é˜ˆå€¼ï¼ˆ7å¤©æœ€å¤§å·¥æ—¶ï¼‰</label>
          <input type="number" step="0.1" id="settingLimit" />
        </div>
        <div class="setting-item">
          <label>é»˜è®¤è§†å›¾</label>
          <select id="settingDefaultView">
            <option value="week">æ ‡å‡†å‘¨å†</option>
            <option value="cycle">6å¤©å¾ªç¯å†</option>
          </select>
        </div>
        <!-- ç”¨æˆ·IDè®¾ç½® -->
        <div class="setting-item">
          <label>åŒæ­¥ç”¨æˆ·IDï¼ˆå¤šè®¾å¤‡è¯·ä¿æŒä¸€è‡´ï¼‰</label>
          <input type="text" id="settingUserId" placeholder="è¾“å…¥å­—æ¯æ•°å­—ç»„åˆ" />
          <small style="color:#666;">ç”¨äºåŒºåˆ†ä¸åŒç”¨æˆ·æ•°æ®</small>
        </div>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn-settings" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        <button class="btn-clear" onclick="resetSettings()" style="margin-left:10px;">ğŸ”„ æ¢å¤é»˜è®¤</button>
      </div>
    </div>
  </div>

  <!-- é¢å¤–å¼¹çª— & å³é”®èœå• -->
  <div id="extraModal" class="modal">
    <div class="modal-content">
      <h3>é¢å¤–è°ƒæ•´å·¥æ—¶</h3>
      <p>å¯¹æ‰€é€‰æ—¥æœŸï¼Œåœ¨åŸæœ‰åŸºç¡€ä¸Šå¢åŠ æˆ–å‡å°‘å·¥æ—¶</p>
      <div class="unit-selector">
        <label><input type="radio" name="unit" value="hour" checked /> å°æ—¶ï¼ˆå¦‚ 1.5ï¼‰</label>
        <label><input type="radio" name="unit" value="minute" /> åˆ†é’Ÿï¼ˆå¦‚ -30ï¼‰</label>
      </div>
      <input type="number" id="extraInput" placeholder="è¾“å…¥æ•°å€¼ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰" step="any" />
      <div class="modal-buttons">
        <button onclick="applyExtra()">ç¡®å®š</button>
        <button onclick="closeExtraModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div id="contextMenu" style="
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    z-index: 2000;
    display: none;
      min-width: 120px;
  ">
    <div onclick="deleteSingleShift()" style="padding:8px 12px;cursor:pointer;">åˆ é™¤ç­æ¬¡</div>
  </div>

  <script>
    // ============ Supabase é…ç½®ï¼ˆå·²å¡«å†™æ‚¨çš„ä¿¡æ¯ï¼‰===========
    const SUPABASE_URL = 'https://morkovixfwdsaknmwavj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcmtvdml4Zndkc2Frbm13YXZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MzM1NDIsImV4cCI6MjA3OTMwOTU0Mn0.wh-UEaQyr3bpJBQkCrzJpRR5v4NvRpx3LsnsAo-DGqE';

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ');
    } catch (e) {
      console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', e);
      alert('âš ï¸ äº‘ç«¯åŒæ­¥é…ç½®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }

    // ============ æ•°æ®å­˜å‚¨ ============
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        alert(`ğŸ†” å·²ç”Ÿæˆæœ¬æœºç”¨æˆ·ID: ${userId}\n\nå¤šè®¾å¤‡åŒæ­¥ï¼šåœ¨å…¶ä»–è®¾å¤‡è®¾ç½®ä¸­å¡«å…¥ç›¸åŒID`);
      }
      return userId;
    }

    let shifts = {};
    let settings = {};
    let selectedMonth = '';
    let currentView = 'week';
    let multiSelectedDates = new Set();
    let rightClickedDate = '';
    let weekSummaries = [];
    let chartInstance = null;
    let isMultiSelectMode = false;

    // æ˜¾ç¤ºç”¨æˆ·ID
    document.getElementById('userIdDisplay').textContent = getUserId().substring(0, 8);

    async function saveToStorage(options = { sync: true }) {
      const userId = getUserId();
      
      // ä¿å­˜åˆ°æœ¬åœ°ï¼ˆç¼“å­˜ï¼‰
      localStorage.setItem('shifts_local', JSON.stringify(shifts));
      localStorage.setItem('selectedMonth_local', selectedMonth);
      localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
      localStorage.setItem('userId', userId);

      // åŒæ­¥åˆ°äº‘ç«¯
      if (supabase && options.sync) {
        updateSyncStatus('syncing', 'â³ åŒæ­¥ä¸­...');
        
        try {
          // æ‰¹é‡ä¿å­˜ç­æ¬¡
          const shiftPromises = Object.entries(shifts).map(async ([date, data]) => {
            const { data: existing } = await supabase
              .from('shifts')
              .select('id')
              .eq('user_id', userId)
              .eq('date', date)
              .single();

            if (existing) {
              return supabase
                .from('shifts')
                .update({ data, updated_at: new Date().toISOString() })
                .eq('user_id', userId)
                .eq('date', date);
            } else {
              return supabase
                .from('shifts')
                .insert({ user_id: userId, date, data });
            }
          });

          // ä¿å­˜è®¾ç½®
          const settingsPromise = supabase
            .from('settings')
            .upsert({ 
              user_id: userId, 
              data: settings,
              updated_at: new Date().toISOString()
            });

          await Promise.all([...shiftPromises, settingsPromise]);
          
          updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
          console.log('â˜ï¸ äº‘ç«¯åŒæ­¥æˆåŠŸ');
        } catch (error) {
          console.error('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥:', error);
          updateSyncStatus('error', 'âœ— åŒæ­¥å¤±è´¥');
        }
      }
    }

    // ä»äº‘ç«¯åŠ è½½
    async function loadFromCloud() {
      if (!supabase) {
        console.warn('âš ï¸ Supabase æœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
        loadFromLocal();
        return;
      }

      const userId = getUserId();
      updateSyncStatus('syncing', 'â³ åŠ è½½äº‘ç«¯æ•°æ®...');

      try {
        // åŠ è½½ç­æ¬¡
        const { data: shiftsData, error: shiftsError } = await supabase
          .from('shifts')
          .select('date, data')
          .eq('user_id', userId);

        if (shiftsError) throw shiftsError;

        // åŠ è½½è®¾ç½®
        const { data: settingsData, error: settingsError } = await supabase
          .from('settings')
          .select('data')
          .eq('user_id', userId)
          .single();

        if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;

        // åˆå¹¶æ•°æ®
        if (shiftsData) {
          shifts = {};
          shiftsData.forEach(row => {
            shifts[row.date] = row.data;
          });
          localStorage.setItem('shifts_local', JSON.stringify(shifts));
        }

        if (settingsData?.data) {
          settings = { ...defaultSettings, ...settingsData.data };
          localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
        }

        updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
        console.log('â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ');
      } catch (error) {
        console.error('âŒ äº‘ç«¯åŠ è½½å¤±è´¥:', error);
        updateSyncStatus('error', 'âœ— åŠ è½½å¤±è´¥');
        loadFromLocal();
      }
    }

    function loadFromLocal() {
      shifts = JSON.parse(localStorage.getItem('shifts_local') || '{}');
      selectedMonth = localStorage.getItem('selectedMonth_local') || new Date().toISOString().slice(0, 7);
      settings = JSON.parse(localStorage.getItem('shifts_settings_local') || JSON.stringify(defaultSettings));
    }

    function updateSyncStatus(type, message) {
      const statusEl = document.getElementById('syncStatus');
      statusEl.className = 'sync-status ' + type;
      statusEl.textContent = message;
      
      if (type !== 'synced') {
        setTimeout(() => {
          statusEl.className = 'sync-status synced';
          statusEl.textContent = 'âœ“ å·²åŒæ­¥';
        }, 3000);
      }
    }

    async function forceSync() {
      await loadFromCloud();
      renderCalendar();
      if (document.getElementById('panel-stats').classList.contains('active')) {
        renderStatsWithRange();
      }
    }

    const defaultSettings = {
      bigMain: 7.4,
      bigNext: 3,
      small: 9.3,
      limit: 40,
      defaultView: 'week'
    };

    // ========== æ ‡ç­¾åˆ‡æ¢ ==========
    function switchTab(tab) {
      ['calendar', 'stats', 'settings'].forEach(t => {
        document.getElementById(`panel-${t}`).classList.remove('active');
        document.getElementById(`tab-${t}`).classList.remove('active');
      });
      document.getElementById(`panel-${tab}`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      if (tab === 'stats') {
        initDateRangeForStats();
        renderStatsWithRange();
      } else if (tab === 'settings') {
        loadSettingsUI();
      }
    }

    function switchView(view) {
      currentView = view;
      settings.defaultView = view;
      saveToStorage({ sync: true });

      document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
      if (view === 'week') {
        document.getElementById('btn-week').classList.add('active');
      } else {
        document.getElementById('btn-cycle').classList.add('active');
      }
      renderCalendar();
    }

    // ========== è®¾ç½®ç®¡ç† ==========
    function loadSettingsUI() {
      document.getElementById('settingBigMain').value = settings.bigMain;
      document.getElementById('settingBigNext').value = settings.bigNext;
      document.getElementById('settingSmall').value = settings.small;
      document.getElementById('settingLimit').value = settings.limit;
      document.getElementById('settingDefaultView').value = settings.defaultView;
      document.getElementById('settingUserId').value = getUserId();
    }

    function saveSettings() {
      const s = settings;
      s.bigMain = parseFloat(document.getElementById('settingBigMain').value) || defaultSettings.bigMain;
      s.bigNext = parseFloat(document.getElementById('settingBigNext').value) || defaultSettings.bigNext;
      s.small = parseFloat(document.getElementById('settingSmall').value) || defaultSettings.small;
      s.limit = parseFloat(document.getElementById('settingLimit').value) || defaultSettings.limit;
      s.defaultView = document.getElementById('settingDefaultView').value;
      
      const newUserId = document.getElementById('settingUserId').value.trim();
      if (newUserId && newUserId !== getUserId()) {
        localStorage.setItem('userId', newUserId);
        alert('ğŸ†” ç”¨æˆ·IDå·²æ›´æ–°ï¼è¯·åœ¨å…¶ä»–è®¾å¤‡å¡«å…¥ç›¸åŒIDä»¥å®ç°åŒæ­¥');
      }

      saveToStorage({ sync: true });
      alert('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼');
      
      if (currentView !== s.defaultView) {
        switchView(s.defaultView);
      }
    }

    function resetSettings() {
      if (confirm('ç¡®å®šæ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿ')) {
        settings = { ...defaultSettings };
        saveToStorage({ sync: true });
        loadSettingsUI();
        alert('å·²æ¢å¤é»˜è®¤è®¾ç½®');
      }
    }

    // ========== å¯¼å‡º/å¯¼å…¥ ==========
    function exportData() {
      const data = {
        version: 'cloud-sync-v4',
        shifts: shifts,
        month: selectedMonth,
        settings: settings,
        userId: getUserId(),
        exportTime: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `night-shift-backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!confirm(`ç¡®è®¤å¯¼å…¥æ•°æ®ï¼Ÿ\nç”¨æˆ·ID: ${data.userId || 'æœªæŒ‡å®š'}\nå·¥ä½œå¤©æ•°: ${Object.keys(data.shifts || {}).length}\nè¿™å°†è¦†ç›–æœ¬åœ°æ•°æ®ï¼`)) {
            return;
          }

          shifts = data.shifts || {};
          if (data.month) selectedMonth = data.month;
          if (data.settings) settings = data.settings;
          if (data.userId) localStorage.setItem('userId', data.userId);
          
          await saveToStorage({ sync: true });
          
          document.getElementById('monthInput').value = selectedMonth;
          loadSettingsUI();
          renderCalendar();
          alert('âœ… æ•°æ®å¯¼å…¥å¹¶åŒæ­¥æˆåŠŸï¼');
        } catch (err) {
          console.error(err);
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ========== æ—¥å†æ¸²æŸ“ ==========
    function renderCalendar() {
      const monthInput = document.getElementById('monthInput').value;
      if (!monthInput) return;
      selectedMonth = monthInput;
      saveToStorage({ sync: true });

      const year = parseInt(selectedMonth.split('-')[0]);
      const month = parseInt(selectedMonth.split('-')[1]) - 1;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';

      let cols = 7;
      let showHeaders = true;
      if (currentView === 'cycle') {
        cols = 6;
        showHeaders = false;
      }

      if (showHeaders) {
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => {
          const header = document.createElement('div');
          header.className = 'day-header';
          header.textContent = day;
          calendarEl.appendChild(header);
        });
      }

      if (currentView === 'week') {
        const startDayOfWeek = firstDay.getDay();
        for (let i = 0; i < startDayOfWeek; i++) {
          calendarEl.appendChild(document.createElement('div'));
        }
      }

      calendarEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${selectedMonth}-${String(day).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.dataset.date = dateStr;

        const numberSpan = document.createElement('span');
        numberSpan.className = 'day-number';
        numberSpan.textContent = day;

        const hoursSpan = document.createElement('span');
        hoursSpan.className = 'day-hours';

        const extraSpan = document.createElement('span');
        extraSpan.className = 'day-extra';

        const totalSpan = document.createElement('span');
        totalSpan.className = 'day-total';

        const baseHours = getBaseHours(dateStr);
        const extraHours = getExtraHours(dateStr);
        const totalHours = baseHours + extraHours;

        hoursSpan.textContent = baseHours > 0 ? baseHours.toFixed(1) : '';
        if (extraHours !== 0) {
          const sign = extraHours >= 0 ? '+' : '';
          extraSpan.textContent = `${sign}${Math.abs(extraHours).toFixed(2)}h`;
        } else {
          extraSpan.textContent = '';
        }
        if (extraHours !== 0) {
          totalSpan.textContent = `=${totalHours.toFixed(2)}h`;
        } else {
          totalSpan.textContent = '';
        }

        cell.appendChild(numberSpan);
        if (baseHours > 0 || extraHours !== 0) {
          cell.appendChild(hoursSpan);
          if (extraHours !== 0) {
            cell.appendChild(extraSpan);
            cell.appendChild(totalSpan);
          }
        }

        // é•¿æŒ‰å¤šé€‰
        cell.addEventListener('mousedown', (e) => {
          if (e.button === 0) {
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              toggleMultiSelect(dateStr, cell);
              isMultiSelectMode = true;
              updateMultiSelectUI();
            }
          }
        });

        let longPressTimer = null;
        cell.addEventListener('touchstart', (e) => {
          e.preventDefault();
          longPressTimer = setTimeout(() => {
            isMultiSelectMode = true;
            updateMultiSelectUI();
            toggleMultiSelect(dateStr, cell);
          }, 500);
        });

        cell.addEventListener('touchend', (e) => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        });

        cell.addEventListener('click', (e) => {
          if (isMultiSelectMode) {
            toggleMultiSelect(dateStr, cell);
          } else {
            clearMultiSelectUI();
            multiSelectedDates.clear();
          }
        });

        cell.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          rightClickedDate = dateStr;
          const menu = document.getElementById('contextMenu');
          menu.style.display = 'block';
          menu.style.left = e.pageX + 'px';
          menu.style.top = e.pageY + 'px';
        });

        updateCellClass(cell, dateStr);
        calendarEl.appendChild(cell);
      }

      document.addEventListener('click', () => {
        document.getElementById('contextMenu').style.display = 'none';
      });

      checkCompliance();
      updateShiftInfo();
      updateWeekSummary();
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function toggleMultiSelect(dateStr, cell) {
      if (multiSelectedDates.has(dateStr)) {
        multiSelectedDates.delete(dateStr);
        cell.classList.remove('multi-selected');
      } else {
        multiSelectedDates.add(dateStr);
        cell.classList.add('multi-selected');
      }
      updateMultiSelectUI();
    }

    function clearMultiSelectUI() {
      document.querySelectorAll('.day-cell.multi-selected').forEach(el => {
        el.classList.remove('multi-selected');
      });
    }

    function updateCellClass(cell, dateStr) {
      cell.classList.remove('selected-big', 'selected-small', 'custom', 'over-limit');
      const shift = shifts[dateStr];
      if (shift) {
        if (shift.type === 'big') cell.classList.add('selected-big');
        else if (shift.type === 'small') cell.classList.add('selected-small');
        else if (shift.type === 'custom') cell.classList.add('custom');
      }
    }

    function updateMultiSelectUI() {
      const indicator = document.getElementById('selectionModeIndicator');
      const hint = document.getElementById('multiSelectHint');
      if (isMultiSelectMode) {
        indicator.style.display = 'inline-block';
        hint.style.display = 'none';
      } else {
        indicator.style.display = 'none';
        hint.style.display = 'block';
      }
    }

    async function applyShiftToSelected(type) {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ');
        return;
      }

      multiSelectedDates.forEach(dateStr => {
        if (type === 'big') {
          shifts[dateStr] = { type: 'big', hours: settings.bigMain, nextDayHours: settings.bigNext };
          const next = new Date(dateStr);
          next.setDate(next.getDate() + 1);
          const nextStr = next.toISOString().split('T')[0];
          if (!shifts[nextStr] || shifts[nextStr].type !== 'auto-next') {
            shifts[nextStr] = { type: 'auto-next', hours: 0 };
          }
        } else if (type === 'small') {
          shifts[dateStr] = { type: 'small', hours: settings.small };
        }
        if (shifts[dateStr].extra !== undefined) delete shifts[dateStr].extra;
        if (shifts[dateStr].extraMeta) delete shifts[dateStr].extraMeta;
      });

      await saveToStorage({ sync: true });
      clearMultiSelectUI();
      multiSelectedDates.clear();
      isMultiSelectMode = false;
      updateMultiSelectUI();
      renderCalendar();
    }

    async function deleteSelected() {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ');
        return;
      }

      multiSelectedDates.forEach(dateStr => {
        const shift = shifts[dateStr];
        delete shifts[dateStr];

        if (shift && shift.type === 'big') {
          const next = new Date(dateStr);
          next.setDate(next.getDate() + 1);
          const nextStr = next.toISOString().split('T')[0];
          if (shifts[nextStr] && shifts[nextStr].type === 'auto-next') {
            delete shifts[nextStr];
          }
        }
      });

      await saveToStorage({ sync: true });
      clearMultiSelectUI();
      multiSelectedDates.clear();
      isMultiSelectMode = false;
      updateMultiSelectUI();
      renderCalendar();
    }

    async function deleteSingleShift() {
      if (!rightClickedDate) return;
      const shift = shifts[rightClickedDate];
      delete shifts[rightClickedDate];

      if (shift && shift.type === 'big') {
        const next = new Date(rightClickedDate);
        next.setDate(next.getDate() + 1);
        const nextStr = next.toISOString().split('T')[0];
        if (shifts[nextStr] && shifts[nextStr].type === 'auto-next') {
          delete shifts[nextStr];
        }
      }

      await saveToStorage({ sync: true });
      document.getElementById('contextMenu').style.display = 'none';
      renderCalendar();
    }

    function clearSelected() {
      clearMultiSelectUI();
      multiSelectedDates.clear();
      isMultiSelectMode = false;
      updateMultiSelectUI();
    }

    function openExtraModal() {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ');
        return;
      }
      document.getElementById('extraInput').value = '';
      document.querySelector('input[name="unit"][value="hour"]').checked = true;
      document.getElementById('extraModal').style.display = 'flex';
    }

    function closeExtraModal() {
      document.getElementById('extraModal').style.display = 'none';
    }

    async function applyExtra() {
      const inputEl = document.getElementById('extraInput');
      const valueStr = inputEl.value.trim();
      if (!valueStr) {
        closeExtraModal();
        return;
      }

      const value = parseFloat(valueStr);
      if (isNaN(value)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—');
        return;
      }

      const unitRadio = document.querySelector('input[name="unit"]:checked');
      if (!unitRadio) {
        alert('è¯·é€‰æ‹©å•ä½ï¼ˆå°æ—¶æˆ–åˆ†é’Ÿï¼‰');
        return;
      }
      const unit = unitRadio.value;

      let extraHours = 0;
      if (unit === 'hour') {
        extraHours = value;
      } else {
        extraHours = value / 60;
      }

      multiSelectedDates.forEach(dateStr => {
        if (!shifts[dateStr]) {
          shifts[dateStr] = { type: 'custom', hours: 0 };
        }
        shifts[dateStr].extra = (shifts[dateStr].extra || 0) + extraHours;
        shifts[dateStr].extraMeta = { value, unit };
        if (Math.abs(shifts[dateStr].extra) < 0.001) {
          delete shifts[dateStr].extra;
          delete shifts[dateStr].extraMeta;
        }
      });

      await saveToStorage({ sync: true });
      closeExtraModal();
      clearMultiSelectUI();
      multiSelectedDates.clear();
      isMultiSelectMode = false;
      updateMultiSelectUI();
      renderCalendar();
    }

    function getBaseHours(dateStr) {
      const shift = shifts[dateStr];
      if (!shift) return 0;
      if (shift.type === 'big') return shift.hours;
      if (shift.type === 'auto-next') {
        const prev = new Date(dateStr);
        prev.setDate(prev.getDate() - 1);
        const prevStr = prev.toISOString().split('T')[0];
        const prevShift = shifts[prevStr];
        return prevShift && prevShift.type === 'big' ? prevShift.nextDayHours : 0;
      }
      return shift.hours || 0;
    }

    function getExtraHours(dateStr) {
      const shift = shifts[dateStr];
      return shift && shift.extra ? shift.extra : 0;
    }

    function getDailyHours(dateStr) {
      return getBaseHours(dateStr) + getExtraHours(dateStr);
    }

    function calculateMonthlyTotalHours(monthKey) {
      const [yearStr, monthStr] = monthKey.split('-');
      const year = parseInt(yearStr);
      const month = parseInt(monthStr) - 1;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      let total = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        total += getDailyHours(dateStr);
      }
      return total;
    }

    function generateAllRelevant7DayWindows() {
      const [yearStr, monthStr] = selectedMonth.split('-');
      const year = parseInt(yearStr);
      const month = parseInt(monthStr) - 1;

      const firstOfMonth = new Date(year, month, 1);
      const lastOfMonth = new Date(year, month + 1, 0);

      const startDate = new Date(firstOfMonth);
      startDate.setDate(startDate.getDate() - 6);

      const windows = [];
      let current = new Date(startDate);

      while (true) {
        const windowEnd = new Date(current);
        windowEnd.setDate(current.getDate() + 6);

        if (current > lastOfMonth) break;

        if (windowEnd >= firstOfMonth && current <= lastOfMonth) {
          windows.push({
            start: new Date(current),
            end: new Date(windowEnd)
          });
        }

        current.setDate(current.getDate() + 1);
      }

      return windows;
    }

    function checkCompliance() {
      const windows = generateAllRelevant7DayWindows();
      weekSummaries = [];
      const overLimitDates = new Set();

      windows.forEach(w => {
        let total = 0;
        const datesInRange = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(w.start);
          d.setDate(d.getDate() + i);
          const iso = d.toISOString().split('T')[0];
          datesInRange.push(iso);
          total += getDailyHours(iso);
        }

        const violation = total > settings.limit;
        weekSummaries.push({
          start: w.start.toISOString().split('T')[0],
          end: w.end.toISOString().split('T')[0],
          total: total,
          dates: datesInRange,
          violation: violation
        });

        if (violation) {
          datesInRange.forEach(d => overLimitDates.add(d));
        }
      });

      document.querySelectorAll('.day-cell').forEach(cell => {
        const dateStr = cell.dataset.date;
        if (dateStr && overLimitDates.has(dateStr)) {
          cell.classList.add('over-limit');
        } else {
          cell.classList.remove('over-limit');
        }
      });
    }

    function updateShiftInfo() {
      const total = calculateMonthlyTotalHours(selectedMonth);
      const hasOverLimit = weekSummaries.some(w => w.violation);

      const infoEl = document.getElementById('shiftInfo');
      infoEl.innerHTML = `
        <p>æœ¬æœˆæ€»å·¥æ—¶ï¼š${total.toFixed(2)} å°æ—¶</p>
        <div class="result ${hasOverLimit ? 'warn' : 'ok'}">
          ${hasOverLimit ? `âš ï¸ è­¦å‘Šï¼šå­˜åœ¨è¿ç»­7å¤©å·¥æ—¶è¶…è¿‡ ${settings.limit} å°æ—¶ï¼` : `âœ… å½“å‰å®‰æ’ç¬¦åˆè§„å®šï¼ˆä»»æ„7å¤©â‰¤${settings.limit}å°æ—¶ï¼‰`}
        </div>
      `;
    }

    function updateWeekSummary() {
      const listEl = document.getElementById('weekList');
      if (weekSummaries.length === 0) {
        listEl.innerHTML = '<p>æš‚æ— 7å¤©å‘¨æœŸæ•°æ®</p>';
        return;
      }

      let html = '';
      weekSummaries.forEach(w => {
        const cls = w.violation ? 'week-item violation' : 'week-item';
        const startDisp = formatDate(w.start);
        const endDisp = formatDate(w.end);
        html += `<div class="${cls}">${startDisp} è‡³ ${endDisp}ï¼š${w.total.toFixed(2)} å°æ—¶</div>`;
      });
      listEl.innerHTML = html;
    }

    function formatDate(isoDate) {
      const d = new Date(isoDate);
      return `${d.getMonth() + 1}/${d.getDate()}`;
    }

    // ========== é«˜çº§ç»Ÿè®¡åˆ†æ ==========
    function initDateRangeForStats() {
      const today = new Date();
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(today.getFullYear() - 1);

      const formatDateInput = d => d.toISOString().split('T')[0];
      document.getElementById('statStartDate').value = formatDateInput(oneYearAgo);
      document.getElementById('statEndDate').value = formatDateInput(today);
    }

    function getMonthsBetween(start, end) {
      const months = [];
      const current = new Date(start);
      while (current <= end) {
        const key = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
        months.push(key);
        current.setMonth(current.getMonth() + 1);
      }
      return months;
    }

    function renderStatsWithRange() {
      const startInput = document.getElementById('statStartDate').value;
      const endInput = document.getElementById('statEndDate').value;

      if (!startInput || !endInput) {
        alert('è¯·é€‰æ‹©å®Œæ•´çš„èµ·æ­¢æ—¥æœŸ');
        return;
      }

      const startDate = new Date(startInput);
      const endDate = new Date(endInput);
      if (startDate > endDate) {
        alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
        return;
      }

      const allMonths = getMonthsBetween(startDate, endDate);

      let totalWorkDays = 0;
      let totalHours = 0;
      let bigCount = 0, smallCount = 0, customCount = 0;
      let workedDates = [];

      const currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const h = getDailyHours(dateStr);
        if (h > 0) {
          totalHours += h;
          totalWorkDays++;
          workedDates.push(new Date(dateStr));

          const shift = shifts[dateStr];
          if (shift) {
            if (shift.type === 'big') bigCount++;
            else if (shift.type === 'small') smallCount++;
            else if (shift.type === 'custom') customCount++;
          }
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }

      let maxConsecutive = 0;
      if (workedDates.length > 0) {
        workedDates.sort((a, b) => a - b);
        let currentStreak = 1;
        maxConsecutive = 1;
        for (let i = 1; i < workedDates.length; i++) {
          const diff = (workedDates[i] - workedDates[i - 1]) / (1000 * 60 * 60 * 24);
          if (diff === 1) {
            currentStreak++;
            maxConsecutive = Math.max(maxConsecutive, currentStreak);
          } else {
            currentStreak = 1;
          }
        }
      }

      const totalMonths = allMonths.length;
      const avgMonthlyHours = totalMonths > 0 ? (totalHours / totalMonths) : 0;
      const avgDailyHours = totalWorkDays > 0 ? (totalHours / totalWorkDays) : 0;

      const stats = [
        { label: 'ç»Ÿè®¡æ—¶é—´æ®µ', value: `${startInput} è‡³ ${endInput}` },
        { label: 'æ€»å·¥æ—¶', value: `${totalHours.toFixed(2)} å°æ—¶` },
        { label: 'å¹³å‡æ¯æœˆå·¥æ—¶', value: `${avgMonthlyHours.toFixed(2)} å°æ—¶` },
        { label: 'å·¥ä½œå¤©æ•°', value: `${totalWorkDays} å¤©` },
        { label: 'å¹³å‡æ¯æ—¥å·¥æ—¶', value: `${avgDailyHours.toFixed(2)} å°æ—¶` },
        { label: 'å¤§å¤œç­æ¬¡æ•°', value: `${bigCount} æ¬¡` },
        { label: 'å°å¤œç­æ¬¡æ•°', value: `${smallCount} æ¬¡` },
        { label: 'è‡ªå®šä¹‰ç­æ¬¡', value: `${customCount} æ¬¡` },
        { label: 'æœ€é•¿è¿ç»­å·¥ä½œ', value: `${maxConsecutive} å¤©` },
        { label: 'è¦†ç›–æœˆä»½æ•°', value: `${totalMonths} ä¸ªæœˆ` }
      ];

      const grid = document.getElementById('statsGrid');
      grid.innerHTML = '';
      stats.forEach(item => {
        const div = document.createElement('div');
        div.className = 'stat-item';
        div.innerHTML = `<div>${item.label}</div><div class="stat-value">${item.value}</div>`;
        grid.appendChild(div);
      });

      renderMonthlyChart(allMonths);
    }

    function renderMonthlyChart(monthKeys) {
      const labels = [];
      const data = [];

      monthKeys.forEach(m => {
        const total = calculateMonthlyTotalHours(m);
        const [y, mNum] = m.split('-');
        labels.push(`${y}-${mNum}`);
        data.push(parseFloat(total.toFixed(2)));
      });

      const ctx = document.getElementById('monthlyChart').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ¯æœˆæ€»å·¥æ—¶ï¼ˆå°æ—¶ï¼‰',
            data: data,
            backgroundColor: 'rgba(24, 144, 255, 0.6)',
            borderColor: 'rgba(24, 144, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'å·¥æ—¶ï¼ˆå°æ—¶ï¼‰' }
            },
            x: {
              title: { display: true, text: 'æœˆä»½' }
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `å·¥æ—¶: ${context.parsed.y} å°æ—¶`;
                }
              }
            }
          }
        }
      });
    }

    // ========== åˆå§‹åŒ– ==========
    window.onload = async () => {
      await loadFromCloud();
      
      document.getElementById('monthInput').value = selectedMonth;
      loadSettingsUI();
      renderCalendar();
      
      // å¯ç”¨å®æ—¶è®¢é˜…
      if (supabase) {
        const userId = getUserId();
        
        supabase
          .channel('shifts-channel')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts', filter: `user_id=eq.${userId}` }, async (payload) => {
            console.log('â˜ï¸ æ”¶åˆ°äº‘ç«¯æ•°æ®æ›´æ–°');
            await loadFromCloud();
            renderCalendar();
          })
          .on('postgres_changes', { event: '*', schema: 'public', table: 'settings', filter: `user_id=eq.${userId}` }, async (payload) => {
            console.log('â˜ï¸ æ”¶åˆ°è®¾ç½®æ›´æ–°');
            await loadFromCloud();
            loadSettingsUI();
          })
          .subscribe();
      }
    };

    window.onclick = (e) => {
      if (e.target.id === 'extraModal') closeExtraModal();
    };

    // é¡µé¢æ¿€æ´»æ—¶è‡ªåŠ¨åŒæ­¥
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && supabase) {
        console.log('é¡µé¢æ¿€æ´»ï¼Œè‡ªåŠ¨åŒæ­¥...');
        forceSync();
      }
    });
  </script>
</body>
</html>
