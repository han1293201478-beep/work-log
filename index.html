<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆAI å¯¹è¯å¢å¼ºç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; padding: 20px; background-color: #f9f9f9; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2, h3 { color: #333; }
    h1 { text-align: center; }
    .nav-tabs button { margin: 0 6px; padding: 6px 12px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; border-radius: 4px; }
    .nav-tabs button.active { background: #1890ff; color: white; border-color: #1890ff; }
    .calendar { display: grid; gap: 4px; margin-top: 10px; }
    .day-header { text-align: center; font-weight: bold; padding: 6px; background: #eee; border-radius: 4px; font-size: 14px; }
    .day-cell { height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: #fff; font-size: 14px; user-select: none; position: relative; padding: 4px; text-align: center; }
    .day-number { font-weight: bold; }
    .day-hours { font-size: 12px; color: #666; margin-top: 2px; }
    .day-extra { font-size: 11px; color: #999; }
    .day-total { font-size: 11px; color: #d46b08; font-weight: bold; margin-top: 2px; }
    .day-cell:hover { background: #e6f7ff; }
    .day-cell.selected-big { background: #ffe58f; border-color: #faad14; }
    .day-cell.selected-small { background: #b7eb8f; border-color: #52c41a; }
    .day-cell.custom { background: #ffd6e7; border-color: #eb2f96; }
    .day-cell.over-limit { box-shadow: 0 0 0 3px red; }
    .day-cell.multi-selected { outline: 2px solid blue; z-index: 2; }
    .controls button { margin: 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-big { background: #faad14; color: white; }
    .btn-small { background: #52c41a; color: white; }
    .btn-clear { background: #d9d9d9; color: black; }
    .btn-delete { background: #ff4d4f; color: white; }
    .btn-extra { background: #722ed1; color: white; }
    .btn-settings { background: #13c2c2; color: white; }
    .btn-sync { background: #52c41a; color: white; }
    .shift-info { margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 6px; }
    .result { margin-top: 10px; padding: 8px; border-radius: 4px; font-weight: bold; }
    .ok { background: #f6ffed; color: #52c41a; }
    .warn { background: #fff2f0; color: #ff4d4f; }
    .week-summary { margin-top: 20px; }
    .week-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
    .week-item { padding: 6px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    .week-item.violation { background: #fff2f0; color: #ff4d4f; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 320px; text-align: left; }
    .modal h3 { text-align: center; margin-top: 0; }
    .modal input, .modal select { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .modal-buttons { text-align: center; margin-top: 15px; }
    .modal-buttons button { margin: 0 8px; }
    #importFileInput { display: none; }
    .panel { display: none; }
    .panel.active { display: block; }
    .settings-grid, .stats-controls, .stats-grid { display: grid; gap: 15px; margin-top: 15px; }
    .settings-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .setting-item, .stat-item { padding: 12px; background: #fafafa; border-radius: 6px; border: 1px solid #eee; }
    .setting-item label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 14px; }
    .setting-item input, .setting-item select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    .stat-value { font-size: 20px; font-weight: bold; color: #1890ff; margin-top: 6px; }
    .stats-controls, .chat-controls { display: grid; gap: 15px; margin-top: 15px; grid-template-columns: 1fr 1fr auto; align-items: end; }
    .stats-controls > div, .chat-controls > div { display: flex; flex-direction: column; }
    .stats-controls label, .chat-controls label { font-size: 14px; margin-bottom: 4px; }
    .stats-controls input[type="date"], .chat-controls input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    .stats-controls button, .chat-controls button { height: 34px; margin-top: 22px; }
    #chartContainer { margin-top: 20px; position: relative; height: 300px; }
    .selection-mode-indicator { background: #1890ff; color: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; display: inline-block; }
    .sync-status { display: inline-flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 4px; font-size: 14px; margin-left: 10px; transition: all 0.3s ease; }
    .sync-status.synced { background: #f6ffed; color: #52c41a; }
    .sync-status.syncing { background: #e6f7ff; color: #1890ff; animation: pulse 1.5s infinite; }
    .sync-status.error { background: #fff2f0; color: #ff4d4f; }
    .sync-status.warning { background: #fff7e6; color: #d46b08; }
    @keyframes pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
    
    /* ç»Ÿä¸€ AI Chat æ ·å¼ */
    #chatContainer { display: flex; flex-direction: column; height: 600px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-top: 15px; }
    
    .ai-chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f7f7f7;
        border: 1px solid #ddd;
        border-radius: 8px 8px 0 0;
        min-height: 200px; /* æœ€å°é«˜åº¦ */
        max-height: 400px; /* æœ€å¤§é«˜åº¦ */
        margin-top: 10px;
        display: none; /* é»˜è®¤éšè—ï¼Œå¯åŠ¨å¯¹è¯æ—¶æ˜¾ç¤º */
    }
    
    #chatHistory { /* ä¸» Chat é¢æ¿çš„å†å²è®°å½• */
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 15px; 
        background-color: #f7f7f7;
    }
    
    .chat-message { padding: 10px 15px; margin-bottom: 10px; border-radius: 18px; max-width: 90%; line-height: 1.6; }
    .chat-user { align-self: flex-end; margin-left: auto; background-color: #1890ff; color: white; border-bottom-right-radius: 2px; }
    .chat-ai { align-self: flex-start; margin-right: auto; background-color: #e6e6e6; color: #333; border-bottom-left-radius: 2px; }
    .chat-ai pre { white-space: pre-wrap; background: #fff; padding: 10px; border-radius: 4px; border: 1px dashed #ccc; font-size: 12px; margin-top: 5px; overflow-x: auto; }
    
    .ai-chat-input-container {
        padding: 10px 15px;
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        display: flex;
        gap: 10px;
    }
    .ai-chat-input-container textarea {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 12px;
        resize: none;
        max-height: 80px;
        line-height: 1.4;
    }
    .ai-chat-input-container button {
        background-color: #52c41a;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
    }
    
    #chatInputContainer { /* ä¸» Chat é¢æ¿çš„è¾“å…¥æ¡† */
        padding: 15px; background-color: white; border-top: 1px solid #ddd; display: flex; 
    }
    #chatInput { 
        flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px; resize: none; 
    }
    #chatSendBtn { 
        background-color: #52c41a; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; 
    }
    #chatSendBtn:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆAI å¯¹è¯å¢å¼ºç‰ˆï¼‰
      <span id="syncStatus" class="sync-status synced">âœ“ å·²åŒæ­¥</span>
    </h1>

    <div class="nav-tabs">
      <button id="tab-calendar" class="active" onclick="switchTab('calendar')">æ—¥å†</button>
      <button id="tab-stats" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
      <button id="tab-chat" onclick="switchTab('chat')">ğŸ’¬ AI å¯¹è¯</button>
      <button id="tab-settings" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
    </div>

    <div id="panel-calendar" class="panel active">
      <div class="month-picker">
        <label>é€‰æ‹©æœˆä»½ï¼š</label>
        <input type="month" id="monthInput" />
        <button onclick="renderCalendar()">ç¡®å®š</button>
        <button class="btn-sync" onclick="forceSync()">ğŸ”„ ç«‹å³åŒæ­¥</button>
      </div>

      <div class="import-export">
        <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½ï¼ˆJSONï¼‰</button>
        <button onclick="document.getElementById('importFileInput').click()">ğŸ“¥ æ‰‹åŠ¨å¯¼å…¥</button>
        <input type="file" id="importFileInput" accept=".json" onchange="importData(event)" />
        <p style="font-size:12px;color:#666;margin-top:6px;">
          â˜ï¸ æ•°æ®è‡ªåŠ¨äº‘ç«¯åŒæ­¥ | âœ“ ç¦»çº¿å¯ç”¨ | ID: <span id="userIdDisplay"></span>
        </p>
      </div>

      <div class="view-toggle">
        <button id="btn-week" class="active" onclick="switchView('week')">æ ‡å‡†å‘¨å†ï¼ˆ7å¤©/å‘¨ï¼‰</button>
        <button id="btn-cycle" onclick="switchView('cycle')">6å¤©å¾ªç¯å†</button>
      </div>

      <div class="controls">
        <p id="multiSelectHint">â€¢ é•¿æŒ‰ä»»æ„æ—¥æœŸè¿›å…¥å¤šé€‰æ¨¡å¼ â†’ ç‚¹å‡»åˆ‡æ¢é€‰ä¸­ï½œ<strong>å³é”®</strong> å•ä¸ªæ—¥æœŸ â†’ åˆ é™¤</p>
        <div id="selectionModeIndicator" class="selection-mode-indicator" style="display: none;">å¤šé€‰æ¨¡å¼ï¼ˆç‚¹å‡»æ—¥æœŸåˆ‡æ¢é€‰ä¸­ï¼‰</div>
        <button class="btn-big" onclick="applyShiftToSelected('big')">è®¾ä¸ºå¤§å¤œç­</button>
        <button class="btn-small" onclick="applyShiftToSelected('small')">è®¾ä¸ºå°å¤œç­</button>
        <button class="btn-delete" onclick="deleteSelected()">åˆ é™¤æ‰€é€‰</button>
        <button class="btn-extra" onclick="openExtraModal()">é¢å¤–è°ƒæ•´</button>
        <button class="btn-clear" onclick="clearSelected()">å–æ¶ˆå¤šé€‰</button>
        <button class="btn-settings" onclick="runCalendarAiAnalysis()">ğŸ§  åˆ†æå¹¶æä¾›æ¢ç­å»ºè®® (å¯åŠ¨å¯¹è¯)</button> 
      </div>

      <div class="calendar" id="calendar"></div>
      <div class="shift-info" id="shiftInfo"></div>
      
      <div id="calendarAiChatContainer" style="margin-top: 15px;">
        <h3 id="calendarAiTitle">ğŸ”„ æ’ç­åˆè§„æ€§åˆ†æä¸è®¨è®º</h3>
        <div id="complianceAdviceStatus" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">ç‚¹å‡»ä¸Šæ–¹ "åˆ†æå¹¶æä¾›æ¢ç­å»ºè®®" æŒ‰é’®å¯åŠ¨å¯¹è¯ã€‚</div>
        <div id="calendarChatHistory" class="ai-chat-history"></div>
        <div id="calendarChatInputContainer" class="ai-chat-input-container" style="display:none;">
            <textarea id="calendarChatInput" placeholder="åŸºäºä»¥ä¸Šåˆ†æç»§ç»­æé—®ï¼ˆä¾‹å¦‚ï¼šå°†10å·çš„ç­æŒªåˆ°12å·æ˜¯å¦åˆè§„ï¼Ÿï¼‰" rows="1" onkeydown="handlePanelChatInput(event, 'calendar')"></textarea>
            <button onclick="sendPanelChatMessage('calendar')">å‘é€</button>
        </div>
      </div>

      <div class="week-summary">
        <h3>ğŸ“… è¿ç»­7å¤©å·¥æ—¶ç»Ÿè®¡ï¼ˆä»…å«å½“æœˆæ—¥æœŸçš„è½®æ¬¡ï¼‰</h3>
        <div class="week-list" id="weekList"></div>
      </div>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š é«˜çº§ç»Ÿè®¡åˆ†æ</h2>
      <div class="stats-controls">
        <div><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="statStartDate" /></div>
        <div><div><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="statEndDate" /></div></div>
        <div><button class="btn-settings" onclick="renderStatsWithRange()">ğŸ” åˆ†æ</button></div>
      </div>
      <div class="stats-grid" id="statsGrid"></div>
      <div id="chartContainer"><canvas id="monthlyChart"></canvas></div>

      <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;">
          <div id="statsAiChatContainer">
            <h3 id="statsAiTitle">ğŸ“ˆ AI æ™ºèƒ½æ€»ç»“ä¸è®¨è®º</h3>
            <button class="btn-settings" onclick="runAiAnalysis()">ğŸ§  å¯åŠ¨ AI æ€»ç»“ (å¯åŠ¨å¯¹è¯)</button>
            <div id="aiSummaryResultStatus" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;">è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»â€œåˆ†æâ€ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯åŠ¨å¯¹è¯ã€‚</div>
            <div id="statsChatHistory" class="ai-chat-history"></div>
            <div id="statsChatInputContainer" class="ai-chat-input-container" style="display:none;">
                <textarea id="statsChatInput" placeholder="åŸºäºä»¥ä¸Šæ€»ç»“ç»§ç»­æé—®ï¼ˆä¾‹å¦‚ï¼šæˆ‘åº”è¯¥å¦‚ä½•åœ¨ä¼‘æ¯æ—¥æ›´å¥½åœ°æ¢å¤ç²¾åŠ›ï¼Ÿï¼‰" rows="1" onkeydown="handlePanelChatInput(event, 'stats')"></textarea>
                <button onclick="sendPanelChatMessage('stats')">å‘é€</button>
            </div>
          </div>
      </div>
    </div>

    <div id="panel-chat" class="panel">
        <h2>ğŸ’¬ AI ç§äººå¥åº·åŠ©æ‰‹</h2>
        <p style="color: #666;">
            æ‚¨å¯ä»¥åœ¨æ­¤ä¸ AI ç§äººå¥åº·åŠ©æ‰‹è¿›è¡Œå¯¹è¯ï¼Œè·å–å…³äºå¤œç­ä¸‹çš„å¥åº·ã€æƒ…ç»ªå’Œç”Ÿæ´»è´¨é‡çš„å»ºè®®ã€‚
            <span id="chatConfigStatus" style="font-weight: bold;"></span>
        </p>
        
        <div class="chat-controls">
            <div><label>åˆ†æå¼€å§‹æ—¥æœŸ</label><input type="date" id="chatStartDate" /></div>
            <div><div><label>åˆ†æç»“æŸæ—¥æœŸ</label><input type="date" id="chatEndDate" /></div></div>
            <div>
                <button class="btn-settings" onclick="AIAssistant.analyzeShiftData()">ğŸ“ˆ è·å–å¹¶åˆ†ææ’ç­å¯¹å¥åº·çš„å½±å“</button>
            </div>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn-clear" onclick="resetChatHistory()">ğŸ”„ é‡ç½®å¯¹è¯</button>
        </div>

        <div id="chatContainer">
            <div id="chatHistory"></div>
            <div id="chatInputContainer">
                <textarea id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" onkeydown="handleChatInput(event)"></textarea>
                <button id="chatSendBtn" onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="panel-settings" class="panel">
      <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
      <p>ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ï¼Œæ‰€æœ‰è®¾å¤‡åŒæ­¥ç”Ÿæ•ˆã€‚</p>
      <div class="settings-grid">
        <div class="setting-item"><label>å¤§å¤œç­ä¸»æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingBigMain" /></div>
        <div class="setting-item"><label>å¤§å¤œç­æ¬¡æ—¥æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingBigNext" /></div>
        <div class="setting-item"><label>å°å¤œç­å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingSmall" /></div>
        <div class="setting-item"><label>åˆè§„é˜ˆå€¼ï¼ˆ7å¤©æœ€å¤§å·¥æ—¶ï¼‰</label><input type="number" step="0.1" id="settingLimit" /></div>
        <div class="setting-item"><label>é»˜è®¤è§†å›¾</label><select id="settingDefaultView"><option value="week">æ ‡å‡†å‘¨å†</option><option value="cycle">6å¤©å¾ªç¯å†</option></select></div>
        <div class="setting-item"><label>åŒæ­¥ç”¨æˆ·IDï¼ˆå¤šè®¾å¤‡è¯·ä¿æŒä¸€è‡´ï¼‰</label><input type="text" id="settingUserId" placeholder="è¾“å…¥å­—æ¯æ•°å­—ç»„åˆ" /><small style="color:#666;">ç”¨äºåŒºåˆ†ä¸åŒç”¨æˆ·æ•°æ®</small></div>
        
        <div class="setting-item"><label>AI æœåŠ¡ç»ˆç«¯ç‚¹ (Endpoint URL)</label><input type="text" id="settingAiEndpoint" placeholder="å¦‚: https://api.openai.com/v1/chat/completions" /></div>
        <div class="setting-item"><label>AI API å¯†é’¥ (Key)</label><input type="password" id="settingAiApiKey" placeholder="è¾“å…¥æ‚¨çš„å¯†é’¥" /><small style="color:#666;">å¯†é’¥ä»…ä¿å­˜åœ¨æœ¬åœ°/äº‘ç«¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</small></div>
        <div class="setting-item"><label>AI æ¨¡å‹åç§°</label><input type="text" id="settingAiModel" placeholder="å¦‚: gpt-3.5-turbo" /><small style="color:#666;">ç”¨äºå¯¹è¯çš„æ¨¡å‹åç§°</small></div>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button class="btn-settings" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        <button class="btn-clear" onclick="resetSettings()" style="margin-left:10px;">ğŸ”„ æ¢å¤é»˜è®¤</button>
      </div>
    </div>
  </div>

  <div id="extraModal" class="modal"><div class="modal-content"><h3>é¢å¤–è°ƒæ•´å·¥æ—¶</h3><p>å¯¹æ‰€é€‰æ—¥æœŸï¼Œåœ¨åŸæœ‰åŸºç¡€ä¸Šå¢åŠ æˆ–å‡å°‘å·¥æ—¶</p><div class="unit-selector"><label><input type="radio" name="unit" value="hour" checked /> å°æ—¶ï¼ˆå¦‚ 1.5ï¼‰</label><label><input type="radio" name="unit" value="minute" /> åˆ†é’Ÿï¼ˆå¦‚ -30ï¼‰</label></div><input type="number" id="extraInput" placeholder="è¾“å…¥æ•°å€¼ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰" step="any" /><div class="modal-buttons"><button onclick="applyExtra()">ç¡®å®š</button><button onclick="closeExtraModal()">å–æ¶ˆ</button></div></div></div>
  <div id="contextMenu" style="position:absolute;background:white;border:1px solid #ccc;border-radius:4px;box-shadow:2px 2px 6px rgba(0,0,0,0.2);z-index:2000;display:none;min-width:120px;"><div onclick="deleteSingleShift()" style="padding:8px 12px;cursor:pointer;">åˆ é™¤ç­æ¬¡</div></div>

  <script>
    // ============ Supabase é…ç½® ============
    const SUPABASE_URL = 'https://morkovixfwdsaknmwavj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcmtvdml4Zndkc2Frbm13YXZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MzM1NDIsImV4cCI6MjA3OTMwOTU0Mn0.wh-UEaQyr3bpJBQkCrzJpRR5v4NvRpx3LsnsAo-DGqE';

    // ============ æ ¸å¿ƒæ”¹è¿›ï¼šåŒæ­¥ç®¡ç†å™¨ ============
    class SyncManager {
      constructor() {
        this.isSyncing = false;
        this.lastSyncTime = 0;
        this.minSyncInterval = 5000;
        this.pendingSync = false;
      }
      async sync(saveToStorageFn, options = { sync: true }) {
        if (this.isSyncing) {
          this.pendingSync = true;
          return;
        }
        const now = Date.now();
        if (now - this.lastSyncTime < this.minSyncInterval) {
          if (!this.pendingSync) {
            this.pendingSync = true;
            setTimeout(() => {
              this.pendingSync = false;
              this.sync(saveToStorageFn, options);
            }, this.minSyncInterval - (now - self.lastSyncTime));
          }
          return;
        }
        this.isSyncing = true;
        this.lastSyncTime = now;
        try {
          await saveToStorageFn(options);
        } finally {
          this.isSyncing = false;
          if (this.pendingSync) {
            this.pendingSync = false;
            setTimeout(() => this.sync(saveToStorageFn, options), 100);
          }
        }
      }
    }

    const syncManager = new SyncManager();
    // ============ æ•°æ®å­˜å‚¨ ============
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
    }

    let shifts = {};
    let settings = {};
    let selectedMonth = '';
    let currentView = 'week';
    let multiSelectedDates = new Set();
    let rightClickedDate = '';
    let weekSummaries = [];
    let chartInstance = null;
    let isMultiSelectMode = false;
    let currentStatsSummary = {}; 

    document.getElementById('userIdDisplay').textContent = getUserId().substring(0, 8);
    // æ ¸å¿ƒä¿å­˜å‡½æ•°
    async function saveToStorage(options = { sync: true }) {
      const userId = getUserId();
      localStorage.setItem('shifts_local', JSON.stringify(shifts));
      localStorage.setItem('selectedMonth_local', selectedMonth);
      localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
      localStorage.setItem('userId', userId);
      if (supabase && options.sync) {
        updateSyncStatus('syncing', 'â³ åŒæ­¥ä¸­...');
        try {
          const shiftPromises = Object.entries(shifts).map(async ([date, data]) => {
            const { data: existing, error: checkError } = await supabase.from('shifts').select('id').eq('user_id', userId).eq('date', date).single();
            if (checkError && checkError.code !== 'PGRST116') throw checkError;
            if (existing) {
              return supabase.from('shifts').update({ data, updated_at: new Date().toISOString() }).eq('user_id', userId).eq('date', date);
            } else {
              return supabase.from('shifts').insert({ user_id: userId, date, data });
            }
          });
          const settingsPromise = supabase.from('settings').upsert({ user_id: userId, data: settings, updated_at: new Date().toISOString() });
          await Promise.all([...shiftPromises, settingsPromise]);
          updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
        } catch (error) {
          console.error('äº‘ç«¯åŒæ­¥å¤±è´¥:', error);
          updateSyncStatus('error', 'âœ— åŒæ­¥å¤±è´¥');
        }
      }
    }

    function saveToStorageSafe(options = { sync: true }) {
      return syncManager.sync(saveToStorage, options);
    }

    async function loadFromCloud() {
      if (!supabase) { loadFromLocal(); return; }
      const userId = getUserId();
      updateSyncStatus('syncing', 'â³ åŠ è½½äº‘ç«¯æ•°æ®...');
      try {
        const { data: shiftsData, error: shiftsError } = await supabase.from('shifts').select('date, data').eq('user_id', userId);
        if (shiftsError) throw shiftsError;
        const { data: settingsData, error: settingsError } = await supabase.from('settings').select('data').eq('user_id', userId).single();
        if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;
        if (shiftsData) {
          shifts = {};
          shiftsData.forEach(row => { shifts[row.date] = row.data; });
          localStorage.setItem('shifts_local', JSON.stringify(shifts));
        }
        if (settingsData?.data) {
          settings = { ...defaultSettings, ...settingsData.data };
          localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
        }
        updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
      } catch (error) {
        console.error('äº‘ç«¯åŠ è½½å¤±è´¥:', error);
        updateSyncStatus('error', 'âœ— åŠ è½½å¤±è´¥');
        loadFromLocal();
      }
    }

    function loadFromLocal() {
      shifts = JSON.parse(localStorage.getItem('shifts_local') || '{}');
      selectedMonth = localStorage.getItem('selectedMonth_local') || new Date().toISOString().slice(0, 7);
      settings = { ...defaultSettings, ...JSON.parse(localStorage.getItem('shifts_settings_local') || '{}') };
    }

    function updateSyncStatus(type, message) {
      const statusEl = document.getElementById('syncStatus');
      statusEl.className = 'sync-status ' + type;
      statusEl.textContent = message;
    }

    async function forceSync() {
      await loadFromCloud();
      renderCalendar();
      if (document.getElementById('panel-stats').classList.contains('active')) {
        initDateRangeForStats(true); // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–å’Œæ¸²æŸ“ç»Ÿè®¡
      }
    }

    const defaultSettings = {
      bigMain: 7.4, bigNext: 3, small: 9.3, limit: 40, defaultView: 'week',
      aiEndpoint: 'https://api.openai.com/v1/chat/completions', aiApiKey: '', aiModel: 'gpt-3.5-turbo'
    };

    function switchTab(tab) {
      ['calendar', 'stats', 'chat', 'settings'].forEach(t => {
        document.getElementById(`panel-${t}`).classList.remove('active');
        document.getElementById(`tab-${t}`).classList.remove('active');
      });
      document.getElementById(`panel-${tab}`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'stats') { initDateRangeForStats(true); } 
      else if (tab === 'chat') { initDateRangeForChat(); AIAssistant.initSystemMessage(); document.getElementById('chatInput').focus(); } 
      else if (tab === 'settings') { loadSettingsUI(); }
      AIAssistant.updateChatConfigStatus(); // Update status on tab switch
    }

    function switchView(view) {
      currentView = view;
      settings.defaultView = view;
      saveToStorageSafe({ sync: true });
      document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
      if (view === 'week') { document.getElementById('btn-week').classList.add('active'); } 
      else { document.getElementById('btn-cycle').classList.add('active'); }
      renderCalendar();
    }

    function loadSettingsUI() {
      document.getElementById('settingBigMain').value = settings.bigMain;
      document.getElementById('settingBigNext').value = settings.bigNext;
      document.getElementById('settingSmall').value = settings.small;
      document.getElementById('settingLimit').value = settings.limit;
      document.getElementById('settingDefaultView').value = settings.defaultView;
      document.getElementById('settingUserId').value = getUserId();
      document.getElementById('settingAiEndpoint').value = settings.aiEndpoint || '';
      document.getElementById('settingAiApiKey').value = settings.aiApiKey || '';
      document.getElementById('settingAiModel').value = settings.aiModel || '';
    }

    async function saveSettings() {
      const s = settings;
      s.bigMain = parseFloat(document.getElementById('settingBigMain').value) || defaultSettings.bigMain;
      s.bigNext = parseFloat(document.getElementById('settingBigNext').value) || defaultSettings.bigNext;
      s.small = parseFloat(document.getElementById('settingSmall').value) || defaultSettings.small;
      s.limit = parseFloat(document.getElementById('settingLimit').value) || defaultSettings.limit;
      s.defaultView = document.getElementById('settingDefaultView').value;
      s.aiEndpoint = document.getElementById('settingAiEndpoint').value.trim();
      s.aiApiKey = document.getElementById('settingAiApiKey').value.trim();
      s.aiModel = document.getElementById('settingAiModel').value.trim();
      
      const newUserId = document.getElementById('settingUserId').value.trim();
      if (newUserId && newUserId !== getUserId()) {
        localStorage.setItem('userId', newUserId);
        alert('ğŸ†” ç”¨æˆ·IDå·²æ›´æ–°ï¼è¯·åœ¨å…¶ä»–è®¾å¤‡å¡«å…¥ç›¸åŒIDä»¥å®ç°åŒæ­¥');
      }
      await saveToStorageSafe({ sync: true });
      alert('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼');
      AIAssistant.initSystemMessage();
      AIAssistant.updateChatConfigStatus();
      if (currentView !== s.defaultView) { switchView(s.defaultView); }
      renderCalendar();
    }

    function resetSettings() {
      if (confirm('ç¡®å®šæ¢å¤é»˜è®¤è®¾ç½®ï¼Ÿ')) {
        settings = { ...defaultSettings };
        saveToStorageSafe({ sync: true });
        loadSettingsUI();
        AIAssistant.initSystemMessage();
        AIAssistant.updateChatConfigStatus();
        renderCalendar();
        alert('å·²æ¢å¤é»˜è®¤è®¾ç½®');
      }
    }

    function exportData() {
      const data = { version: 'cloud-sync-v4', shifts: shifts, month: selectedMonth, settings: settings, userId: getUserId(), exportTime: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `night-shift-backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.version !== 'cloud-sync-v4' || !data.shifts || !data.settings) throw new Error('æ–‡ä»¶æ ¼å¼ä¸åŒ¹é…');
          if (!confirm(`ç¡®å®šå¯¼å…¥å¤‡ä»½æ–‡ä»¶ï¼ˆ${data.exportTime}ï¼‰ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚`)) return;
          shifts = data.shifts;
          selectedMonth = data.month;
          settings = { ...defaultSettings, ...data.settings };
          localStorage.setItem('userId', data.userId);
          await saveToStorageSafe({ sync: true });
          document.getElementById('monthInput').value = selectedMonth;
          loadSettingsUI();
          renderCalendar();
          alert('âœ… æ•°æ®å¯¼å…¥å¹¶åŒæ­¥æˆåŠŸï¼');
        } catch (err) {
          console.error(err);
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function renderCalendar() {
      const monthInput = document.getElementById('monthInput').value;
      if (!monthInput) return;
      selectedMonth = monthInput;
      saveToStorageSafe({ sync: true });
      const year = parseInt(selectedMonth.split('-')[0]);
      const month = parseInt(selectedMonth.split('-')[1]) - 1;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';
      let cols = 7;
      let showHeaders = true;
      if (currentView === 'cycle') { cols = 6; showHeaders = false; }

      if (showHeaders) {
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => {
          const header = document.createElement('div');
          header.className = 'day-header';
          header.textContent = day;
          calendarEl.appendChild(header);
        });
      }

      if (currentView === 'week') {
        const startDayOfWeek = firstDay.getDay();
        for (let i = 0; i < startDayOfWeek; i++) { calendarEl.appendChild(document.createElement('div')); }
      }

      calendarEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${selectedMonth}-${String(day).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.dataset.date = dateStr;

        const numberSpan = document.createElement('span');
        numberSpan.className = 'day-number';
        numberSpan.textContent = day;
        const hoursSpan = document.createElement('span');
        hoursSpan.className = 'day-hours';
        const totalHours = getDailyHours(dateStr);
        const shiftType = shifts[dateStr]?.type;
        let typeText = '';
        if (shiftType === 'big') typeText = 'å¤§å¤œ';
        else if (shiftType === 'small') typeText = 'å°å¤œ';
        else if (shiftType === 'custom') typeText = 'è‡ªå®šä¹‰';
        
        hoursSpan.textContent = totalHours > 0 ? `${typeText} ${totalHours.toFixed(1)}h` : typeText;
        const extraHours = getExtraHours(dateStr);
        const extraSpan = document.createElement('span');
        extraSpan.className = 'day-extra';
        if (extraHours !== 0) { extraSpan.textContent = extraHours > 0 ? `(+${extraHours.toFixed(1)}h)` : `(${extraHours.toFixed(1)}h)`; } 
        else { extraSpan.textContent = ''; }

        cell.appendChild(numberSpan);
        cell.appendChild(hoursSpan);
        cell.appendChild(extraSpan);
        cell.addEventListener('click', () => {
          if (isMultiSelectMode) { toggleMultiSelect(dateStr, cell); } 
          else { if (multiSelectedDates.size > 0) clearSelected(); toggleSingleShift(dateStr); }
        });
        let pressTimer;
        cell.addEventListener('mousedown', (e) => {
            if (e.button === 0) { 
                pressTimer = setTimeout(() => {
                    isMultiSelectMode = true;
                    updateMultiSelectUI();
                    toggleMultiSelect(dateStr, cell);
                }, 500);
            }
        });
        cell.addEventListener('mouseup', () => clearTimeout(pressTimer));
        cell.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        cell.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            rightClickedDate = dateStr;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        });

        updateCellClass(cell, dateStr);
        calendarEl.appendChild(cell);
      }
      document.addEventListener('click', () => { document.getElementById('contextMenu').style.display = 'none'; });
      checkCompliance();
      updateShiftInfo();
      updateWeekSummary();
    }

    function toggleMultiSelect(dateStr, cell) {
        if (multiSelectedDates.has(dateStr)) {
            multiSelectedDates.delete(dateStr);
            cell.classList.remove('multi-selected');
        } else {
            multiSelectedDates.add(dateStr);
            cell.classList.add('multi-selected');
        }
        updateMultiSelectUI();
    }
    
    function clearMultiSelectUI() {
        document.querySelectorAll('.day-cell.multi-selected').forEach(el => { el.classList.remove('multi-selected'); });
    }

    function updateCellClass(cell, dateStr) {
        cell.classList.remove('selected-big', 'selected-small', 'custom', 'over-limit');
        const shift = shifts[dateStr];
        if (shift) {
            if (shift.type === 'big') cell.classList.add('selected-big');
            else if (shift.type === 'small') cell.classList.add('selected-small');
            else if (shift.type === 'custom') cell.classList.add('custom');
        }
    }

    function updateMultiSelectUI() {
        const indicator = document.getElementById('selectionModeIndicator');
        const hint = document.getElementById('multiSelectHint');
        if (isMultiSelectMode) { indicator.style.display = 'inline-block'; hint.style.display = 'none'; } 
        else { indicator.style.display = 'none'; hint.style.display = 'block'; }
    }

    async function applyShiftToSelected(type) {
        if (multiSelectedDates.size === 0) { alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ'); return; }
        multiSelectedDates.forEach(dateStr => {
            if (type === 'big') {
                shifts[dateStr] = { type: 'big', hours: settings.bigMain, nextDayHours: settings.bigNext };
                const nextDay = new Date(dateStr);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayStr = nextDay.toISOString().split('T')[0];
                shifts[nextDayStr] = shifts[nextDayStr] || { type: 'auto-next', hours: 0, nextDayHours: 0 };
            } else if (type === 'small') {
                shifts[dateStr] = { type: 'small', hours: settings.small, nextDayHours: 0 };
            }
        });
        await saveToStorageSafe({ sync: true });
        clearSelected();
        renderCalendar();
    }

    async function toggleSingleShift(dateStr) {
        const currentShift = shifts[dateStr];
        let nextType;
        if (!currentShift) nextType = 'big';
        else if (currentShift.type === 'big') nextType = 'small';
        else if (currentShift.type === 'small') nextType = 'none';
        else nextType = 'big';

        if (currentShift?.type === 'big') {
            const nextDay = new Date(dateStr);
            nextDay.setDate(nextDay.getDate() + 1);
            const nextDayStr = nextDay.toISOString().split('T')[0];
            if (shifts[nextDayStr]?.type === 'auto-next') delete shifts[nextDayStr];
        }

        if (nextType === 'big') {
            shifts[dateStr] = { type: 'big', hours: settings.bigMain, nextDayHours: settings.bigNext };
            const nextDay = new Date(dateStr);
            nextDay.setDate(nextDay.getDate() + 1);
            const nextDayStr = nextDay.toISOString().split('T')[0];
            shifts[nextDayStr] = shifts[nextDayStr] || { type: 'auto-next', hours: 0, nextDayHours: 0 };
        } else if (nextType === 'small') {
            shifts[dateStr] = { type: 'small', hours: settings.small, nextDayHours: 0 };
        } else {
            delete shifts[dateStr];
        }
        await saveToStorageSafe({ sync: true });
        renderCalendar();
    }

    async function deleteSelected() {
        if (multiSelectedDates.size === 0) { alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ'); return; }
        if (!confirm(`ç¡®å®šåˆ é™¤è¿™ ${multiSelectedDates.size} ä¸ªæ—¥æœŸçš„æ’ç­è®°å½•å—ï¼Ÿ`)) return;
        multiSelectedDates.forEach(dateStr => {
            if (shifts[dateStr]?.type === 'big') {
                const nextDay = new Date(dateStr);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayStr = nextDay.toISOString().split('T')[0];
                if (shifts[nextDayStr]?.type === 'auto-next') delete shifts[nextDayStr];
            }
            delete shifts[dateStr];
        });
        await saveToStorageSafe({ sync: true });
        clearSelected();
        renderCalendar();
    }

    async function deleteSingleShift() {
        document.getElementById('contextMenu').style.display = 'none';
        if (!rightClickedDate) return;
        if (shifts[rightClickedDate]?.type === 'big') {
            const nextDay = new Date(rightClickedDate);
            nextDay.setDate(nextDay.getDate() + 1);
            const nextDayStr = nextDay.toISOString().split('T')[0];
            if (shifts[nextDayStr]?.type === 'auto-next') delete shifts[nextDayStr];
        }
        delete shifts[rightClickedDate];
        await saveToStorageSafe({ sync: true });
        rightClickedDate = '';
        renderCalendar();
    }

    function clearSelected() {
        clearMultiSelectUI();
        multiSelectedDates.clear();
        isMultiSelectMode = false;
        updateMultiSelectUI();
    }

    function openExtraModal() {
        if (multiSelectedDates.size === 0) { alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ'); return; }
        document.getElementById('extraInput').value = '';
        document.querySelector('input[name="unit"][value="hour"]').checked = true;
        document.getElementById('extraModal').style.display = 'flex';
    }

    function closeExtraModal() {
        document.getElementById('extraModal').style.display = 'none';
    }

    async function applyExtra() {
        const inputEl = document.getElementById('extraInput');
        const valueStr = inputEl.value.trim();
        if (!valueStr) { closeExtraModal(); return; }
        const value = parseFloat(valueStr);
        if (isNaN(value)) { alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—'); return; }
        const unitRadio = document.querySelector('input[name="unit"]:checked');
        if (!unitRadio) { alert('è¯·é€‰æ‹©å•ä½ï¼ˆå°æ—¶æˆ–åˆ†é’Ÿï¼‰'); return; }
        const unit = unitRadio.value;
        let extraHours = 0;
        if (unit === 'hour') extraHours = value;
        else extraHours = value / 60;

        multiSelectedDates.forEach(dateStr => {
            if (!shifts[dateStr]) shifts[dateStr] = { type: 'custom', hours: 0, nextDayHours: 0 };
            shifts[dateStr].extra = (shifts[dateStr].extra || 0) + extraHours;
            shifts[dateStr].extraMeta = { value, unit };
            if (Math.abs(shifts[dateStr].extra) < 0.001) { delete shifts[dateStr].extra; delete shifts[dateStr].extraMeta; }
        });
        await saveToStorageSafe({ sync: true });
        closeExtraModal();
        clearMultiSelectUI();
        multiSelectedDates.clear();
        isMultiSelectMode = false;
        updateMultiSelectUI();
        renderCalendar();
    }

    function getBaseHours(dateStr) {
        const shift = shifts[dateStr];
        if (!shift) return 0;
        if (shift.type === 'big' || shift.type === 'small' || shift.type === 'custom') return shift.hours;
        if (shift.type === 'auto-next') {
            const prev = new Date(dateStr);
            prev.setDate(prev.getDate() - 1);
            const prevStr = prev.toISOString().split('T')[0];
            const prevShift = shifts[prevStr];
            return prevShift?.nextDayHours || 0;
        }
        return 0;
    }

    function getExtraHours(dateStr) {
        const shift = shifts[dateStr];
        return shift?.extra || 0;
    }

    function getDailyHours(dateStr) {
        return getBaseHours(dateStr) + getExtraHours(dateStr);
    }

    function calculateMonthlyTotalHours(monthStr) {
        let total = 0;
        for (const dateStr in shifts) {
            if (dateStr.startsWith(monthStr)) total += getDailyHours(dateStr);
        }
        return total;
    }

    function generateAllRelevant7DayWindows() {
        const windows = [];
        const [year, month] = selectedMonth.split('-').map(Number);
        const firstDayOfMonth = new Date(year, month - 1, 1);
        const lastDayOfMonth = new Date(year, month, 0);
        const start = new Date(firstDayOfMonth);
        start.setDate(start.getDate() - 6);
        const end = lastDayOfMonth;
        let current = new Date(start);
        while (current <= end) {
            const windowEnd = new Date(current);
            windowEnd.setDate(windowEnd.getDate() + 6);
            if (windowEnd >= firstDayOfMonth) windows.push({ start: new Date(current), end: windowEnd });
            current.setDate(current.getDate() + 1);
        }
        return windows;
    }

    function checkCompliance() {
        const windows = generateAllRelevant7DayWindows();
        weekSummaries = [];
        const overLimitDates = new Set();
        
        windows.forEach(w => {
            let total = 0;
            const datesInRange = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(w.start);
                d.setDate(d.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                datesInRange.push(iso);
                total += getDailyHours(iso);
            }
            const violation = total > settings.limit;
            weekSummaries.push({ start: w.start.toISOString().split('T')[0], end: w.end.toISOString().split('T')[0], total: total, dates: datesInRange, violation: violation });
            if (violation) { datesInRange.forEach(d => overLimitDates.add(d)); }
        });
        document.querySelectorAll('.day-cell').forEach(cell => {
            const dateStr = cell.dataset.date;
            if (dateStr && overLimitDates.has(dateStr)) cell.classList.add('over-limit');
            else cell.classList.remove('over-limit');
        });
    }

    function updateShiftInfo() {
        const total = calculateMonthlyTotalHours(selectedMonth);
        const hasOverLimit = weekSummaries.some(w => w.violation);
        const infoEl = document.getElementById('shiftInfo');
        infoEl.innerHTML = `<p>æœ¬æœˆæ€»å·¥æ—¶ï¼š${total.toFixed(2)} å°æ—¶</p><div class="result ${hasOverLimit ? 'warn' : 'ok'}">${hasOverLimit ? `âš ï¸ è­¦å‘Šï¼šå­˜åœ¨è¿ç»­7å¤©å·¥æ—¶è¶…è¿‡ ${settings.limit} å°æ—¶ï¼` : `âœ… å½“å‰å®‰æ’ç¬¦åˆè§„å®šï¼ˆä»»æ„7å¤©â‰¤${settings.limit}å°æ—¶ï¼‰`}</div>`;
    }

    function updateWeekSummary() {
        const listEl = document.getElementById('weekList');
        if (weekSummaries.length === 0) { listEl.innerHTML = '<p>æš‚æ— 7å¤©å‘¨æœŸæ•°æ®</p>'; return; }
        let html = '';
        weekSummaries.forEach(w => {
            const startMonth = w.start.substring(0, 7);
            const endMonth = w.end.substring(0, 7);
            if (startMonth !== selectedMonth && endMonth !== selectedMonth && w.start.substring(0, 7) !== selectedMonth) return;
            const cls = w.violation ? 'week-item violation' : 'week-item';
            html += `<div class="${cls}">${w.start} è‡³ ${w.end}ï¼šæ€»å·¥æ—¶ ${w.total.toFixed(2)} å°æ—¶${w.violation ? `<span style="color:red;font-weight:bold;"> [è¶…é™]</span>` : ''}</div>`;
        });
        listEl.innerHTML = html || '<p>æš‚æ— 7å¤©å‘¨æœŸæ•°æ®</p>';
    }
    
    function getDetailedShifts(startDateStr, endDateStr) {
        if (!startDateStr || !endDateStr) return [];
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        if (startDate > endDate) return [];
        const detailedShifts = [];
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const shiftData = shifts[dateStr] || { type: 'none', hours: 0, nextDayHours: 0, extra: 0 };
            const baseHours = getBaseHours(dateStr);
            const extraHours = getExtraHours(dateStr);
            const totalHours = baseHours + extraHours;
            if (totalHours > 0 || (shiftData.type !== 'none' && shiftData.type !== 'auto-next')) {
                detailedShifts.push({ date: dateStr, shiftType: shiftData.type, baseHours: parseFloat(baseHours.toFixed(2)), extraHours: parseFloat(extraHours.toFixed(2)), totalHours: parseFloat(totalHours.toFixed(2)), raw: shiftData });
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return detailedShifts;
    }

    function calculateStatsForRange() {
        const startInput = document.getElementById('statStartDate').value;
        const endInput = document.getElementById('statEndDate').value;

        if (!startInput || !endInput) return null;

        const [sYear, sMonth, sDay] = startInput.split('-').map(Number);
        const [eYear, eMonth, eDay] = endInput.split('-').map(Number);
        
        const startDate = new Date(sYear, sMonth - 1, sDay);
        const endDate = new Date(eYear, eMonth - 1, eDay);
        endDate.setHours(23, 59, 59, 999);

        if (startDate > endDate) return null;

        const allMonths = getMonthsBetween(startDate, endDate);
        let totalWorkDays = 0;
        let totalHours = 0;
        let bigCount = 0, smallCount = 0, customCount = 0, autoNextCount = 0;
        let workedDates = [];
        let complianceViolations = 0;

        const detailedShifts = getDetailedShifts(startInput, endInput);

        detailedShifts.forEach(s => {
            if (s.totalHours > 0) {
                totalWorkDays++;
                totalHours += s.totalHours;
                workedDates.push(new Date(s.date).getTime());
            }
            if (s.shiftType === 'big') bigCount++;
            else if (s.shiftType === 'small') smallCount++;
            else if (s.shiftType === 'custom') customCount++;
            else if (s.shiftType === 'auto-next') autoNextCount++;
        });

        const allRelevantWindows = generateAllRelevant7DayWindowsForRange(startDate, endDate);
        allRelevantWindows.forEach(w => {
            let total = 0;
            for (let i = 0; i < 7; i++) {
                const d = new Date(w.start);
                d.setDate(d.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                total += getDailyHours(iso);
            }
            if (total > settings.limit) complianceViolations++;
        });

        let maxConsecutive = 0;
        workedDates.sort((a, b) => a - b);
        if (workedDates.length > 0) {
            maxConsecutive = 1;
            let currentStreak = 1;
            for (let i = 1; i < workedDates.length; i++) {
                const diff = (workedDates[i] - workedDates[i - 1]) / (1000 * 60 * 60 * 24);
                if (Math.round(diff) === 1) {
                    currentStreak++;
                    maxConsecutive = Math.max(maxConsecutive, currentStreak);
                } else {
                    currentStreak = 1;
                }
            }
        }

        const totalMonths = allMonths.length;
        const avgMonthlyHours = totalMonths > 0 ? (totalHours / totalMonths) : 0;
        const avgDailyHours = totalWorkDays > 0 ? (totalHours / totalWorkDays) : 0;

        return {
            dateRange: `${startInput} è‡³ ${endInput}`,
            totalHours: parseFloat(totalHours.toFixed(2)),
            totalWorkDays,
            avgMonthlyHours: parseFloat(avgMonthlyHours.toFixed(2)),
            avgDailyHours: parseFloat(avgDailyHours.toFixed(2)),
            bigCount, smallCount, customCount, autoNextCount, maxConsecutive, totalMonths, complianceViolations, allMonths,
            detailedShifts: detailedShifts.filter(s => s.totalHours > 0)
        };
    }

    function renderStatsWithRange() {
        currentStatsSummary = calculateStatsForRange();
        const aiResultStatusEl = document.getElementById('aiSummaryResultStatus');
        
        if (!currentStatsSummary) {
            document.getElementById('statsGrid').innerHTML = '<p>è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¥æœŸèŒƒå›´ã€‚</p>';
            aiResultStatusEl.textContent = 'âŒ è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¥æœŸèŒƒå›´ã€‚';
            resetPanelChat('stats');
            return;
        }

        // ä¿®å¤ï¼šè§£æ„å¹¶ä½¿ç”¨ dateRange å±æ€§
        const { dateRange, totalHours, totalWorkDays, avgMonthlyHours, avgDailyHours, bigCount, smallCount, customCount, maxConsecutive, complianceViolations, allMonths } = currentStatsSummary;
        
        const stats = [
            { label: 'ç»Ÿè®¡æ—¶é—´æ®µ', value: dateRange }, // ç›´æ¥ä½¿ç”¨ä¿®å¤åçš„ dateRange å±æ€§
            { label: 'æ€»å·¥æ—¶', value: `${totalHours} å°æ—¶` },
            { label: 'å¹³å‡æ¯æœˆå·¥æ—¶', value: `${avgMonthlyHours} å°æ—¶` },
            { label: 'å·¥ä½œå¤©æ•°', value: `${totalWorkDays} å¤©` },
            { label: 'å¹³å‡æ¯æ—¥å·¥æ—¶', value: `${avgDailyHours} å°æ—¶` },
            { label: 'å¤§å¤œç­æ¬¡æ•°', value: `${bigCount} æ¬¡` },
            { label: 'å°å¤œç­æ¬¡æ•°', value: `${smallCount} æ¬¡` },
            { label: 'è‡ªå®šä¹‰/é¢å¤–ç­æ¬¡', value: `${customCount} æ¬¡` },
            { label: 'æœ€é•¿è¿ç»­å·¥ä½œ', value: `${maxConsecutive} å¤©` },
            { label: `è¿ç»­7å¤©è¶…é™æ¬¡æ•° (é™${settings.limit}h)`, value: `${complianceViolations} æ¬¡`, isViolation: complianceViolations > 0 },
        ];
        let html = '';
        stats.forEach(stat => {
            const cls = stat.isViolation ? 'warn' : '';
            html += `<div class="stat-item ${cls}"><label>${stat.label}</label><div class="stat-value">${stat.value}</div></div>`;
        });
        document.getElementById('statsGrid').innerHTML = html;

        renderMonthlyHoursChart(allMonths, currentStatsSummary.dateRange.split(' è‡³ ')[0], currentStatsSummary.dateRange.split(' è‡³ ')[1]);
        aiResultStatusEl.textContent = 'âœ… æ•°æ®åˆ†æå·²å®Œæˆã€‚ç‚¹å‡» "å¯åŠ¨ AI æ€»ç»“" æŒ‰é’®å¼€å§‹å¯¹è¯ã€‚';
        // è‡ªåŠ¨é‡ç½®å¯¹è¯ï¼Œå‡†å¤‡æ–°çš„æ€»ç»“
        resetPanelChat('stats', aiResultStatusEl.textContent);
    }

    function getMonthsBetween(startDate, endDate) {
        const months = [];
        let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        const end = new Date(endDate.getFullYear(), endDate.getMonth(), 1);

        while (current <= end) {
            const year = current.getFullYear();
            const month = String(current.getMonth() + 1).padStart(2, '0');
            months.push(`${year}-${month}`);
            current.setMonth(current.getMonth() + 1);
        }
        return months;
    }

    function generateAllRelevant7DayWindowsForRange(startDate, endDate) {
        const windows = [];
        const start = new Date(startDate);
        start.setDate(start.getDate() - 6);
        const end = endDate;
        let current = new Date(start);
        while (current <= end) {
            const windowEnd = new Date(current);
            windowEnd.setDate(windowEnd.getDate() + 6);
            windows.push({ start: new Date(current), end: windowEnd });
            current.setDate(current.getDate() + 1);
        }
        return windows;
    }

    function renderMonthlyHoursChart(months, startDateStr, endDateStr) {
        const monthlyData = {};
        months.forEach(month => { monthlyData[month] = { total: 0, workDays: 0 }; });
        const detailedShifts = getDetailedShifts(startDateStr, endDateStr);
        detailedShifts.forEach(s => {
            const month = s.date.substring(0, 7);
            if (monthlyData[month]) {
                monthlyData[month].total += s.totalHours;
                if (s.totalHours > 0) monthlyData[month].workDays += 1;
            }
        });
        const labels = Object.keys(monthlyData).sort();
        const hours = labels.map(m => parseFloat(monthlyData[m].total.toFixed(2)));
        const workDays = labels.map(m => monthlyData[m].workDays);

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'æœˆæ€»å·¥æ—¶ (å°æ—¶)', data: hours, backgroundColor: 'rgba(24, 144, 255, 0.7)', yAxisID: 'y' },
                    { label: 'æœˆå·¥ä½œå¤©æ•° (å¤©)', data: workDays, backgroundColor: 'rgba(82, 196, 26, 0.7)', yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'å·¥æ—¶ (å°æ—¶)' }, grid: { drawOnChartArea: true } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'å·¥ä½œå¤©æ•° (å¤©)' }, grid: { drawOnChartArea: false } }
                },
                plugins: { legend: { position: 'top' }, title: { display: true, text: 'æ¯æœˆå·¥æ—¶ä¸å¤©æ•°æ¦‚è§ˆ' } }
            }
        });
    }

    // ========== AI é€šç”¨æœåŠ¡å‡½æ•° ==========
    async function runChatCompletion(messages, endpoint, apiKey, model, isStreaming = false, chunkCallback = null) {
      try {
          const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
              body: JSON.stringify({ model: model, messages: messages, stream: isStreaming })
          });
          if (!response.ok) { const errorText = await response.text(); throw new Error(`API è°ƒç”¨å¤±è´¥ [${response.status}]: ${errorText.substring(0, 100)}...`); }

          if (isStreaming) {
              if (!response.body) throw new Error("APIå“åº”æ²¡æœ‰æ­£æ–‡ï¼ˆå¯èƒ½ä¸æ”¯æŒæµå¼ä¼ è¾“ï¼‰ã€‚");
              const reader = response.body.getReader();
              const decoder = new TextDecoder("utf-8");
              let fullText = "";
              let buffer = "";
              try {
                  while (true) {
                      const { done, value } = await reader.read();
                      if (done) break;
                      buffer += decoder.decode(value, { stream: true });
                      let lines = buffer.split('\n');
                      buffer = lines.pop();
                      for (const line of lines) {
                          const trimmedLine = line.trim();
                          if (!trimmedLine || trimmedLine === 'data: [DONE]') continue;
                          if (trimmedLine.startsWith('data: ')) {
                              try {
                                  const jsonString = trimmedLine.substring(6);
                                  const data = JSON.parse(jsonString);
                                  const delta = data.choices?.[0]?.delta?.content || '';
                                  if (delta) { fullText += delta; if (chunkCallback) chunkCallback(delta); }
                              } catch (e) { console.warn("JSONè§£æè·³è¿‡:", e); }
                          }
                      }
                  }
              } catch (e) { console.error("è¯»å–æµå¼æ•°æ®å¤±è´¥:", e); throw e; } finally { reader.releaseLock(); }
              return { content: fullText };
          } else {
              const jsonResponse = await response.json();
              return { content: jsonResponse.choices?.[0]?.message?.content || '' };
          }
      } catch (error) { console.error("RunChatCompletion Error:", error); throw error; }
    }

    // ========== AI å¯¹è¯é€»è¾‘ (Calendar & Stats é¢æ¿) ==========
    
    // å­˜å‚¨é¢æ¿çš„å¯¹è¯å†å²å’ŒçŠ¶æ€
    let panelChatHistory = { calendar: [], stats: [] };
    let isPanelTyping = { calendar: false, stats: false };
    // å­˜å‚¨é¢æ¿çš„ç³»ç»Ÿçº§ä¸Šä¸‹æ–‡æ•°æ®
    let panelContexts = { calendar: { system: '', data: '' }, stats: { system: '', data: '' } };

    function getPanelChatElements(panelId) {
        return {
            historyEl: document.getElementById(`${panelId}ChatHistory`),
            inputEl: document.getElementById(`${panelId}ChatInput`),
            inputContainerEl: document.getElementById(`${panelId}ChatInputContainer`),
            statusEl: document.getElementById(panelId === 'calendar' ? 'complianceAdviceStatus' : 'aiSummaryResultStatus'),
            sendBtn: document.querySelector(`#${panelId}ChatInputContainer button`)
        };
    }

    function displayPanelMessage(panelId, role, content, save = true) {
        const { historyEl } = getPanelChatElements(panelId);
        if (!historyEl) return;
        
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + (role === 'user' ? 'chat-user' : 'chat-ai');
        
        const formattedContent = content
            .replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => { return `<pre><code>${code.trim()}</code></pre>`; })
            .replace(/\n/g, '<br>');
            
        msgDiv.innerHTML = formattedContent;
        historyEl.appendChild(msgDiv);
        historyEl.scrollTop = historyEl.scrollHeight;

        if (save && role !== 'system') {
            panelChatHistory[panelId].push({ role, content });
        }
    }
    
    // é‡ç½®é¢æ¿å¯¹è¯çŠ¶æ€
    function resetPanelChat(panelId, initialMessage = null) {
        const { historyEl, inputContainerEl, statusEl } = getPanelChatElements(panelId);
        panelChatHistory[panelId] = [];
        isPanelTyping[panelId] = false;
        
        if (historyEl) historyEl.innerHTML = '';
        if (statusEl) {
            statusEl.style.display = 'block';
            if (initialMessage) statusEl.textContent = initialMessage;
        }
        if (inputContainerEl) inputContainerEl.style.display = 'none';
    }

    // æ ¸å¿ƒå‘é€å‡½æ•°ï¼ˆä¾› Calendar å’Œ Stats é¢æ¿ä½¿ç”¨ï¼‰
    async function sendPanelChatMessage(panelId, initialPrompt = null) {
        const { inputEl, inputContainerEl, statusEl, historyEl, sendBtn } = getPanelChatElements(panelId);
        
        const userMessage = initialPrompt || inputEl.value.trim();
        if (!userMessage && !initialPrompt) return;
        if (isPanelTyping[panelId]) return;
        if (!settings.aiEndpoint || !settings.aiApiKey) {
            displayPanelMessage(panelId, 'ai', 'âŒ é”™è¯¯ï¼šè¯·åœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æœåŠ¡ç»ˆç«¯ç‚¹å’Œ API å¯†é’¥ã€‚', false);
            return;
        }

        // éšè—çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¾ç¤ºèŠå¤©æ¡†
        if (statusEl) statusEl.style.display = 'none'; 
        historyEl.style.display = 'block';
        inputContainerEl.style.display = 'flex'; 

        // å¦‚æœä¸æ˜¯åˆå§‹å¯åŠ¨ï¼ˆå³ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­å‘é€çš„æ¶ˆæ¯ï¼‰ï¼Œåˆ™æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        if (!initialPrompt) {
            displayPanelMessage(panelId, 'user', userMessage);
            inputEl.value = '';
        }
        
        // ç¦ç”¨è¾“å…¥
        isPanelTyping[panelId] = true;
        inputEl.disabled = true;
        sendBtn.disabled = true;

        displayPanelMessage(panelId, 'ai', 'ğŸ§  AI æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...', false);
        const aiMessageEl = historyEl.lastElementChild;
        let finalResponse = '';
        let accumulatedText = '';

        try {
            // æ„é€  messages
            const systemMessage = panelContexts[panelId].system;
            const contextData = panelContexts[panelId].data;
            
            // 1. System Prompt
            const messagesToSend = [{ role: 'system', content: systemMessage }];
            // 2. Context Data (ä½œä¸º User çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæä¾›æ•°æ®åŸºç¡€)
            messagesToSend.push({ role: 'user', content: contextData });
            // 3. Historical Conversation
            messagesToSend.push(...panelChatHistory[panelId].filter(m => m.role !== 'system')); 

            // 4. Current Prompt/Message
            if (initialPrompt) {
                messagesToSend.push({ role: 'user', content: `è¯·åŸºäºæˆ‘æä¾›çš„æ’ç­æ•°æ®ï¼Œç›´æ¥ç»™å‡ºä½ çš„åˆå§‹åˆ†æå’Œå»ºè®®ã€‚` });
            } else {
                 messagesToSend.push({ role: 'user', content: userMessage });
            }
            
            const completion = await runChatCompletion(messagesToSend, settings.aiEndpoint, settings.aiApiKey, settings.aiModel, true, (chunk) => {
                accumulatedText += chunk;
                const formattedContent = accumulatedText
                    .replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => { return `<pre><code>${code.trim()}</code></pre>`; })
                    .replace(/\n/g, '<br>');
                aiMessageEl.innerHTML = formattedContent;
                historyEl.scrollTop = historyEl.scrollHeight;
            });
            
            finalResponse = completion.content;
            
        } catch (error) {
            console.error('API Error:', error);
            finalResponse = `âŒ API è°ƒç”¨å¤±è´¥: ${error.message}`;
            aiMessageEl.innerHTML = finalResponse.replace(/\n/g, '<br>');
        } finally {
            // ä¿å­˜æœ€ç»ˆ AI å“åº”åˆ°å†å²è®°å½•
            panelChatHistory[panelId].push({ role: 'ai', content: finalResponse });
            
            // é‡æ–°å¯ç”¨è¾“å…¥
            isPanelTyping[panelId] = false;
            inputEl.disabled = false;
            sendBtn.disabled = false;
            inputEl.style.height = 'auto'; 
        }
    }
    
    function handlePanelChatInput(event, panelId) {
        const inputEl = document.getElementById(`${panelId}ChatInput`);
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendPanelChatMessage(panelId);
        }
    }

    // ========== Calendar AI é€»è¾‘ (å¯åŠ¨å¯¹è¯) ==========
    async function runCalendarAiAnalysis() {
        const panelId = 'calendar';
        const { statusEl } = getPanelChatElements(panelId);

        if (!settings.aiEndpoint || !settings.aiApiKey) {
            resetPanelChat(panelId, 'âŒ é”™è¯¯ï¼šè¯·åœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æœåŠ¡ç»ˆç«¯ç‚¹å’Œ API å¯†é’¥ã€‚');
            return;
        }

        const violations = weekSummaries.filter(w => w.violation);
        
        if (violations.length === 0) {
            const msg = `âœ… AI åˆ†æï¼šæœ¬æœˆæ’ç­å®Œå…¨ç¬¦åˆè¿ç»­7å¤©å·¥æ—¶ä¸è¶…è¿‡ ${settings.limit} å°æ—¶çš„è§„å®šã€‚ä¸éœ€è¦æ¢ç­æˆ–è°ƒæ•´ã€‚`;
            resetPanelChat(panelId, msg);
            return;
        }
        
        // æ„å»ºç³»ç»Ÿå’Œä¸Šä¸‹æ–‡
        const violationDetails = violations.map(w => `\n- ${w.start} to ${w.end}: ${w.total.toFixed(2)} å°æ—¶ (è¶…é™ ${ (w.total - settings.limit).toFixed(2) } å°æ—¶)`).join('');
        const currentMonthShifts = getDetailedShifts(`${selectedMonth}-01`, new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).toISOString().split('T')[0]);
        const shiftDetails = currentMonthShifts.map(s => {
            if (s.shiftType === 'big') return `${s.date}: å¤§å¤œç­ (å«æ¬¡æ—¥) æ€»${s.totalHours.toFixed(1)}h`;
            if (s.shiftType === 'small') return `${s.date}: å°å¤œç­ æ€»${s.totalHours.toFixed(1)}h`;
            if (s.shiftType === 'custom') return `${s.date}: è‡ªå®šä¹‰ç­æ¬¡ æ€»${s.totalHours.toFixed(1)}h`;
            return null;
        }).filter(Boolean).join('; ');

        const contextData = `
            å½“å‰åˆ†ææœˆä»½ä¸º ${selectedMonth}ã€‚
            è§„åˆ™é™åˆ¶ï¼šè¿ç»­7å¤©å·¥æ—¶ä¸å¾—è¶…è¿‡ ${settings.limit} å°æ—¶ã€‚
            --- æ£€æµ‹åˆ°çš„è¿è§„è½®æ¬¡ ---
            å…±å‘ç° ${violations.length} æ¬¡è¶…é™ï¼š${violationDetails}
            --- æœ¬æœˆæ’ç­è®°å½•æ‘˜è¦ (ä»…ä¾›å‚è€ƒ) ---
            ${shiftDetails}
        `;

        panelContexts[panelId].system = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤œç­å·¥æ—¶åˆè§„æ”¹è¿›é¡¾é—®ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„**è¿ç»­7å¤©å·¥æ—¶è¶…é™è®°å½•**å’Œ**æœ¬æœˆè¯¦ç»†æ’ç­**ï¼Œç»™å‡ºå…·ä½“çš„ã€å¯æ“ä½œçš„æ”¹è¿›å»ºè®®ï¼Œä»¥æ¶ˆé™¤è¶…é™é£é™©ã€‚è§„åˆ™ï¼šè¿ç»­7å¤©å·¥æ—¶ä¸å¾—è¶…è¿‡ ${settings.limit} å°æ—¶ã€‚**ä½ çš„å»ºè®®å¿…é¡»æ˜¯å¯ä»¥æ“ä½œçš„æ¢ç­æˆ–è°ƒæ•´ï¼Œä¾‹å¦‚ï¼šå°†å“ªä¸€å¤©çš„å¤§å¤œç­æ”¹ä¸ºå°å¤œç­ï¼Œæˆ–åˆ é™¤å“ªä¸€å¤©çš„ç­æ¬¡ï¼Œæˆ–è€…å°†ç­æ¬¡å¾€åæŒªåŠ¨ä¸€å¤©ã€‚**`;
        panelContexts[panelId].data = contextData; 

        // åˆå§‹æé—®
        const initialPrompt = `è¯·é’ˆå¯¹å‘ç°çš„è¶…é™é—®é¢˜ï¼Œç»™å‡ºå…·ä½“çš„æ’ç­æ”¹è¿›å»ºè®®ï¼ˆä¾‹å¦‚ï¼šå°†å“ªä¸€å¤©çš„å¤§å¤œç­æ”¹ä¸ºå°å¤œç­ï¼Œæˆ–åˆ é™¤å“ªä¸€å¤©çš„ç­æ¬¡ï¼‰ã€‚è¯·ç”¨ä¸­æ–‡åˆ†ç‚¹æ€»ç»“ï¼Œé‡ç‚¹æ”¾åœ¨â€œå¦‚ä½•è§£å†³è¿è§„â€ä¸Šã€‚`;

        // é‡ç½®å¹¶å¯åŠ¨å¯¹è¯
        resetPanelChat(panelId);
        displayPanelMessage(panelId, 'user', `æ’ç­åˆè§„æ€§åˆ†æè¯·æ±‚ï¼ˆæœˆä»½ï¼š${selectedMonth}ï¼‰ã€‚æ•°æ®å·²æäº¤ç»™ AIã€‚`);
        sendPanelChatMessage(panelId, initialPrompt);
    }

    // ========== Stats AI é€»è¾‘ (å¯åŠ¨å¯¹è¯) ==========
    function generateAnalysisData() {
        if (!currentStatsSummary || Object.keys(currentStatsSummary).length === 0 || !currentStatsSummary.detailedShifts) {
            return { error: "æ— æ•°æ®ã€‚è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»â€œåˆ†æâ€ã€‚" };
        }
        const { dateRange, totalHours, totalWorkDays, avgMonthlyHours, avgDailyHours, bigCount, smallCount, customCount, maxConsecutive, violationCount, totalMonths, detailedShifts } = currentStatsSummary;
        const conciseShiftLines = detailedShifts.map(s => {
            let description = '';
            if (s.shiftType === 'big') description = `å¤§å¤œç­ (æœ¬æ—¥${s.raw.hours.toFixed(1)}h + æ¬¡æ—¥${s.raw.nextDayHours.toFixed(1)}h)`;
            else if (s.shiftType === 'small') description = `å°å¤œç­ (${s.raw.hours.toFixed(1)}h)`;
            else if (s.shiftType === 'custom') description = `è‡ªå®šä¹‰ç­æ¬¡ (åŸºç¡€${s.raw.hours.toFixed(1)}h)`;
            else if (s.shiftType === 'auto-next') return null;
            let extra = s.extraHours !== 0 ? (s.extraHours > 0 ? ` + é¢å¤–${s.extraHours.toFixed(2)}h` : ` - å‡å°‘${Math.abs(s.extraHours).toFixed(2)}h`) : '';
            return `${s.date}, ${description}${extra}, æ€»å·¥æ—¶ ${s.totalHours.toFixed(2)}h`;
        }).filter(line => line !== null);
        const dataForAI = `æ’ç­è®°å½•ï¼ˆå…±${conciseShiftLines.length}æ¡éè‡ªåŠ¨æ¥ç»­ç­æ¬¡ï¼‰ï¼š\n` + conciseShiftLines.join('\n');
        return {
            dateRange: dateRange,
            summaryStats: {
                totalHours, totalWorkDays, avgMonthlyHours, avgDailyHours,
                shiftCounts: { big: bigCount, small: smallCount, custom: customCount },
                maxConsecutive: maxConsecutive,
                violationCount: violationCount,
                detailedShiftsText: dataForAI
            }
        };
    }
    
    async function runAiAnalysis() {
        const panelId = 'stats';

        if (!settings.aiEndpoint || !settings.aiApiKey) {
            resetPanelChat(panelId, 'âŒ é”™è¯¯ï¼šè¯·åœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æœåŠ¡ç»ˆç«¯ç‚¹å’Œ API å¯†é’¥ã€‚');
            return;
        }
        
        const data = generateAnalysisData();
        if (data.error) {
            resetPanelChat(panelId, `âŒ é”™è¯¯ï¼š${data.error}`);
            return;
        }
        
        // æ„å»ºç³»ç»Ÿå’Œä¸Šä¸‹æ–‡
        const { dateRange, totalHours, totalWorkDays, avgMonthlyHours, avgDailyHours, bigCount, smallCount, customCount, maxConsecutive, violationCount, detailedShiftsText } = data.summaryStats;
        
        const contextData = `
            ç”¨æˆ·åœ¨ ${dateRange} æœŸé—´çš„æ’ç­è®°å½•å’Œç»Ÿè®¡æ‘˜è¦ï¼š
            --- ç»Ÿè®¡æ‘˜è¦ ---
            - æ€»å·¥ä½œå¤©æ•°: ${totalWorkDays} å¤©
            - æœ€å¤§è¿ç»­å·¥ä½œå¤©æ•°: ${maxConsecutive} å¤©
            - å¤§å¤œç­æ¬¡æ•°: ${bigCount} æ¬¡
            - å°å¤œç­æ¬¡æ•°: ${smallCount} æ¬¡
            - å¹³å‡æ¯æœˆå·¥æ—¶: ${avgMonthlyHours} å°æ—¶
            - è¿ç»­7å¤©å·¥æ—¶è¶…é™æ¬¡æ•°: ${violationCount} æ¬¡
            --- è¯¦ç»†æ’ç­æ•°æ® ---
            ${detailedShiftsText}
        `;
        
        panelContexts[panelId].system = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸ªäººå¥åº·ä¸ç”Ÿæ´»è§„åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºç”¨æˆ·æä¾›çš„æ’ç­è®°å½•ï¼Œåˆ†æå…¶å·¥ä½œå¼ºåº¦å’Œå¤œç­é¢‘ç‡ï¼Œå¹¶æä¾›**äººæ€§åŒ–çš„ã€å…³æ€€å¤‡è‡³çš„ç”Ÿæ´»å»ºè®®**ã€‚è¯·**é¿å…**æä¾›ç”¨æˆ·æ— æ³•å®æ–½çš„â€œè°ƒæ•´æ’ç­â€æˆ–â€œä¿®æ”¹åˆ¶åº¦â€çš„å»ºè®®ï¼Œé‡ç‚¹åœ¨äºç”¨æˆ·å¯ä»¥**è‡ªæˆ‘ç®¡ç†**çš„éƒ¨åˆ†ï¼ˆå¦‚ä¼‘æ¯æ—¶é—´å®‰æ’ã€å¥åº·é¥®é£Ÿã€åº”å¯¹ç–²åŠ³ã€ç¤¾äº¤æ´»åŠ¨å®‰æ’ç­‰ï¼‰ã€‚`;
        panelContexts[panelId].data = contextData; 

        // åˆå§‹æé—®
        const initialPrompt = `è¯·ä½ æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæä¾›ä¸€ä»½ä¸“ä¸šçš„é•¿æœŸå¥åº·ä¸ç”Ÿæ´»å¹³è¡¡åˆ†ææ€»ç»“ã€‚è¯·ç”¨ä¸­æ–‡åˆ†ç‚¹æ€»ç»“ï¼š\n1. **å·¥ä½œèŠ‚å¥ä¸å¼ºåº¦è¯„ä¼°**ï¼›\n2. **ç”Ÿæ´»è´¨é‡é£é™©æç¤º**ï¼›\n3. **äººæ€§åŒ–å»ºè®®ï¼ˆè‡ªæˆ‘ç®¡ç†ï¼‰**ã€‚`;
        
        // é‡ç½®å¹¶å¯åŠ¨å¯¹è¯
        resetPanelChat(panelId);
        displayPanelMessage(panelId, 'user', `ç»Ÿè®¡åˆ†ææ‘˜è¦è¯·æ±‚ï¼ˆèŒƒå›´ï¼š${dateRange}ï¼‰ã€‚æ•°æ®å·²æäº¤ç»™ AIã€‚`);
        sendPanelChatMessage(panelId, initialPrompt);
    }

    // ========== AI å¯¹è¯é€»è¾‘ (Chat é¢æ¿) - ä¿æŒåŸæœ‰ AIAssistant é€»è¾‘ä¸å˜ ==========

    class AIAssistant {
        static history = [];
        static isTyping = false;
        static historyEl = document.getElementById('chatHistory');
        static chatInputEl = document.getElementById('chatInput');
        static systemMessage = {};

        static initSystemMessage() {
            this.systemMessage = { 
                role: 'system', 
                content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šä¸”å……æ»¡äººæƒ…å‘³çš„ç§äººå¥åº·åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºç”¨æˆ·æä¾›çš„æ’ç­ã€å·¥æ—¶æ•°æ®ï¼Œå›ç­”å…³äºå¤œç­å·¥ä½œä¸‹çš„å¥åº·ã€æƒ…ç»ªå’Œç”Ÿæ´»è´¨é‡çš„é€šç”¨é—®é¢˜ã€‚è¯·ä»¥äº²åˆ‡ã€å…³æ€€çš„å£å»å›ç­”ï¼Œå¹¶æä¾›**ç§¯æä¸”å®ç”¨çš„ä¸ªäººç”Ÿæ´»å»ºè®®**ï¼ˆå¦‚ç¡çœ ä¼˜åŒ–ã€é¥®é£Ÿã€è¿åŠ¨ã€å¿ƒç†è°ƒé€‚ç­‰ï¼‰ã€‚è¯·**é¿å…**ç»™å‡ºå…³äºâ€œè°ƒæ•´åˆ¶åº¦â€æˆ–â€œä¿®æ”¹æ’ç­â€çš„å»ºè®®ï¼Œå› ä¸ºç”¨æˆ·æ— æ³•å†³å®šè¿™äº›ã€‚å½“å‰å‚è€ƒçš„åˆè§„è§„åˆ™ï¼ˆè¿ç»­7å¤©å·¥æ—¶é™åˆ¶ï¼‰ä¸º ${settings.limit} å°æ—¶ã€‚è¯·å°½é‡ç”¨ä¸­æ–‡å›ç­”ã€‚`
            };
            this.history = [this.systemMessage];
        }

        static updateChatConfigStatus() {
            const statusEl = document.getElementById('chatConfigStatus');
            if (settings.aiEndpoint && settings.aiApiKey && settings.aiModel) {
                statusEl.textContent = ` (é…ç½®æ¨¡å‹: ${settings.aiModel}ï¼ŒçŠ¶æ€: âœ… å¯ç”¨)`;
                statusEl.style.color = '#52c41a';
            } else {
                statusEl.textContent = ` (é…ç½®çŠ¶æ€: âŒ è¯·åœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI å¯†é’¥)`;
                statusEl.style.color = '#ff4d4f';
            }
        }

        static displayMessage(role, content, save = true) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message ' + (role === 'user' ? 'chat-user' : 'chat-ai');
            const formattedContent = content.replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => { return `<pre><code>${code.trim()}</code></pre>`; }).replace(/\n/g, '<br>');
            msgDiv.innerHTML = formattedContent; 
            AIAssistant.historyEl.appendChild(msgDiv);
            AIAssistant.historyEl.scrollTop = AIAssistant.historyEl.scrollHeight;
            if (save && role !== 'system') { AIAssistant.history.push({ role, content }); }
        }

        static async sendMessage(userMessage) {
            if (!userMessage.trim() || AIAssistant.isTyping) return;
            const endpoint = settings.aiEndpoint;
            const apiKey = settings.aiApiKey;
            const model = settings.aiModel;
            if (!endpoint || !apiKey) { AIAssistant.displayMessage('ai', 'âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æœåŠ¡ç»ˆç«¯ç‚¹å’Œ API å¯†é’¥ã€‚', false); return; }

            AIAssistant.displayMessage('user', userMessage);
            AIAssistant.isTyping = true;
            document.getElementById('chatSendBtn').disabled = true;
            document.getElementById('chatInput').disabled = true;

            const messagesToSend = [...AIAssistant.history];
            messagesToSend.push({ role: 'user', content: userMessage });
            AIAssistant.displayMessage('ai', '', false);
            const aiMessageEl = AIAssistant.historyEl.lastElementChild;
            let finalResponse = '';
            let accumulatedText = '';
            try {
                const completion = await runChatCompletion(messagesToSend, endpoint, apiKey, model, true, (chunk) => {
                    accumulatedText += chunk;
                    const formattedContent = accumulatedText.replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => { return `<pre><code>${code.trim()}</code></pre>`; }).replace(/\n/g, '<br>');
                    aiMessageEl.innerHTML = formattedContent; 
                    AIAssistant.historyEl.scrollTop = AIAssistant.historyEl.scrollHeight;
                });
                finalResponse = completion.content;
            } catch (error) {
                console.error('API Error:', error);
                finalResponse = `âŒ API è°ƒç”¨å¤±è´¥: ${error.message}`;
                aiMessageEl.innerHTML = finalResponse.replace(/\n/g, '<br>');
            } finally {
                AIAssistant.history.push({ role: 'ai', content: finalResponse });
                AIAssistant.isTyping = false;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('chatSendBtn').disabled = false;
                AIAssistant.chatInputEl.value = '';
                AIAssistant.chatInputEl.style.height = 'auto';
            }
        }

        static async analyzeShiftData() {
            if (AIAssistant.isTyping) return;
            const startInput = document.getElementById('chatStartDate').value;
            const endInput = document.getElementById('chatEndDate').value;
            if (!startInput || !endInput) { AIAssistant.displayMessage('ai', 'âŒ è¯·å…ˆåœ¨æ—¥æœŸè¾“å…¥æ¡†ä¸­é€‰æ‹©æœ‰æ•ˆçš„åˆ†ææ—¥æœŸèŒƒå›´ã€‚', false); return; }
            const detailedShifts = getDetailedShifts(startInput, endInput);
            if (detailedShifts.length === 0) { AIAssistant.displayMessage('ai', `âš ï¸ åœ¨ ${startInput} è‡³ ${endInput} èŒƒå›´å†…æœªæ‰¾åˆ°ä»»ä½•æ’ç­è®°å½•ã€‚è¯·æ£€æŸ¥æ‚¨é€‰æ‹©çš„æ—¥æœŸã€‚`, false); return; }
            
            const conciseShiftLines = detailedShifts.map(s => {
                let description = '';
                if (s.shiftType === 'big') description = `å¤§å¤œç­ (æœ¬æ—¥${s.raw.hours.toFixed(1)}h + æ¬¡æ—¥${s.raw.nextDayHours.toFixed(1)}h)`;
                else if (s.shiftType === 'small') description = `å°å¤œç­ (${s.raw.hours.toFixed(1)}h)`;
                else if (s.shiftType === 'custom') description = `è‡ªå®šä¹‰ç­æ¬¡ (åŸºç¡€${s.raw.hours.toFixed(1)}h)`;
                else if (s.shiftType === 'auto-next') return null;
                let extra = s.extraHours !== 0 ? (s.extraHours > 0 ? ` + é¢å¤–${s.extraHours.toFixed(2)}h` : ` - å‡å°‘${Math.abs(s.extraHours).toFixed(2)}h`) : '';
                return `${s.date}, ${description}${extra}, æ€»å…± ${s.totalHours.toFixed(2)}h`;
            }).filter(line => line !== null);
            const dataForAI = `æ’ç­è®°å½•ï¼ˆå…±${conciseShiftLines.length}æ¡éè‡ªåŠ¨æ¥ç»­ç­æ¬¡ï¼‰ï¼š\n` + conciseShiftLines.join('\n');
            const prompt = `
                ç”¨æˆ·è¯·æ±‚åˆ†æä»¥ä¸‹ ${startInput} è‡³ ${endInput} æœŸé—´çš„æ’ç­è®°å½•ã€‚è¯·æ³¨æ„ï¼Œç”¨æˆ·æ˜¯æ— æ³•å†³å®šæ’ç­åˆ¶åº¦çš„ä¸ªäººç”¨æˆ·ï¼Œå› æ­¤è¯·å°†åˆ†æé‡ç‚¹æ”¾åœ¨**æ’ç­å¯¹ä¸ªäººå¥åº·ã€æƒ…ç»ªå’Œç”Ÿæ´»è´¨é‡çš„æ½œåœ¨å½±å“**ä¸Šï¼Œå¹¶ç»™å‡º**å¯ä»¥è‡ªæˆ‘ç®¡ç†çš„å®ç”¨å»ºè®®**ã€‚è¯·é¿å…ä½¿ç”¨åˆ¶åº¦æ€§æˆ–å¼ºåˆ¶æ€§çš„è¯­è¨€ã€‚
                --- æ’ç­è®°å½• ---
                ${dataForAI}
                è¯·ä½ æ ¹æ®è¿™äº›è¯¦ç»†æ•°æ®ï¼Œå¯¹è¿™æ®µæ—¶é—´çš„æ’ç­è¿›è¡Œæ€»ç»“ã€‚é‡ç‚¹åˆ†æè¿ç»­å·¥ä½œå¤©æ•°è¿‡å¤šã€å¤œç­å¯†åº¦è¿‡é«˜ç­‰é£é™©å› ç´ ï¼Œå¹¶ç»™å‡ºäº²åˆ‡ã€å®ç”¨çš„ç”Ÿæ´»å»ºè®®ã€‚
            `;
            AIAssistant.sendMessage(prompt);
        }
    }

    function handleChatInput(event) {
        AIAssistant.chatInputEl.style.height = 'auto';
        AIAssistant.chatInputEl.style.height = AIAssistant.chatInputEl.scrollHeight + 'px';
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    function sendChatMessage() {
        const message = AIAssistant.chatInputEl.value;
        AIAssistant.sendMessage(message);
    }
    
    function resetChatHistory() {
        if (AIAssistant.isTyping) { alert('AI æ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨å€™å†é‡ç½®ã€‚'); return; }
        if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
            AIAssistant.historyEl.innerHTML = '';
            AIAssistant.initSystemMessage();
            AIAssistant.displayMessage('ai', 'å¯¹è¯è®°å½•å·²æ¸…ç©ºã€‚æˆ‘æ˜¯æ‚¨çš„ç§äººå¥åº·åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ', false);
        }
    }

    function initDateRangeForStats(autoRun = false) {
        const today = new Date();
        const statStartDateEl = document.getElementById('statStartDate');
        const statEndDateEl = document.getElementById('statEndDate');

        // åªæœ‰å½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®é»˜è®¤å€¼
        if (!statStartDateEl.value) {
             statStartDateEl.value = new Date(today.getFullYear(), today.getMonth(), 1).toLocaleDateString('en-CA');
        }
        if (!statEndDateEl.value) {
            statEndDateEl.value = today.toLocaleDateString('en-CA');
        }

        if (autoRun) renderStatsWithRange();
    }

    function initDateRangeForChat() {
        const today = new Date();
        document.getElementById('chatStartDate').value = new Date(today.getFullYear(), today.getMonth(), 1).toLocaleDateString('en-CA');
        document.getElementById('chatEndDate').value = today.toLocaleDateString('en-CA');
    }

    window.onload = async () => {
      loadFromLocal();
      if (!selectedMonth) selectedMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('monthInput').value = selectedMonth;

      currentView = settings.defaultView || 'week';
      if (currentView === 'cycle') {
          document.getElementById('btn-week').classList.remove('active');
          document.getElementById('btn-cycle').classList.add('active');
      } else {
          document.getElementById('btn-cycle').classList.remove('active');
          document.getElementById('btn-week').classList.add('active');
      }

      AIAssistant.initSystemMessage();
      AIAssistant.updateChatConfigStatus();
      initDateRangeForStats(true); // åˆå§‹åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç»Ÿè®¡
      initDateRangeForChat();
      
      // åˆå§‹åŒ–é¢æ¿å¯¹è¯çŠ¶æ€æç¤º
      resetPanelChat('calendar', 'ç‚¹å‡» "åˆ†æå¹¶æä¾›æ¢ç­å»ºè®®" å¯åŠ¨å¯¹è¯ã€‚');
      resetPanelChat('stats', 'è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»â€œåˆ†æâ€ï¼Œç„¶åç‚¹å‡» "å¯åŠ¨ AI æ€»ç»“" å¯åŠ¨å¯¹è¯ã€‚');
      
      await loadFromCloud();
      renderCalendar();
      const defaultTab = document.querySelector('.nav-tabs button.active')?.id.replace('tab-', '') || 'calendar';
      switchTab(defaultTab);
      
      if (supabase) {
        const userId = getUserId();
        let lastSyncTimestamp = 0;
        supabase
          .channel('shifts-channel')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts', filter: `user_id=eq.${userId}` }, async (payload) => {
            const now = Date.now();
            if (now - lastSyncTimestamp < 2000) return;
            lastSyncTimestamp = now;
            console.log('æ”¶åˆ°äº‘ç«¯ç­æ¬¡æ›´æ–°', payload.eventType);
            await loadFromCloud();
            renderCalendar();
          })
          .on('postgres_changes', { event: '*', schema: 'public', table: 'settings', filter: `user_id=eq.${userId}` }, async (payload) => {
            const now = Date.now();
            if (now - lastSyncTimestamp < 2000) return;
            lastSyncTimestamp = now;
            console.log('æ”¶åˆ°äº‘ç«¯è®¾ç½®æ›´æ–°', payload.eventType);
            await loadFromCloud();
            loadSettingsUI();
          })
          .subscribe((status) => { console.log('å®æ—¶è®¢é˜…çŠ¶æ€:', status); });
      }
    };

    window.onclick = (e) => { 
        if (e.target.id === 'extraModal') closeExtraModal(); 
        if (e.target.id === 'contextMenu') document.getElementById('contextMenu').style.display = 'none';
    };
    
    AIAssistant.displayMessage('ai', 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ç§äººå¥åº·åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚\n\nè¯·åˆ‡æ¢åˆ° **æ—¥å†** æˆ– **ç»Ÿè®¡åˆ†æ** é¡µé¢ï¼Œç‚¹å‡»ç›¸åº”çš„ "å¯åŠ¨å¯¹è¯" æŒ‰é’®ï¼Œå¼€å§‹é’ˆå¯¹æ€§çš„æ’ç­åˆ†æå’Œè®¨è®ºï¼', false);
  </script>
</body>
</html>
