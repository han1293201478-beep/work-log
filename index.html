<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆAI å¯¹è¯å¢å¼ºç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif;
padding: 20px; background-color: #f9f9f9; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px;
border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2, h3 { color: #333;
}
    h1 { text-align: center; }
    
    /* === å±…ä¸­æ ·å¼ä¿®æ”¹ === */
    .nav-tabs { 
        text-align: center;
margin-bottom: 20px; 
    }
    .month-picker, 
    .import-export, 
    .view-toggle {
        text-align: center;
margin-top: 15px; 
        margin-bottom: 15px; 
    }

    .nav-tabs button { margin: 0 6px;
padding: 6px 12px;
border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; border-radius: 4px;
}
    .nav-tabs button.active { background: #1890ff;
color: white; border-color: #1890ff;
}
    .calendar { display: grid; gap: 4px; margin-top: 10px;
}
    .day-header { text-align: center;
font-weight: bold; padding: 6px; background: #eee; border-radius: 4px; font-size: 14px;
}
    .day-cell { height: 80px; display: flex;
flex-direction: column; align-items: center; justify-content: center; border: 1px solid #ddd;
border-radius: 4px; cursor: pointer; background: #fff; font-size: 14px; user-select: none;
position: relative; padding: 4px; text-align: center;
}
    .day-number { font-weight: bold;
}
    .day-hours { font-size: 12px; color: #666; margin-top: 2px;
}
    .day-extra { font-size: 11px;
color: #999; }
    .day-total { font-size: 11px; color: #d46b08;
font-weight: bold; margin-top: 2px;
}
    .day-cell.over-limit { box-shadow: 0 0 0 3px red;
}
    .day-cell.multi-selected { outline: 2px solid blue; z-index: 2;
}
    .controls button { margin: 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
}
    .btn-sync { background: #52c41a; color: white; }
    .shift-info { margin-top: 20px; padding: 15px;
background: #f0f9ff; border-radius: 6px; }
    .result { margin-top: 10px; padding: 8px; border-radius: 4px; font-weight: bold;
}
    .ok { background: #f6ffed; color: #52c41a; }
    .warn { background: #fff2f0; color: #ff4d4f;
}
    .week-summary { margin-top: 20px; }
    .week-list { max-height: 300px; overflow-y: auto;
border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
    .week-item { padding: 6px 0;
border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    .week-item.violation { background: #fff2f0; color: #ff4d4f; font-weight: bold;
}
    
    /* ... (å…¶ä»– CSS æ ·å¼ä¿æŒä¸å˜) ... */
    .day-cell:hover { background: #e6f7ff;
}
    .day-cell.selected-big { background: #ffe58f; border-color: #faad14; }
    .day-cell.selected-small { background: #b7eb8f; border-color: #52c41a;
}
    .day-cell.custom { background: #ffd6e7; border-color: #eb2f96; }
    .btn-big { background: #faad14; color: white;
}
    .btn-small { background: #52c41a; color: white; }
    .btn-clear { background: #d9d9d9; color: black;
}
    .btn-delete { background: #ff4d4f; color: white; }
    .btn-extra { background: #722ed1; color: white;
}
    .btn-settings { background: #13c2c2; color: white;
}
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%;
height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px;
border-radius: 8px; width: 320px; text-align: left; }
    .modal h3 { text-align: center; margin-top: 0;
}
    .modal input, .modal select { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc;
border-radius: 4px; box-sizing: border-box; }
    .modal-buttons { text-align: center; margin-top: 15px;
}
    .modal-buttons button { margin: 0 8px; }
    #importFileInput { display: none;
}
    .panel { display: none; }
    .panel.active { display: block;
}
    .settings-grid, .stats-controls, .stats-grid { display: grid; gap: 15px; margin-top: 15px;
}
    .settings-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .setting-item, .stat-item { padding: 12px;
background: #fafafa; border-radius: 6px; border: 1px solid #eee; }
    .setting-item label { display: block; margin-bottom: 6px;
font-weight: bold; font-size: 14px; }
    .setting-item input, .setting-item select { width: 100%; padding: 6px;
border: 1px solid #ccc; border-radius: 4px; }
    .stat-value { font-size: 20px; font-weight: bold; color: #1890ff; margin-top: 6px;
}
    .stats-controls, .chat-controls { display: grid; gap: 15px; margin-top: 15px; grid-template-columns: 1fr 1fr auto; align-items: end;
}
    .stats-controls > div, .chat-controls > div { display: flex; flex-direction: column;
}
    .stats-controls label, .chat-controls label { font-size: 14px; margin-bottom: 4px;
}
    .stats-controls input[type="date"], .chat-controls input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px;
}
    .stats-controls button, .chat-controls button { height: 34px; margin-top: 22px;
}
    #chartContainer { margin-top: 20px; position: relative; height: 300px; }
    .selection-mode-indicator { background: #1890ff;
color: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; display: inline-block; }
    .sync-status { display: inline-flex;
align-items: center; gap: 8px; padding: 4px 10px; border-radius: 4px; font-size: 14px; margin-left: 10px; transition: all 0.3s ease;
}
    .sync-status.synced { background: #f6ffed; color: #52c41a; }
    .sync-status.syncing { background: #e6f7ff; color: #1890ff;
animation: pulse 1.5s infinite; }
    .sync-status.error { background: #fff2f0; color: #ff4d4f;
}
    .sync-status.warning { background: #fff7e6; color: #d46b08;
}
    @keyframes pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1;
} }
    
    /* ä¿®å¤ AI Chat å¸ƒå±€: ç¡®ä¿èŠå¤©è®°å½•å‚ç›´å †å  */
    #chatContainer { display: flex;
flex-direction: column; height: 600px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-top: 15px;
}
    .ai-chat-history { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 15px;
background-color: #f7f7f7; 
        border: 1px solid #ddd; 
        border-radius: 8px 8px 0 0; 
        min-height: 200px; 
        max-height: 400px; 
        margin-top: 10px; 
        display: none;
/* é»˜è®¤éšè— */
    }
    .ai-chat-history.visible {
        display: flex;
/* å˜ä¸ºå¯è§æ—¶ä½¿ç”¨ Flex */
        flex-direction: column;
/* å…³é”®ï¼šå‚ç›´å †å æ¶ˆæ¯ */
    }

    #chatHistory { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #f7f7f7;
}
    .chat-message { padding: 10px 15px; margin-bottom: 10px; border-radius: 18px; max-width: 90%; line-height: 1.6;
}
    .chat-user { align-self: flex-end; margin-left: auto; background-color: #1890ff; color: white; border-bottom-right-radius: 2px;
}
    .chat-ai { align-self: flex-start; margin-right: auto; background-color: #e6e6e6; color: #333; border-bottom-left-radius: 2px;
}
    .chat-ai pre { white-space: pre-wrap; background: #fff; padding: 10px; border-radius: 4px; border: 1px dashed #ccc;
font-size: 12px; margin-top: 5px; overflow-x: auto; }
    .ai-chat-input-container { padding: 10px 15px; background-color: white;
border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; display: flex; gap: 10px;
}
    .ai-chat-input-container textarea { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 12px; resize: none;
max-height: 80px; line-height: 1.4; }
    .ai-chat-input-container button { background-color: #52c41a; color: white; border: none; padding: 8px 15px;
border-radius: 12px; cursor: pointer; font-weight: bold; }
    #chatInputContainer { padding: 15px; background-color: white; border-top: 1px solid #ddd;
display: flex; }
    #chatInput { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px;
resize: none; }
    #chatSendBtn { background-color: #52c41a; color: white; border: none; padding: 10px 20px; border-radius: 20px;
cursor: pointer; font-weight: bold; }
    #chatSendBtn:disabled { background-color: #ccc; cursor: not-allowed;
}
  </style>
</head>
<body>
  <div class="container">
    <h1>
      å¤œç­å·¥æ—¶åˆè§„æ£€æŸ¥å™¨ï¼ˆAI å¯¹è¯å¢å¼ºç‰ˆï¼‰
      <span id="syncStatus" class="sync-status synced">âœ“ å·²åŒæ­¥</span>
    </h1>

    <div class="user-controls" style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f0f5ff; border-radius: 8px;">
        <span>å½“å‰è´¦å·: <b id="currentUserIdDisplay">æœªç™»å½•</b></span>
        <span id="accessModeBadge" style="font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; background: #ccc;">æœªè¿æ¥</span>
        <div style="margin-top: 10px;">
            <input type="text" id="loginUserId" placeholder="è¾“å…¥ç”¨æˆ·ID" style="padding: 5px; width: 120px; border:1px solid #ccc; border-radius:4px;">
            <button class="btn-small" onclick="openLoginModal('owner')">ğŸ”‘ ç™»å½•(ç®¡ç†)</button>
            <button class="btn-settings" onclick="openLoginModal('guest')">ğŸ” æŸ¥è¯¢(åªè¯»)</button>
        </div>
    </div>
    <div class="nav-tabs">
      <button id="tab-calendar" class="active" onclick="switchTab('calendar')">æ—¥å†</button>
      <button id="tab-stats" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡åˆ†æ</button>
      <button id="tab-chat" onclick="switchTab('chat')">ğŸ’¬ AI å¯¹è¯</button>
      <button id="tab-settings" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
    </div>

    <div id="panel-calendar" class="panel active">
      <div class="month-picker">
        <label>é€‰æ‹©æœˆä»½ï¼š</label>
  
        <input type="month" id="monthInput" />
        <button onclick="renderCalendar()">ç¡®å®š</button>
        <button class="btn-settings" onclick="forceLoad()">ğŸ“¥ ä»äº‘ç«¯åŠ è½½</button>
        <button class="btn-sync" onclick="forceUpload()">ğŸ“¤ ç«‹å³ä¸Šä¼ </button> 
      </div>

      <div class="import-export">
        <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½ï¼ˆJSONï¼‰</button>
        <button onclick="document.getElementById('importFileInput').click()">ğŸ“¥ æ‰‹åŠ¨å¯¼å…¥</button>
        <input type="file" id="importFileInput" accept=".json" onchange="importData(event)" />
        <p style="font-size:12px;color:#666;margin-top:6px;">
     
        â˜ï¸ æ•°æ®è‡ªåŠ¨äº‘ç«¯åŒæ­¥ |
âœ“ ç¦»çº¿å¯ç”¨ |
ID: <span id="userIdDisplay"></span>
        </p>
      </div>

      <div class="view-toggle">
        <button id="btn-week" class="active" onclick="switchView('week')">æ ‡å‡†å‘¨å†ï¼ˆ7å¤©/å‘¨ï¼‰</button>
        <button id="btn-cycle" onclick="switchView('cycle')">6å¤©å¾ªç¯å†</button>
      </div>

      <div class="controls">
        <p id="multiSelectHint">â€¢ PCç«¯ï¼šæŒ‰ä½ **Ctrl/Cmd** é”®ç‚¹å‡»æ—¥æœŸè¿›å…¥/é€€å‡ºå¤šé€‰æ¨¡å¼ï¼›æ‰‹æœºç«¯ï¼š**é•¿æŒ‰** ä»»æ„æ—¥æœŸè§¦å‘å¤šé€‰ï½œğŸ–±ï¸ **ç‚¹å‡» "åˆ‡æ¢å¤šé€‰æ¨¡å¼"** æŒ‰é’®ä¹Ÿå¯ä»¥è¿›å…¥å¤šé€‰æ¨¡å¼ã€‚</p>
        <div id="selectionModeIndicator" class="selection-mode-indicator" style="display: none;">å¤šé€‰æ¨¡å¼ï¼ˆç‚¹å‡»æ—¥æœŸåˆ‡æ¢é€‰ä¸­ï¼‰</div>
        <button class="btn-big" onclick="applyShiftToSelected('big')">è®¾ä¸ºå¤§å¤œç­</button>
     
        <button class="btn-small" onclick="applyShiftToSelected('small')">è®¾ä¸ºå°å¤œç­</button>
        <button class="btn-delete" onclick="deleteSelected()">åˆ é™¤æ‰€é€‰</button>
        <button class="btn-extra" onclick="openExtraModal()">é¢å¤–è°ƒæ•´</button>
        
        <button class="btn-extra" id="toggleMultiSelectBtn" onclick="toggleMultiSelectMode()">ğŸ–±ï¸ å¼€å¯å¤šé€‰</button>
        
        <button class="btn-clear" onclick="clearSelected()">å–æ¶ˆå¤šé€‰</button>
        <button class="btn-settings" onclick="runCalendarAiAnalysis()">ğŸ§  åˆ†æå¹¶æä¾›æ¢ç­å»ºè®® (å¯åŠ¨å¯¹è¯)</button> 
      </div>

      <div class="calendar" id="calendar"></div>
      
      <div class="shift-info" id="shiftInfo">
  
         </div>
      
      <div id="monthSummary" style="margin-top: 15px; padding: 10px; background: #e6f7ff; border-left: 5px solid #1890ff; border-radius: 4px;">
          </div>
      <div id="calendarAiChatContainer" style="margin-top: 15px;">
        <h3 id="calendarAiTitle">ğŸ”„ æ’ç­åˆè§„æ€§åˆ†æä¸è®¨è®º</h3>
        <div id="complianceAdviceStatus" style="padding: 10px;
border: 1px solid #ddd;
border-radius: 4px;">ç‚¹å‡»ä¸Šæ–¹ "åˆ†æå¹¶æä¾›æ¢ç­å»ºè®®" æŒ‰é’®å¯åŠ¨å¯¹è¯ã€‚</div>
        <div id="calendarChatHistory" class="ai-chat-history"></div>
        <div id="calendarChatInputContainer" class="ai-chat-input-container" style="display:none;">
            <textarea id="calendarChatInput" placeholder="åŸºäºä»¥ä¸Šåˆ†æç»§ç»­æé—®ï¼ˆä¾‹å¦‚ï¼šå°†10å·çš„ç­æŒªåˆ°12å·æ˜¯å¦åˆè§„ï¼Ÿï¼‰" rows="1" onkeydown="handlePanelChatInput(event, 'calendar')"></textarea>
            <button onclick="sendPanelChatMessage('calendar')">å‘é€</button>
        </div>
      </div>

      <div class="week-summary">
        <h3>ğŸ“… è¿ç»­7å¤©å·¥æ—¶ç»Ÿè®¡ï¼ˆä»…å«å½“æœˆæ—¥æœŸçš„è½®æ¬¡ï¼‰</h3>
        <div class="week-list" id="weekList"></div>
  
     </div>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š é«˜çº§ç»Ÿè®¡åˆ†æ</h2>
      <div class="stats-controls">
        <div><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="statStartDate" /></div>
        <div><div><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="statEndDate" /></div></div>
        <div><button class="btn-settings" onclick="renderStatsWithRange()">ğŸ” åˆ†æ</button></div>
      </div>
      <div class="stats-grid" id="statsGrid"></div>
      <div id="chartContainer"><canvas id="monthlyChart"></canvas></div>

      <div style="margin-top: 25px;
border-top: 1px solid #eee; padding-top: 15px;">
          <div id="statsAiChatContainer">
            <h3 id="statsAiTitle">ğŸ“ˆ AI æ™ºèƒ½æ€»ç»“ä¸è®¨è®º</h3>
            <button class="btn-settings" onclick="runAiAnalysis()">ğŸ§  å¯åŠ¨ AI æ€»ç»“ (å¯åŠ¨å¯¹è¯)</button>
            <div id="aiSummaryResultStatus" style="padding: 10px;
border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;">è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»â€œåˆ†æâ€ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯åŠ¨å¯¹è¯ã€‚</div>
            <div id="statsChatHistory" class="ai-chat-history"></div>
            <div id="statsChatInputContainer" class="ai-chat-input-container" style="display:none;">
                <textarea id="statsChatInput" placeholder="åŸºäºä»¥ä¸Šæ€»ç»“ç»§ç»­æé—®ï¼ˆä¾‹å¦‚ï¼šæˆ‘åº”è¯¥å¦‚ä½•åœ¨ä¼‘æ¯æ—¥æ›´å¥½åœ°æ¢å¤ç²¾åŠ›ï¼Ÿï¼‰" rows="1" onkeydown="handlePanelChatInput(event, 'stats')"></textarea>
                <button onclick="sendPanelChatMessage('stats')">å‘é€</button>
            </div>
          </div>
    
 
   </div>
    </div>

    <div id="panel-chat" class="panel">
        <h2>ğŸ’¬ AI ç§äººå¥åº·åŠ©æ‰‹</h2>
        <p style="color: #666;">
            æ‚¨å¯ä»¥åœ¨æ­¤ä¸ AI ç§äººå¥åº·åŠ©æ‰‹è¿›è¡Œå¯¹è¯ï¼Œè·å–å…³äºå¤œç­ä¸‹çš„å¥åº·ã€æƒ…ç»ªå’Œç”Ÿæ´»è´¨é‡çš„å»ºè®®ã€‚
            <span id="chatConfigStatus" style="font-weight: bold;"></span>
        </p>
        
        <div class="chat-controls">
            <div><label>åˆ†æå¼€å§‹æ—¥æœŸ</label><input 
type="date" 
id="chatStartDate" /></div>
            <div><div><label>åˆ†æç»“æŸæ—¥æœŸ</label><input type="date" id="chatEndDate" /></div></div>
            <div>
                <button class="btn-settings" onclick="AIAssistant.analyzeShiftData()">ğŸ“ˆ è·å–å¹¶åˆ†ææ’ç­å¯¹å¥åº·çš„å½±å“</button>
            </div>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn-clear" onclick="resetChatHistory()">ğŸ”„ é‡ç½®å¯¹è¯</button>
       
 
</div>

        <div id="chatContainer">
            <div id="chatHistory"></div>
            <div id="chatInputContainer">
                <textarea id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" onkeydown="handleChatInput(event)"></textarea>
                <button id="chatSendBtn" onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>
    </div>

  
 
 <div id="panel-settings" class="panel">
      <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
      <p>ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ï¼Œæ‰€æœ‰è®¾å¤‡åŒæ­¥ç”Ÿæ•ˆã€‚</p>
      <div class="settings-grid">
        <div class="setting-item"><label>å¤§å¤œç­ä¸»æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingBigMain" /></div>
        <div class="setting-item"><label>å¤§å¤œç­æ¬¡æ—¥æ—¶æ®µï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingBigNext" /></div>
        <div class="setting-item"><label>å°å¤œç­å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</label><input type="number" step="0.1" id="settingSmall" /></div>
        <div class="setting-item"><label>åˆè§„é˜ˆå€¼ï¼ˆ7å¤©æœ€å¤§å·¥æ—¶ï¼‰</label><input type="number" step="0.1" id="settingLimit" /></div>
        <div class="setting-item"><label>é»˜è®¤è§†å›¾</label><select id="settingDefaultView"><option value="week">æ ‡å‡†å‘¨å†</option><option value="cycle">6å¤©å¾ªç¯å†</option></select></div>
        <div class="setting-item"><label>åŒæ­¥ç”¨æˆ·IDï¼ˆå¤šè®¾å¤‡è¯·ä¿æŒä¸€è‡´ï¼‰</label><input type="text" id="settingUserId" 
placeholder="è¾“å…¥å­—æ¯æ•°å­—ç»„åˆ" 
/><small style="color:#666;">ç”¨äºåŒºåˆ†ä¸åŒç”¨æˆ·æ•°æ®</small></div>
        
        <div class="setting-item">
            <label>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </label>
            <button class="btn-settings" onclick="openChangePasswordModal()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
            <small style="color:#666;">éœ€è¦è¾“å…¥å½“å‰å¯†ç å’Œæ–°å¯†ç </small>
        </div>
        
        <div class="setting-item"><label>AI æœåŠ¡ç»ˆç«¯ç‚¹ (Endpoint URL)</label><input type="text" id="settingAiEndpoint" placeholder="å¦‚: https://api.openai.com/v1/chat/completions" /></div>
        <div class="setting-item"><label>AI API å¯†é’¥ (Key)</label><input type="password" id="settingAiApiKey" placeholder="è¾“å…¥æ‚¨çš„å¯†é’¥" /><small style="color:#666;">å¯†é’¥ä»…ä¿å­˜åœ¨æœ¬åœ°/äº‘ç«¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</small></div>
        <div class="setting-item"><label>AI æ¨¡å‹åç§°</label><input type="text" id="settingAiModel" placeholder="å¦‚: gpt-3.5-turbo" /><small style="color:#666;">ç”¨äºå¯¹è¯çš„æ¨¡å‹åç§°</small></div>
      </div>
      <div style="text-align:center;
margin-top:20px;">
        <button class="btn-settings" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        <button class="btn-clear" onclick="resetSettings()" style="margin-left:10px;">ğŸ”„ æ¢å¤é»˜è®¤</button>
      </div>
    </div>
  </div>

  <div id="extraModal" class="modal"><div class="modal-content"><h3>é¢å¤–è°ƒæ•´å·¥æ—¶</h3><p>å¯¹æ‰€é€‰æ—¥æœŸï¼Œåœ¨åŸæœ‰åŸºç¡€ä¸Šå¢åŠ æˆ–å‡å°‘å·¥æ—¶</p><div class="unit-selector"><label><input type="radio" name="unit" value="hour" checked /> å°æ—¶ï¼ˆå¦‚ 1.5ï¼‰</label><label><input type="radio" name="unit" value="minute" /> åˆ†é’Ÿï¼ˆå¦‚ -30ï¼‰</label></div><input type="number" id="extraInput" placeholder="è¾“å…¥æ•°å€¼ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰" step="any" /><div class="modal-buttons"><button onclick="applyExtra()">ç¡®å®š</button><button onclick="closeExtraModal()">å–æ¶ˆ</button></div></div></div>
  <div id="contextMenu" style="position:absolute;background:white;border:1px solid #ccc;border-radius:4px;box-shadow:2px 2px 6px rgba(0,0,0,0.2);z-index:2000;display:none;min-width:120px;"><div onclick="deleteSingleShift()" style="padding:8px 12px;cursor:pointer;">åˆ é™¤ç­æ¬¡</div></div>
  
  <div id="authModal" class="modal">
    <div class="modal-content">
        <h3 id="authModalTitle">èº«ä»½éªŒè¯</h3>
        <p id="authModalDesc">è¯·è¾“å…¥å¯†ç </p>
        <input type="password" id="authPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 100%; padding: 8px; margin: 10px 0;">
        <div class="modal-buttons">
            <button class="btn-small" onclick="handleAuthSubmit()">ç¡®å®š</button>
            <button class="btn-clear" onclick="document.getElementById('authModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
  </div>

  <div id="changePwdModal" class="modal">
    <div class="modal-content">
        <h3>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h3>
        <p>è¯·è¾“å…¥å½“å‰å¯†ç å’Œæ–°å¯†ç ã€‚</p>
        <input type="password" id="oldPassword" placeholder="å½“å‰å¯†ç " style="width: 100%; padding: 8px; margin: 10px 0;">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç " style="width: 100%; padding: 8px; margin: 10px 0;">
        <input type="password" id="confirmNewPassword" placeholder="ç¡®è®¤æ–°å¯†ç " style="width: 100%; padding: 8px; margin: 10px 0;">
        <div class="modal-buttons">
            <button class="btn-small" onclick="changePassword()">ç¡®å®šä¿®æ”¹</button>
            <button class="btn-clear" onclick="document.getElementById('changePwdModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
  </div>

  <script>
    // ============ Supabase é…ç½® ============
    const SUPABASE_URL = 'https://morkovixfwdsaknmwavj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcmtvdml4Zndkc2Frbm13YXZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MzM1NDIsImV4cCI6MjA3OTMwOTU0Mn0.wh-UEaQyr3bpJBQkCrzJpRR5v4NvRpx3LsnsAo-DGqE';

    // ============ æ ¸å¿ƒæ”¹è¿›ï¼šåŒæ­¥ç®¡ç†å™¨ ============
    let isInitialLoadComplete = false;
    // é¦–æ¬¡åŠ è½½/è¯»å–äº‘ç«¯æ•°æ®æ˜¯å¦å®Œæˆçš„æ ‡å¿—

    class SyncManager {
      constructor() {
        this.isSyncing = false;
        this.lastSyncTime = 0;
        this.minSyncInterval = 5000;
        this.pendingSync = false;
        this.pendingOptions = null;
        // ç”¨äºå­˜å‚¨ç­‰å¾…åŒæ­¥çš„æ¨¡å¼é€‰é¡¹
      }
      async sync(saveToStorageFn, options = { mode: 'auto' }) {
        if (this.isSyncing) {
          this.pendingSync = true;
          this.pendingOptions = options; // å­˜å‚¨é€‰é¡¹
          return;
        }
        const now = Date.now();
        if (now - this.lastSyncTime < this.minSyncInterval) {
          if (!this.pendingSync) {
            this.pendingSync = true;
            this.pendingOptions = options; // å­˜å‚¨é€‰é¡¹
            setTimeout(() => {
              this.pendingSync = false;
              this.sync(saveToStorageFn, this.pendingOptions || { mode: 'auto' });
              this.pendingOptions = null;
            }, this.minSyncInterval - (now - self.lastSyncTime));
          }
          return;
        }
        this.isSyncing = true;
        this.lastSyncTime = now;
        try {
          await saveToStorageFn(options);
        } finally {
          this.isSyncing = false;
          if (this.pendingSync) {
            this.pendingSync = false;
            setTimeout(() => this.sync(saveToStorageFn, this.pendingOptions || { mode: 'auto' }), 100);
            this.pendingOptions = null;
            // æ¸…ç†
          }
        }
      }
    }

    const syncManager = new SyncManager();
    // ============ æ•°æ®å­˜å‚¨ ============
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }
    
    // [ä¿®å¤ UTC åå·®] æœ¬åœ°æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
    function getLocalDateString(date) {
        // ä½¿ç”¨getFullYear/getMonth/getDateç­‰æ–¹æ³•ï¼Œè·å–çš„æ˜¯æœ¬åœ°æ—¶åŒºçš„å¹´/æœˆ/æ—¥
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // [æ–°å¢] æƒé™ç›¸å…³å˜é‡
    let isReadOnly = true; 
    let currentAuthMode = 'guest'; 

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
    }

    let shifts = {};
    let settings = {};
    let selectedMonth = '';
    let currentView = 'week';
    let multiSelectedDates = new Set();
    let rightClickedDate = '';
    let weekSummaries = [];
    let chartInstance = null;
    let isMultiSelectMode = false;
    let currentStatsSummary = {};
    document.getElementById('userIdDisplay').textContent = getUserId().substring(0, 8);
    document.getElementById('currentUserIdDisplay').textContent = getUserId().substring(0, 8); // æ–°å¢IDæ˜¾ç¤º

    // [æ–°å¢] ç®€å•çš„ SHA-256 å“ˆå¸Œå‡½æ•° (ç”¨äºå‰ç«¯å¯†ç åŠ å¯†)
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // [æ–°å¢] æ‰“å¼€ç™»å½•çª—å£
    function openLoginModal(mode) {
        let userIdInput = document.getElementById('loginUserId').value.trim();
        if (!userIdInput) {
            userIdInput = getUserId(); // ä½¿ç”¨é»˜è®¤ID
        }
        
        // æ›´æ–°å…¨å±€ localStorage çš„ ID
        localStorage.setItem('userId', userIdInput);
        document.getElementById('settingUserId').value = userIdInput; // åŒæ­¥æ›´æ–°è®¾ç½®é¢æ¿

        if (mode === 'guest') {
            // æŸ¥è¯¢æ¨¡å¼ä¸éœ€è¦è¾“å¯†ç 
            performLogin(userIdInput, 'guest', null);
        } else {
            // ç®¡ç†æ¨¡å¼éœ€è¦è¾“å¯†ç 
            currentAuthMode = 'owner';
            document.getElementById('authModalTitle').textContent = `ç®¡ç†å‘˜ç™»å½• (${userIdInput})`;
            document.getElementById('authModalDesc').textContent = 'è¯·è¾“å…¥å¯†ç ä»¥å¯ç”¨ç¼–è¾‘æƒé™';
            document.getElementById('authPassword').value = '';
            document.getElementById('authModal').style.display = 'flex';
        }
    }

    // [æ–°å¢] å¤„ç†å¯†ç æäº¤
    async function handleAuthSubmit() {
        const pwd = document.getElementById('authPassword').value;
        if (!pwd) { alert('å¯†ç ä¸èƒ½ä¸ºç©º'); return; }
        const userId = localStorage.getItem('userId');
        
        document.getElementById('authModal').style.display = 'none';
        await performLogin(userId, 'owner', pwd);
    }

    // [æ–°å¢] æ‰§è¡Œç™»å½•ä¸é‰´æƒé€»è¾‘ (æ ¸å¿ƒ)
    async function performLogin(userId, mode, password) {
        updateSyncStatus('syncing', 'â³ æ­£åœ¨éªŒè¯èº«ä»½...');
        
        try {
            // 1. ä»äº‘ç«¯æ‹‰å–è®¾ç½® (åŒ…å«å¯†ç å“ˆå¸Œ)
            const { data: settingsData, error } = await supabase
                .from('settings')
                .select('data')
                .eq('user_id', userId)
                .single();

            if (error && error.code !== 'PGRST116') throw error; // å¿½ç•¥æœªæ‰¾åˆ°æ•°æ®é”™è¯¯

            // 2. æƒé™åˆ¤æ–­
            if (mode === 'guest') {
                isReadOnly = true;
                // [ä¿®å¤ Request 2] å³ä½¿æ˜¯åªè¯»æ¨¡å¼ï¼Œåªè¦æˆåŠŸè¿æ¥åˆ°ç”¨æˆ·IDï¼Œå°±å…è®¸åŠ è½½å¹¶è®¾ç½®åˆå§‹åŠ è½½å®Œæˆæ ‡å¿—
                isInitialLoadComplete = true; 
                alert(`ğŸ” å·²è¿›å…¥æŸ¥è¯¢æ¨¡å¼ã€‚\næ‚¨å¯ä»¥æŸ¥çœ‹ [${userId}] çš„æ•°æ®ï¼Œä½†æ— æ³•ä¿®æ”¹æˆ–ä¸Šä¼ ã€‚`);
                await loadFromCloud(); // åŠ è½½æ•°æ®
                updateUIForAuth(userId, 'guest');
            } 
            else if (mode === 'owner') {
                const inputHash = await sha256(password);
                let isNewPasswordSet = false;
                
                // æƒ…å†µA: æ–°è´¦å·/è€æ•°æ®æ— å¯†ç  -> åˆå§‹åŒ–å¯†ç 
                if (!settingsData || !settingsData.data || !settingsData.data.auth_hash) {
                    if (confirm('æ£€æµ‹åˆ°è¯¥è´¦å·å°šæœªè®¾ç½®å¯†ç /æ˜¯æ–°è´¦å·ã€‚\n\næ˜¯å¦å°†å½“å‰è¾“å…¥çš„å¯†ç è®¾ç½®ä¸ºæ°¸ä¹…å¯†ç ï¼Ÿ')) {
                        settings.auth_hash = inputHash;
                        isReadOnly = false; 
                        isNewPasswordSet = true; // æ ‡è®°æ–°å¯†ç å·²è®¾ç½®

                        // ç«‹å³ä¸Šä¼ è®¾ç½®ä»¥é”å®šå¯†ç 
                        await saveToStorageSafe({ mode: 'force' });
                        alert('âœ… å¯†ç è®¾ç½®æˆåŠŸï¼æ‚¨å·²ç™»å½•ã€‚');
                        
                        // [ä¿®å¤ Request 2] ç¡®ä¿æ–°ç”¨æˆ·åœ¨è®¾ç½®å¯†ç åå¯ä»¥ä¸Šä¼ 
                        isInitialLoadComplete = true; 

                        await loadFromCloud(); // loadFromCloud ä¹Ÿä¼šè®¾ç½® isInitialLoadComplete = true
                        updateUIForAuth(userId, 'owner');
                    } else {
                        updateSyncStatus('warning', 'å¯†ç æœªè®¾ç½®ï¼Œä¿æŒåªè¯»æ¨¡å¼ã€‚');
                        isReadOnly = true;
                        updateUIForAuth(userId, 'guest');
                    }
                } 
                // æƒ…å†µB: å·²æœ‰å¯†ç  -> éªŒè¯
                else {
                    if (settingsData.data.auth_hash === inputHash) {
                        isReadOnly = false;
                        // [ä¿®å¤ Request 2] ç¡®ä¿è€ç”¨æˆ·åœ¨ç™»å½•åå¯ä»¥ä¸Šä¼ 
                        isInitialLoadComplete = true; 

                        updateSyncStatus('synced', 'ç™»å½•æˆåŠŸ');
                        await loadFromCloud();
                        updateUIForAuth(userId, 'owner');
                    } else {
                        alert('âŒ å¯†ç é”™è¯¯ï¼æ— æ³•è·å–ç¼–è¾‘æƒé™ï¼Œå·²è‡ªåŠ¨è¿›å…¥åªè¯»æ¨¡å¼ã€‚');
                        updateSyncStatus('error', 'å¯†ç é”™è¯¯');
                        isReadOnly = true; // ä¿æŒåªè¯»
                        updateUIForAuth(userId, 'guest');
                    }
                }
            }
        } catch (e) {
            console.error(e);
            alert('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            updateSyncStatus('error', 'éªŒè¯å¤±è´¥');
            isReadOnly = true;
        }
    }
    
    // [æ–°å¢] æ‰“å¼€ä¿®æ”¹å¯†ç å¼¹çª— (Request 1)
    function openChangePasswordModal() {
        if (isReadOnly) {
            alert('â›”ï¸ æƒé™ä¸è¶³ï¼šå½“å‰ä¸ºâ€œæŸ¥è¯¢æ¨¡å¼â€ï¼Œè¯·å…ˆä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ã€‚');
            return;
        }
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        document.getElementById('changePwdModal').style.display = 'flex';
    }

    // [æ–°å¢] ä¿®æ”¹å¯†ç é€»è¾‘ (Request 1)
    async function changePassword() {
        const oldPwd = document.getElementById('oldPassword').value;
        const newPwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('confirmNewPassword').value;

        if (!oldPwd || !newPwd || !confirmPwd) {
            alert('æ‰€æœ‰å¯†ç å­—æ®µéƒ½ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }
        if (newPwd !== confirmPwd) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
            return;
        }
        if (newPwd.length < 6) {
             alert('æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦6ä½ï¼');
            return;
        }
        
        try {
            const oldHash = await sha256(oldPwd);
            
            if (oldHash !== settings.auth_hash) {
                alert('âŒ å½“å‰å¯†ç é”™è¯¯ï¼');
                return;
            }

            const newHash = await sha256(newPwd);
            settings.auth_hash = newHash; // æ›´æ–°å¯†ç å“ˆå¸Œ
            
            await saveToStorageSafe({ mode: 'force' }); // å¼ºåˆ¶åŒæ­¥è®¾ç½®åˆ°äº‘ç«¯
            
            document.getElementById('changePwdModal').style.display = 'none';
            alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
        } catch (e) {
            console.error(e);
            alert('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
        }
    }


    // [æ–°å¢] æ›´æ–°ç•Œé¢æ˜¾ç¤º
    function updateUIForAuth(userId, mode) {
        document.getElementById('currentUserIdDisplay').textContent = userId;
        document.getElementById('userIdDisplay').textContent = userId; // æ›´æ–°åŸæ¥çš„IDæ˜¾ç¤º
        const badge = document.getElementById('accessModeBadge');
        
        if (mode === 'owner') {
            badge.textContent = 'ç®¡ç†å‘˜ (å¯ç¼–è¾‘)';
            badge.style.background = '#52c41a'; // ç»¿è‰²
            badge.style.color = 'white';
            // å¯ç”¨ä¸Šä¼ æŒ‰é’®
            document.querySelector('.btn-sync').disabled = false;
            document.querySelector('.btn-sync').style.opacity = '1';
        } else {
            badge.textContent = 'è®¿å®¢ (åªè¯»)';
            badge.style.background = '#faad14'; // é»„è‰²
            badge.style.color = 'white';
            // ç¦ç”¨ä¸Šä¼ æŒ‰é’®æ ·å¼
            document.querySelector('.btn-sync').disabled = true;
            document.querySelector('.btn-sync').style.opacity = '0.5';
        }
    }


    // æ ¸å¿ƒä¿å­˜å‡½æ•° (å·²å¢å¼ºé‡è¯•æœºåˆ¶å’ŒåŠ è½½çŠ¶æ€åˆ¤æ–­)
    async function saveToStorage(options = { mode: 'auto' }) {
      const userId = getUserId();
      
      // 1. æœ¬åœ°ä¿å­˜æ°¸è¿œå…è®¸ (LocalStorage)
      localStorage.setItem('shifts_local', JSON.stringify(shifts));
      localStorage.setItem('selectedMonth_local', selectedMonth);
      localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
      localStorage.setItem('userId', userId);
      
      // [ä¿®æ”¹] æƒé™æ‹¦æˆª
      if (isReadOnly && supabase) {
          if (options.mode === 'force' && !settings.auth_hash) {
              // å…è®¸æ–°ç”¨æˆ·è®¾ç½®å¯†ç æ—¶å¼ºåˆ¶ä¸Šä¼  settingsï¼Œå› ä¸ºæ­¤æ—¶ isReadOnly ä»å¯èƒ½ä¸º true
              // ä½†å¯¹äºä¸€èˆ¬çš„ force uploadï¼Œå¦‚æœåªæ˜¯æ™®é€šç”¨æˆ·ï¼Œåˆ™ç¦æ­¢
              if (options.mode === 'force' && !isInitialLoadComplete) {
                   // å…è®¸é¦–æ¬¡è®¾ç½®å¯†ç æ—¶ä¸Šä¼ 
              } else {
                  alert('â›”ï¸ æƒé™ä¸è¶³ï¼šå½“å‰ä¸ºâ€œæŸ¥è¯¢æ¨¡å¼â€ï¼Œæ— æ³•ä¸Šä¼ æ•°æ®ã€‚\nè¯·ä½¿ç”¨å¯†ç ç™»å½•ä»¥è·å–å†™å…¥æƒé™ã€‚');
                  updateSyncStatus('warning', 'åªè¯»æ¨¡å¼ (æœªä¸Šä¼ )');
                  return; // <--- å…³é”®ï¼šæ‹¦æˆª Supabase æ“ä½œ
              }
          } else if (options.mode !== 'force') {
              console.log('åªè¯»æ¨¡å¼ï¼šè·³è¿‡äº‘ç«¯è‡ªåŠ¨åŒæ­¥');
              return;
          }
      }


      // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯ï¼š
      //    - å¦‚æœæ˜¯æ‰‹åŠ¨ä¸Šä¼  (mode: 'force')
      //    - æˆ–è€…ï¼Œå¦‚æœæ˜¯è‡ªåŠ¨ä¸Šä¼  (mode: 'auto') ä¸”é¦–æ¬¡åŠ è½½å·²å®Œæˆ
      if (supabase && (options.mode === 'force' || isInitialLoadComplete)) {
        
        const maxRetries = 5;
        let attempt = 0;
        let success = false;
        let lastError = null;
        do {
            updateSyncStatus('syncing', `â³ åŒæ­¥ä¸­ (å°è¯• ${attempt + 1}/${maxRetries})...`);
            try {
                // 1. ç¡®å®šå½“å‰æœˆä»½çš„èŒƒå›´
                const [year, month] = selectedMonth.split('-').map(Number);
                const startOfMonth = `${selectedMonth}-01`;
                // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString
                const endOfMonth = getLocalDateString(new Date(year, month, 0)); 
                
                // 2. ç­›é€‰å‡ºå½“å‰æœˆä»½éœ€è¦ä¸Šä¼ çš„ shifts
                const shiftsToInsert = Object.entries(shifts)
                    .filter(([date, data]) => 
                        date >= startOfMonth && 
                        date <= endOfMonth 
                        && 
                        data?.type !== 'none' && 
                        (parseFloat(data?.hours) || 0) + (parseFloat(data?.extra) || 0) > 0 // ä»…ä¸Šä¼ æœ‰å·¥æ—¶çš„ç­æ¬¡
                    )
                    .map(([date, data]) => ({
                        user_id: userId, 
                        date: date, 
                        data: data, 
                        updated_at: new Date().toISOString() 
                    }));
                // 3. Upsert Settings
                const settingsPromise = supabase.from('settings').upsert({ 
                    user_id: userId, 
                    data: settings, 
                    updated_at: new Date().toISOString() 
                }).select(); 

                // 4. **å¼ºåˆ¶åˆ é™¤** è¯¥æœˆä»½å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è®°å½• (Delete by Range)
                const deletePromise = supabase.from('shifts')
                    .delete()
                    .eq('user_id', userId)
                    .gte('date', startOfMonth) 
                    .lte('date', endOfMonth);
                // 5. æ‰¹é‡æ’å…¥æ–°è®°å½• (Insert)
                let insertPromise;
                if (shiftsToInsert.length > 0) {
                    insertPromise = supabase.from('shifts').insert(shiftsToInsert).select();
                } else {
                    // å¦‚æœæ²¡æœ‰ç­æ¬¡è¦æ’å…¥ï¼Œä»ç„¶ç­‰å¾…åˆ é™¤æ“ä½œå®Œæˆ
                    insertPromise = Promise.resolve({ data: [], error: null });
                }

                // 6. ç»Ÿä¸€ç­‰å¾…å¹¶æ£€æŸ¥æ‰€æœ‰æ“ä½œ
                const [deleteResponse, insertResponse, settingsResponse] = await Promise.all([deletePromise, insertPromise, settingsPromise]);
                if (deleteResponse.error) {
                    // åˆ é™¤æ“ä½œçš„è­¦å‘Šä¸ä¸­æ–­åŒæ­¥ï¼Œä½†éœ€è®°å½•
                    console.warn(`äº‘ç«¯åˆ é™¤æ“ä½œé‡åˆ°è­¦å‘Šï¼ˆå°è¯• ${attempt + 1}ï¼‰:`, deleteResponse.error);
                }

                if (insertResponse.error) {
                    throw insertResponse.error;
                // æ’å…¥å¤±è´¥å¿…é¡»æŠ¥é”™
                }
                if (settingsResponse.error) {
                    throw settingsResponse.error;
                }

                success = true;
                // æˆåŠŸå®Œæˆæ‰€æœ‰æ“ä½œ
                
            } catch (error) {
                lastError = error;
                console.error(`äº‘ç«¯åŒæ­¥å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries}):`, error);
                attempt++;
                if (attempt < maxRetries) {
                    // ç®€å•æŒ‡æ•°é€€é¿
                    const delay = 200 * attempt;
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                }
            }
        } while (!success && attempt < maxRetries);
        if (success) {
            updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
        } else {
            // æ‰€æœ‰é‡è¯•å¤±è´¥ï¼Œæ˜¾ç¤ºæœ€ç»ˆé”™è¯¯
            const errorMessage = lastError.message ||
            String(lastError);
            updateSyncStatus('error', 'âœ— åŒæ­¥å¤±è´¥: ' + errorMessage.substring(0, 50) + '...');
        }
      } else if (options.mode === 'auto') {
          // åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œå¦‚æœé¦–æ¬¡åŠ è½½æœªå®Œæˆï¼Œåˆ™åªè¿›è¡Œæœ¬åœ°ä¿å­˜
          updateSyncStatus('warning', 'âš ï¸ ä»…ä¿å­˜åˆ°æœ¬åœ°ï¼Œè¯·å…ˆä»äº‘ç«¯åŠ è½½æˆ–æ‰‹åŠ¨ä¸Šä¼ ');
          console.log('Skipping cloud sync (auto mode) because initial load is not complete.');
      }
    }

    function saveToStorageSafe(options = { mode: 'auto' }) { // æ›´æ–°ç­¾å
      return syncManager.sync(saveToStorage, options);
    }

    async function loadFromCloud() {
      if (!supabase) { loadFromLocal(); return;
      }
      const userId = getUserId();
      updateSyncStatus('syncing', 'â³ åŠ è½½äº‘ç«¯æ•°æ®...');
      try {
        // ç¡®ä¿ load èƒ½å¤Ÿè·å–æ‰€æœ‰æ•°æ®
        const { data: shiftsData, error: shiftsError } = await supabase.from('shifts').select('date, data').eq('user_id', userId);
        if (shiftsError && shiftsError.code !== 'PGRST116') throw shiftsError; // å¿½ç•¥æœªæ‰¾åˆ°æ•°æ®é”™è¯¯
        const { data: settingsData, error: settingsError } = await supabase.from('settings').select('data').eq('user_id', userId).single();
        if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;
        
        if (shiftsData) {
          // åˆ›å»ºæ–°çš„ shifts å¯¹è±¡ï¼Œè¦†ç›–æœ¬åœ°æ•°æ®
          shifts = {};
          shiftsData.forEach(row => { shifts[row.date] = row.data; });
          localStorage.setItem('shifts_local', JSON.stringify(shifts));
        }
        
        if (settingsData?.data) {
          settings = { ...defaultSettings, ...settingsData.data };
          localStorage.setItem('shifts_settings_local', JSON.stringify(settings));
        }
        
        loadSettingsUI();
        isInitialLoadComplete = true; 
        updateSyncStatus('synced', 'âœ“ å·²åŒæ­¥');
        return true;
      } catch (e) {
        console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', e);
        updateSyncStatus('error', 'âœ— åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥');
        isInitialLoadComplete = false; 
        return false;
      }
    }

    function loadFromLocal() {
      shifts = JSON.parse(localStorage.getItem('shifts_local') || '{}');
      selectedMonth = localStorage.getItem('selectedMonth_local') || new Date().toISOString().slice(0, 7);
      settings = { ...defaultSettings, ...JSON.parse(localStorage.getItem('shifts_settings_local') || '{}') };
    }
    
    function updateSyncStatus(type, message) {
      const statusEl = document.getElementById('syncStatus');
      statusEl.className = 'sync-status ' + type;
      statusEl.textContent = message;
    }

    // æ–°å¢åŒæ­¥æŒ‰é’®é€»è¾‘
    async function forceLoad() {
      const success = await loadFromCloud();
      if (success) isInitialLoadComplete = true; // ç¡®ä¿æ‰‹åŠ¨åŠ è½½æˆåŠŸåè®¾ç½®æ ‡å¿—
      renderCalendar();
      if (document.getElementById('panel-stats').classList.contains('active')) {
        initDateRangeForStats(true);
      }
    }

    async function forceUpload() {
        if (isReadOnly) {
             updateSyncStatus('warning', 'â›”ï¸ åªè¯»æ¨¡å¼ï¼Œç¦æ­¢ä¸Šä¼ ã€‚');
             alert('â›”ï¸ æƒé™ä¸è¶³ï¼šå½“å‰ä¸ºâ€œæŸ¥è¯¢æ¨¡å¼â€ï¼Œæ— æ³•ä¸Šä¼ æ•°æ®ã€‚');
             return;
        }
      if (syncManager.isSyncing) {
        updateSyncStatus('warning', 'âš ï¸ æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...');
        return;
      }
      updateSyncStatus('syncing', 'â³ æ­£åœ¨ä¸Šä¼ ...'); // è°ƒç”¨ä¿å­˜å‡½æ•°ï¼Œå¼ºåˆ¶è¿›è¡Œäº‘ç«¯åŒæ­¥
      await saveToStorageSafe({ mode: 'force' });
      // å¼ºåˆ¶ä¸Šä¼ æ¨¡å¼
    }
    
    const defaultSettings = { bigMain: 7.4, bigNext: 3, small: 9.3, limit: 40, defaultView: 'week', aiEndpoint: 'https://api.openai.com/v1/chat/completions', aiApiKey: '', aiModel: 'gpt-3.5-turbo', auth_hash: '' };

    function switchTab(tab) {
      ['calendar', 'stats', 'chat', 'settings'].forEach(t => {
        document.getElementById(`panel-${t}`).classList.remove('active');
        document.getElementById(`tab-${t}`).classList.remove('active');
      });
      document.getElementById(`panel-${tab}`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'stats') {
        initDateRangeForStats(true);
      } else if (tab === 'chat') {
        initDateRangeForChat();
        AIAssistant.initSystemMessage();
        document.getElementById('chatHistory').scrollTop = document.getElementById('chatHistory').scrollHeight;
      } else if (tab === 'settings') {
        loadSettingsUI();
      }
    }
    
    function switchView(view) {
      currentView = view;
      document.getElementById('btn-week').classList.remove('active');
      document.getElementById('btn-cycle').classList.remove('active');
      document.getElementById(`btn-${view}`).classList.add('active');
      localStorage.setItem('defaultView_local', view);
      renderCalendar();
    }
    
    const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const cycleNames = ['ä¼‘æ¯', 'æ—¥1', 'æ—¥2', 'æ—¥3', 'æ—¥4', 'æ—¥5', 'æ—¥6'];

    function getDayName(date) {
      if (currentView === 'cycle') {
        // ç¡®ä¿ cycleStart å­˜åœ¨ä¸”æ˜¯æœ‰æ•ˆæ—¥æœŸ
        if (!settings.cycleStart) {
             // å¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä» 1970/1/1 å¼€å§‹
             settings.cycleStart = new Date(0).toISOString().split('T')[0];
        }
        const firstDayOfCycle = new Date(settings.cycleStart);
        const dayDiff = Math.floor((date.getTime() - firstDayOfCycle.getTime()) / (1000 * 60 * 60 * 24));
        const cycleIndex = (dayDiff % 6) + 1; // 1 to 6
        return `æ—¥${cycleIndex}`;
      }
      return dayNames[date.getDay()];
    }

    function getShiftDisplay(shiftData) {
      if (!shiftData || shiftData.type === 'none') return '';
      if (shiftData.type === 'auto-next') return `<span style="color:#1890ff;">${(parseFloat(shiftData.hours) || 0).toFixed(1)}h (æ¬¡æ—¥)</span>`;
      
      // [ä¿®å¤ Request 3] ç¡®ä¿ hours å’Œ extra æ˜¯æ•°å­—
      const baseHours = parseFloat(shiftData.hours) || 0;
      const extra = parseFloat(shiftData.extra) || 0;
      const total = baseHours + extra;
      
      let typeLabel = '';
      if (shiftData.type === 'big') typeLabel = 'å¤§å¤œ';
      else if (shiftData.type === 'small') typeLabel = 'å°å¤œ';
      else if (shiftData.type === 'custom') typeLabel = 'è‡ªå®šä¹‰';
      let html = `<span style="font-weight:bold;">${typeLabel}</span>`;
      html += `<div class="day-total">${total.toFixed(1)}h</div>`;
      if (extra !== 0) {
        html += `<div class="day-extra">(${extra > 0 ? '+' : ''}${extra.toFixed(1)}h)</div>`;
      }
      return html;
    }

    function getDailyHours(dateStr) {
      const shift = shifts[dateStr];
      if (!shift || shift.type === 'none') return 0;
      
      // [ä¿®å¤ Request 3] ç¡®ä¿ hours å’Œ extra æ˜¯æ•°å­—
      const hours = parseFloat(shift.hours) || 0;
      const extra = parseFloat(shift.extra) || 0;
      return hours + extra;
    }
    
    function exportData() {
      const data = { shifts, settings };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `shift_data_backup_${getLocalDateString(new Date())}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          // ä»…å¯¼å…¥ç­æ¬¡å’Œè®¾ç½®ï¼Œä¸è¦†ç›–å…¶ä»–å¦‚æœˆä»½
          shifts = { ...shifts, ...(importedData.shifts || {}) };
          settings = { ...settings, ...importedData.settings };
          // å¯¼å…¥åå¼ºåˆ¶åŒæ­¥
          await saveToStorageSafe({ mode: 'force' }); 
          document.getElementById('monthInput').value = selectedMonth;
          loadSettingsUI();
          renderCalendar();
          alert('âœ… æ•°æ®å¯¼å…¥å¹¶åŒæ­¥æˆåŠŸï¼');
        } catch (err) {
          console.error(err);
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function renderCalendar() {
      const monthInput = document.getElementById('monthInput').value;
      if (!monthInput) return;
      selectedMonth = monthInput;
      // åˆ‡æ¢æœˆä»½å’Œè§†å›¾æ—¶ï¼Œä»…æ›´æ–°æœ¬åœ°å­˜å‚¨ï¼Œä¸è‡ªåŠ¨è§¦å‘äº‘ç«¯åŒæ­¥
      localStorage.setItem('selectedMonth_local', selectedMonth);
      const year = parseInt(selectedMonth.split('-')[0]);
      const month = parseInt(selectedMonth.split('-')[1]) - 1;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';
      
      let cols = 7;
      let headersToDisplay = dayNames;
      
      if (currentView === 'cycle') {
        cols = 6;
        // ä½¿ç”¨å¾ªç¯æ—¥çš„åç§°ä½œä¸ºå¤´éƒ¨
        headersToDisplay = cycleNames.slice(1); // Exclude 'ä¼‘æ¯' (Rest)
      }
      
      // 1. æ¸²æŸ“æ—¥å†å¤´éƒ¨
      calendarEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      headersToDisplay.forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        calendarEl.appendChild(header);
      });
      
      // 2. å¡«å……ç©ºç™½
      if (currentView === 'week') {
        // æ ‡å‡†å‘¨å†ï¼šä»å‘¨æ—¥å¼€å§‹è®¡ç®—
        const firstDayOfWeek = firstDay.getDay(); // 0 (Sun) to 6 (Sat)
        for (let i = 0; i < firstDayOfWeek; i++) {
          calendarEl.appendChild(document.createElement('div'));
        }
      } 
      else if (currentView === 'cycle') {
        // 6å¤©å¾ªç¯å†ï¼šè®¡ç®—ç¬¬ä¸€ä¸ªæœˆæ—¥æœŸå¯¹åº”çš„å¾ªç¯æ—¥ç´¢å¼•
        if (!settings.cycleStart) { settings.cycleStart = new Date(0).toISOString().split('T')[0]; }
        const firstDayOfCycle = new Date(settings.cycleStart);
        const dayDiff = Math.floor((firstDay.getTime() - firstDayOfCycle.getTime()) / (1000 * 60 * 60 * 24));
        const startOffset = (dayDiff % 6); // 0 (Day 1) to 5 (Day 6)
        
        // å¡«å……å¼€å§‹åç§»çš„ç©ºç™½å•å…ƒæ ¼
        for (let i = 0; i < startOffset; i++) {
            calendarEl.appendChild(document.createElement('div'));
        }
      }

      let pressTimer;
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, month, i);
        // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString ç¡®ä¿æœ¬åœ°æ—¶åŒº
        const dateStr = getLocalDateString(date); 

        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.dataset.date = dateStr;
        
        const shiftData = shifts[dateStr];
        
        // [ä¿®å¤ Request 2] å§‹ç»ˆä½¿ç”¨æ—¥æœŸæ•°å­—ä½œä¸ºå•å…ƒæ ¼å¤´éƒ¨
        const dayNumber = i; 
        
        cell.innerHTML = `<div class="day-number">${dayNumber}</div>${getShiftDisplay(shiftData)}`;

        // å•å‡»äº‹ä»¶ï¼šå•é€‰æˆ–å¤šé€‰æ¨¡å¼ä¸‹çš„åˆ‡æ¢é€‰ä¸­
        cell.addEventListener('click', (e) => {
          clearTimeout(pressTimer);
          document.getElementById('contextMenu').style.display = 'none';
          if (isMultiSelectMode || e.ctrlKey || e.metaKey) {
            isMultiSelectMode = true; // ç¡®ä¿è¿›å…¥å¤šé€‰æ¨¡å¼
            toggleMultiSelect(dateStr, cell);
          } else {
            // å•é€‰æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»é€‰ä¸­å½“å‰æ—¥æœŸï¼Œå¹¶æ¸…é™¤å…¶ä»–é€‰ä¸­
            if (!multiSelectedDates.has(dateStr)) {
                clearSelected();
                toggleMultiSelect(dateStr, cell);
            } else {
                // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
                clearSelected();
            }
          }
          updateShiftInfo(true);
        });
        
        // é•¿æŒ‰/é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼šè¿›å…¥å¤šé€‰æ¨¡å¼
        cell.addEventListener('mousedown', (e) => {
            const dateStr = cell.dataset.date;
            if (e.button === 0 && !(e.ctrlKey || e.metaKey)) {
                pressTimer = setTimeout(() => {
                    isMultiSelectMode = true;
                    updateMultiSelectUI();
                    toggleMultiSelect(dateStr, cell);
                }, 500);
            }
        });
        
        cell.addEventListener('mouseup', () => clearTimeout(pressTimer));
        cell.addEventListener('mouseleave', () => clearTimeout(pressTimer));

        // å³é”®èœå•
        cell.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            rightClickedDate = dateStr;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        });

        updateCellClass(cell, dateStr);
        calendarEl.appendChild(cell);
      }

      document.addEventListener('click', () => {
        document.getElementById('contextMenu').style.display = 'none';
      });
      
      
      // [æ–°å¢ Request 1] è®¡ç®—æœ¬æœˆæ€»å·¥æ—¶
      let totalMonthHours = 0;
      let totalWorkDays = 0;
      for (let i = 1; i <= daysInMonth; i++) {
          const date = new Date(year, month, i);
          const dateStr = getLocalDateString(date);
          const hours = getDailyHours(dateStr);
          totalMonthHours += hours;
          if (hours > 0) totalWorkDays++;
      }
      document.getElementById('monthSummary').innerHTML = `
          <h3>æœ¬æœˆæ’ç­æ€»è§ˆ (${selectedMonth})</h3>
          <p style="font-size: 16px;">
              ğŸ—“ï¸ æ€»å¤©æ•°: ${daysInMonth} å¤© | 
              ğŸ› ï¸ **æ€»å·¥æ—¶:** <strong style="color: #1890ff;">${totalMonthHours.toFixed(1)} å°æ—¶</strong> | 
              ğŸ“… å·¥ä½œå¤©æ•°: ${totalWorkDays} å¤©
          </p>
      `;

      checkCompliance();
      updateShiftInfo(false);
      updateWeekSummary();
    }

    // NEW: Function to toggle the multi-select mode
    function toggleMultiSelectMode() {
      isMultiSelectMode = !isMultiSelectMode;
      updateMultiSelectUI();
    }

    function toggleMultiSelect(dateStr, cell) {
      if (multiSelectedDates.has(dateStr)) {
        multiSelectedDates.delete(dateStr);
        cell.classList.remove('multi-selected');
      } else {
        multiSelectedDates.add(dateStr);
        cell.classList.add('multi-selected');
      }
      updateMultiSelectUI();
    }

    function clearMultiSelectUI() {
      document.querySelectorAll('.day-cell.multi-selected').forEach(el => {
        el.classList.remove('multi-selected');
      });
    }

    function updateCellClass(cell, dateStr) {
      cell.classList.remove('selected-big', 'selected-small', 'custom', 'over-limit', 'multi-selected');
      const shift = shifts[dateStr];
      if (shift) {
        if (shift.type === 'big') cell.classList.add('selected-big');
        if (shift.type === 'small') cell.classList.add('selected-small');
        if (shift.type === 'custom') cell.classList.add('custom');
      }
      if (multiSelectedDates.has(dateStr)) {
        cell.classList.add('multi-selected');
      }
      // Compliance class is added in checkCompliance function
    }
    
    function updateMultiSelectUI() {
      const indicator = document.getElementById('selectionModeIndicator');
      const toggleBtn = document.getElementById('toggleMultiSelectBtn');
      if (isMultiSelectMode) {
        indicator.style.display = 'inline-block';
        toggleBtn.textContent = 'ğŸ–±ï¸ å…³é—­å¤šé€‰';
      } else {
        indicator.style.display = 'none';
        toggleBtn.textContent = 'ğŸ–±ï¸ å¼€å¯å¤šé€‰';
      }
    }

    function clearSelected() {
      clearMultiSelectUI();
      multiSelectedDates.clear();
      updateShiftInfo(false);
      isMultiSelectMode = false;
      updateMultiSelectUI();
    }

    function deleteSingleShift() {
        if (rightClickedDate && shifts[rightClickedDate]) {
            if (!confirm(`ç¡®å®šåˆ é™¤ ${rightClickedDate} çš„æ’ç­è®°å½•å—ï¼Ÿ`)) return;
            
            // 1. åˆ é™¤æ¬¡æ—¥ç­æ¬¡ (æœ¬åœ°)
            if (shifts[rightClickedDate].type === 'big') {
                const nextDay = new Date(rightClickedDate);
                nextDay.setDate(nextDay.getDate() + 1);
                // [ä¿®å¤ UTC åå·®]
                const nextDayStr = getLocalDateString(nextDay);
                if (shifts[nextDayStr]?.type === 'auto-next') {
                    delete shifts[nextDayStr];
                }
            }
            // 2. åˆ é™¤ä¸»ç­æ¬¡æœ¬åœ°è®°å½•
            delete shifts[rightClickedDate];
            
            // 3. è§¦å‘åŒæ­¥å’Œæ¸²æŸ“
            saveToStorageSafe({ mode: 'auto' }); 
            renderCalendar();
            document.getElementById('contextMenu').style.display = 'none';
        }
    }

    // ä¿®å¤ï¼šåº”ç”¨ç­æ¬¡æ—¶ï¼Œåªå¤„ç†æœ¬åœ°æ•°æ®ï¼Œç„¶ååŒæ­¥
    async function applyShiftToSelected(type) {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ');
        return;
      }
      
      const datesToApply = Array.from(multiSelectedDates);
      datesToApply.forEach(dateStr => {
        const shift = shifts[dateStr] || { type: 'none', hours: 0, extra: 0 };
        
        if (type === 'big') {
          // æ¸…é™¤æ¬¡æ—¥çš„ auto-nextï¼Œé¿å…æ—§çš„æ®‹ç•™
          const nextDay = new Date(dateStr);
          nextDay.setDate(nextDay.getDate() + 1);
          // [ä¿®å¤ UTC åå·®]
          const nextDayStr = getLocalDateString(nextDay);
          if (shifts[nextDayStr]?.type === 'auto-next') {
              delete shifts[nextDayStr];
          }
          
          shifts[dateStr] = { type: 'big', hours: settings.bigMain, extra: shift.extra || 0 };
          
          // è‡ªåŠ¨è®¾ç½®æ¬¡æ—¥ç­
          shifts[nextDayStr] = { type: 'auto-next', hours: settings.bigNext, extra: 0 };
        } else if (type === 'small') {
          // åˆ é™¤æ¬¡æ—¥çš„ auto-next
          const nextDay = new Date(dateStr);
          nextDay.setDate(nextDay.getDate() + 1);
          // [ä¿®å¤ UTC åå·®]
          const nextDayStr = getLocalDateString(nextDay);
          if (shifts[nextDayStr]?.type === 'auto-next') {
              delete shifts[nextDayStr];
          }
          
          shifts[dateStr] = { type: 'small', hours: settings.small, extra: shift.extra || 0 };
        }
      });
      await saveToStorageSafe({ mode: 'auto' }); // æ•°æ®å˜æ›´ï¼Œè§¦å‘åŒæ­¥
      renderCalendar();
      clearSelected();
    }

    // ä¿®å¤ï¼šåˆ é™¤æ‰€é€‰ç­æ¬¡æ—¶ï¼Œåªå¤„ç†æœ¬åœ°æ•°æ®ï¼Œç„¶ååŒæ­¥
    async function deleteSelected() {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ');
        return;
      }
      if (!confirm(`ç¡®å®šåˆ é™¤è¿™ ${multiSelectedDates.size} ä¸ªæ—¥æœŸçš„æ’ç­è®°å½•å—ï¼Ÿ`)) return;

      const datesToDelete = Array.from(multiSelectedDates);
      datesToDelete.forEach(dateStr => {
        // 1. åˆ é™¤æ¬¡æ—¥ç­æ¬¡ (æœ¬åœ°)
        if (shifts[dateStr]?.type === 'big') {
          const nextDay = new Date(dateStr);
          nextDay.setDate(nextDay.getDate() + 1);
          // [ä¿®å¤ UTC åå·®]
          const nextDayStr = getLocalDateString(nextDay);
          if (shifts[nextDayStr]?.type === 'auto-next') {
            delete shifts[nextDayStr];
          }
        }
        // 2. åˆ é™¤ä¸»ç­æ¬¡æœ¬åœ°è®°å½•
        delete shifts[dateStr];
      });

      // 3. è§¦å‘åŒæ­¥ã€‚æ–°é€»è¾‘ä¼šè‡ªåŠ¨åˆ é™¤äº‘ç«¯ä¸­å½“å‰æœˆä»½å†…è¢«åˆ é™¤çš„è®°å½•ã€‚
      await saveToStorageSafe({ mode: 'auto' }); // æ•°æ®å˜æ›´ï¼Œè§¦å‘åŒæ­¥
      renderCalendar();
      clearSelected();
    }

    function openExtraModal() {
      if (multiSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ—¥æœŸ');
        return;
      }
      document.getElementById('extraInput').value = '';
      document.getElementById('extraModal').style.display = 'flex';
    }

    function closeExtraModal() {
      document.getElementById('extraModal').style.display = 'none';
    }

    async function applyExtra() {
      const inputEl = document.getElementById('extraInput');
      const unit = document.querySelector('input[name="unit"]:checked').value;
      let value = parseFloat(inputEl.value);

      if (isNaN(value) || value === 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è°ƒæ•´æ•°å€¼ï¼ˆå¯ä¸ºè´Ÿæ•°ï¼‰');
        return;
      }

      if (unit === 'minute') {
        value = value / 60; // åˆ†é’Ÿè½¬å°æ—¶
      }

      const datesToApply = Array.from(multiSelectedDates);
      datesToApply.forEach(dateStr => {
        const shift = shifts[dateStr] || { type: 'custom', hours: 0, extra: 0 };
        
        // å¦‚æœæ˜¯ä¼‘æ¯æ—¥ï¼Œä½†åº”ç”¨äº†é¢å¤–è°ƒæ•´ï¼Œåˆ™è§†ä¸ºè‡ªå®šä¹‰ç­æ¬¡
        if (shift.type === 'none' || (parseFloat(shift.hours) || 0) === 0) {
            shift.type = 'custom';
            // ç¡®ä¿ shift.hours è¢«åˆå§‹åŒ–ä¸ºæ•°å­— 0ï¼Œé˜²æ­¢ NaN 
            if (isNaN(shift.hours)) shift.hours = 0;
        }
        
        // æ›´æ–°é¢å¤–å·¥æ—¶ï¼Œå¹¶ç¡®ä¿ extra å­—æ®µæ˜¯æ•°å­—
        shift.extra = (parseFloat(shift.extra) || 0) + value;
        
        // å¦‚æœè°ƒæ•´åé¢å¤–å·¥æ—¶ä¸º0ï¼Œåˆ™æ¸…é™¤extraå­—æ®µ
        if (Math.abs(shift.extra) < 0.01) {
            delete shift.extra;
        }

        // å¦‚æœè°ƒæ•´åå·¥æ—¶å’Œé¢å¤–å·¥æ—¶éƒ½ä¸º0ï¼Œåˆ™åˆ é™¤ç­æ¬¡
        if ((parseFloat(shift.hours) || 0) + (parseFloat(shift.extra) || 0) === 0) {
            delete shifts[dateStr];
        } else {
            shifts[dateStr] = shift;
        }
      });
      
      closeExtraModal();
      await saveToStorageSafe({ mode: 'auto' });
      renderCalendar();
      clearSelected();
    }

    // ============ åˆè§„æ€§æ£€æŸ¥ ============
    function getFirstDayOfMonth() {
        const [year, month] = selectedMonth.split('-').map(Number);
        return new Date(year, month - 1, 1);
    }
    
    function getLastDayOfMonth() {
        const [year, month] = selectedMonth.split('-').map(Number);
        return new Date(year, month, 0); // month + 1, 0 is the last day of the previous month
    }
    
    function generateAllRelevant7DayWindows() {
      const firstDayOfMonth = getFirstDayOfMonth();
      const lastDayOfMonth = getLastDayOfMonth();
      const windows = [];
      
      const start = new Date(firstDayOfMonth);
      start.setDate(start.getDate() - 6);
      
      const end = lastDayOfMonth;
      let current = new Date(start);
      
      // æ£€æŸ¥èŒƒå›´ï¼šä»æœ¬æœˆ1å·å¾€å‰æ¨6å¤©å¼€å§‹ï¼Œç›´åˆ°æœ¬æœˆæœ€åä¸€å¤©
      while (current <= end) {
        const windowEnd = new Date(current);
        windowEnd.setDate(windowEnd.getDate() + 6);
        
        // 7th day is windowEnd
        if (windowEnd >= firstDayOfMonth) {
          windows.push({ start: new Date(current), end: windowEnd });
        }
        current.setDate(current.getDate() + 1);
      }
      return windows;
    }

    function checkCompliance() {
      const windows = generateAllRelevant7DayWindows();
      weekSummaries = [];
      
      const overLimitDates = new Set();
      const limit = settings.limit;
      
      windows.forEach(w => {
        let total = 0;
        const datesInRange = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(w.start);
          d.setDate(d.getDate() + i);
          // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString 
          const iso = getLocalDateString(d); 
          datesInRange.push(iso);
          total += getDailyHours(iso);
        }
        
        const violation = total > limit;
        weekSummaries.push({
          // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString 
          start: getLocalDateString(w.start),
          // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString 
          end: getLocalDateString(w.end),
          total: total,
          dates: datesInRange,
          violation: violation
        });
        
        if (violation) {
          // Only mark dates within the current month as over-limit on the UI
          datesInRange.forEach(d => {
            if (d.startsWith(selectedMonth)) overLimitDates.add(d);
          });
        }
      });
      
      document.querySelectorAll('.day-cell').forEach(cell => {
        const dateStr = cell.dataset.date;
        if (dateStr && overLimitDates.has(dateStr)) cell.classList.add('over-limit');
        else cell.classList.remove('over-limit');
      });
      
      updateWeekSummary();
    }
    
    function updateWeekSummary() {
      const listEl = document.getElementById('weekList');
      const violations = weekSummaries.filter(w => w.violation && w.end.startsWith(selectedMonth));
      
      let html = '';
      if (violations.length === 0) {
        html = `<p class="result ok">ğŸ‰ åˆè§„æ£€æŸ¥é€šè¿‡ï¼å½“å‰æœˆä»½æ²¡æœ‰æ£€æµ‹åˆ°è¿ç»­7å¤©å·¥æ—¶è¶…è¿‡ ${settings.limit} å°æ—¶çš„è½®æ¬¡ã€‚</p>`;
      } else {
        html = `<p class="result warn">âš ï¸ è­¦å‘Šï¼å½“å‰æœˆä»½æ£€æµ‹åˆ° ${violations.length} æ¬¡è¶…é™è½®æ¬¡ï¼š</p>`;
        violations.forEach(w => {
          html += `<div class="week-item violation">ä» ${w.start} åˆ° ${w.end}ï¼šæ€»å·¥æ—¶ ${w.total.toFixed(1)}h (è¶…é™ ${(w.total - settings.limit).toFixed(1)}h)</div>`;
        });
      }
      
      const allListHtml = weekSummaries.filter(w => w.end.startsWith(selectedMonth)).map(w => {
          const cls = w.violation ? 'violation' : '';
          return `<div class="week-item ${cls}">ä» ${w.start} åˆ° ${w.end}ï¼šæ€»å·¥æ—¶ ${w.total.toFixed(1)}h</div>`;
      }).join('');
      
      listEl.innerHTML = html + `<h4 style="margin-top: 15px;">æ‰€æœ‰è½®æ¬¡ï¼š</h4>` + allListHtml;
    }

    // ============ UI/Helper Functions ============
    function updateShiftInfo(isClicked = true) {
      const infoEl = document.getElementById('shiftInfo');
      let html = '';

      if (multiSelectedDates.size > 0) {
        let selectionTotalHours = 0;
        let shiftsCount = { big: 0, small: 0, custom: 0, none: 0 };
        let detailedList = [];
        
        const sortedDates = Array.from(multiSelectedDates).sort();
        
        sortedDates.forEach(dateStr => {
          const shift = shifts[dateStr];
          const hours = getDailyHours(dateStr);
          selectionTotalHours += hours;
          
          let type = 'none';
          if (shift) {
              type = shift.type;
              if (shift.type === 'auto-next') type = 'none'; // auto-next ä¸è®¡å…¥ä¸»ç­æ¬¡ç±»å‹
          }
          
          shiftsCount[type] = (shiftsCount[type] || 0) + 1;

          let shiftDetails;
          if (shift && shift.type !== 'none') {
            const base = (parseFloat(shift.hours) || 0).toFixed(1);
            const extra = (parseFloat(shift.extra) || 0).toFixed(1);
            shiftDetails = `æ€»å·¥æ—¶: ${hours.toFixed(1)}h (åŸºç¡€: ${base}h, é¢å¤–: ${extra}h)`;
          } else {
            shiftDetails = 'æ— ç­æ¬¡';
          }
          
          detailedList.push(`<li>${dateStr} (${type === 'big' ? 'å¤§å¤œ' : type === 'small' ? 'å°å¤œ' : type === 'custom' ? 'è‡ªå®šä¹‰' : 'ä¼‘æ¯'}): ${shiftDetails}</li>`);
        });

        html += `
          <hr style="margin-top: 10px; margin-bottom: 10px;">
          <h3>å·²é€‰æ‹© ${multiSelectedDates.size} ä¸ªæ—¥æœŸ</h3>
          <p><strong>ç´¯è®¡æ€»å·¥æ—¶: ${selectionTotalHours.toFixed(1)} å°æ—¶</strong></p>
          <p style="font-size: 14px;">
            å¤§å¤œç­: ${shiftsCount.big} æ¬¡, å°å¤œç­: ${shiftsCount.small} æ¬¡, è‡ªå®šä¹‰: ${shiftsCount.custom} æ¬¡, ä¼‘æ¯æ—¥: ${shiftsCount.none} å¤©
          </p>
          <h4 style="margin-top: 10px;">é€‰æ‹©æ—¥æœŸæ˜ç»†:</h4>
          <ul style="max-height: 150px; overflow-y: auto; list-style-type: none; padding-left: 0; font-size: 12px;">
            ${detailedList.join('')}
          </ul>
        `;
      } else if (multiSelectedDates.size === 0 && isClicked) {
        html += '<p style="margin-top: 10px;">è¯·ç‚¹å‡»ï¼ˆæˆ– Ctrl/Cmd+ç‚¹å‡»ï¼‰æ—¥æœŸä»¥é€‰æ‹©æ’ç­æ—¥æœŸï¼Œç„¶åä½¿ç”¨ä¸Šæ–¹æŒ‰é’®è®¾ç½®ç­æ¬¡ã€‚</p>';
      } else if (weekSummaries.length > 0) {
        const violations = weekSummaries.filter(w => w.violation && w.end.startsWith(selectedMonth));
        if (violations.length > 0) {
          html = `<p class="result warn">âš ï¸ å½“å‰æœˆä»½æœ‰ ${violations.length} æ¬¡è¿ç»­7å¤©å·¥æ—¶è¶…é™ã€‚</p>`;
        } else {
          html = `<p class="result ok">ğŸ‰ æœ¬æœˆæ— å·¥æ—¶è¶…é™è®°å½•ã€‚</p>`;
        }
      }

      infoEl.innerHTML = html;
    }

    function initDateRangeForStats(forceRender = false) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      const startDateEl = document.getElementById('statStartDate');
      const endDateEl = document.getElementById('statEndDate');
      
      // è®¾ç½®é»˜è®¤èŒƒå›´ä¸ºå½“æœˆ
      if (!startDateEl.value || forceRender) {
          startDateEl.value = getLocalDateString(firstDay);
      }
      if (!endDateEl.value || forceRender) {
          endDateEl.value = getLocalDateString(today);
      }
      
      if (forceRender) renderStatsWithRange();
    }
    
    function getDetailedShifts(startInput, endInput) {
        const detailedShifts = [];
        let currentDate = new Date(startInput);
        const endDate = new Date(endInput);

        while (currentDate <= endDate) {
            // [ä¿®å¤ UTC åå·®] ç¡®ä¿æ—¥æœŸå­—ç¬¦ä¸²æ­£ç¡®
            const dateStr = getLocalDateString(currentDate);
            const shift = shifts[dateStr] || { type: 'none', hours: 0, extra: 0 };
            const totalHours = getDailyHours(dateStr);
            
            // æ’é™¤ auto-next ç­æ¬¡ï¼Œä½†å°†å…¶å·¥æ—¶è®¡å…¥å‰ä¸€å¤©çš„æ€»å·¥æ—¶ã€‚
            // è¿™é‡Œçš„ç›®çš„æ˜¯ä¸ºç»Ÿè®¡åˆ†æå‡†å¤‡ "æ¯æ—¥" æ€»å·¥æ—¶ã€‚
            if (shift.type !== 'auto-next') {
                detailedShifts.push({
                    date: dateStr,
                    shiftType: shift.type,
                    totalHours: totalHours,
                    raw: shift // ä¿ç•™åŸå§‹æ•°æ®
                });
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }
        return detailedShifts;
    }


    function generateAnalysisData() {
        const startInput = document.getElementById('statStartDate').value;
        const endInput = document.getElementById('statEndDate').value;
        
        let totalHours = 0;
        let totalWorkDays = 0;
        let bigCount = 0;
        let smallCount = 0;
        let customCount = 0;
        let workedDates = [];
        let detailedShiftsText = '';

        const detailedShifts = getDetailedShifts(startInput, endInput);

        detailedShifts.forEach(s => {
            if (s.totalHours > 0) {
                totalWorkDays++;
                totalHours += s.totalHours;
                workedDates.push(new Date(s.date).getTime());
                detailedShiftsText += `${s.date}: ${s.shiftType === 'big' ? 'å¤§å¤œç­' : s.shiftType === 'small' ? 'å°å¤œç­' : 'è‡ªå®šä¹‰'} ${s.totalHours.toFixed(1)}h\n`;
            }
            if (s.shiftType === 'big') bigCount++;
            else if (s.shiftType === 'small') smallCount++;
            else if (s.shiftType === 'custom') customCount++;
        });

        let maxConsecutive = 0;
        let currentConsecutive = 0;
        workedDates.sort();

        for (let i = 0; i < workedDates.length; i++) {
            if (i === 0) {
                currentConsecutive = 1;
            } else {
                const dayBefore = new Date(workedDates[i - 1]);
                dayBefore.setDate(dayBefore.getDate() + 1);
                const currentDay = new Date(workedDates[i]);
                
                // [ä¿®å¤ UTC åå·®] ä½¿ç”¨ getLocalDateString
                if (getLocalDateString(dayBefore) === getLocalDateString(currentDay)) {
                    currentConsecutive++;
                } else {
                    currentConsecutive = 1;
                }
            }
            maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
        }

        let complianceViolations = 0;
        const totalDays = Math.ceil((new Date(endInput).getTime() - new Date(startInput).getTime()) / (1000 * 60 * 60 * 24)) + 1;
        
        // é‡æ–°è¿è¡Œåˆè§„æ£€æŸ¥ä»¥è·å¾—æŒ‡å®šèŒƒå›´å†…çš„è¿è§„æ¬¡æ•°
        const originalSelectedMonth = selectedMonth;
        selectedMonth = startInput.slice(0, 7); // ä¸´æ—¶åˆ‡æ¢æœˆä»½ä»¥è·å–åˆè§„æ•°æ®
        checkCompliance(); // è¿è¡Œæ£€æŸ¥
        selectedMonth = originalSelectedMonth; // æ¢å¤æœˆä»½

        const violationCount = weekSummaries.filter(w => w.violation && w.end >= startInput && w.start <= endInput).length;
        
        currentStatsSummary = {
            dateRange: `${startInput} è‡³ ${endInput}`,
            totalDays: totalDays,
            totalHours: totalHours,
            totalWorkDays: totalWorkDays,
            averageDailyHours: totalWorkDays > 0 ? totalHours / totalWorkDays : 0,
            averageDailyWorkDays: totalWorkDays > 0 ? totalWorkDays / totalDays * 100 : 0,
            bigCount: bigCount,
            smallCount: smallCount,
            customCount: customCount,
            maxConsecutive: maxConsecutive,
            violationCount: violationCount,
            detailedShiftsText: detailedShiftsText
        };
        
        return currentStatsSummary;
    }

    function getMonthsInRange(start, end) {
        const startYear = start.getFullYear();
        const startMonth = start.getMonth();
        const endYear = end.getFullYear();
        const endMonth = end.getMonth();

        const months = [];
        let currentYear = startYear;
        let currentMonth = startMonth;

        while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
            const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            months.push(monthStr);

            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
        }
        return months;
    }

    function renderStatsWithRange() {
        const summary = generateAnalysisData();
        const aiResultStatusEl = document.getElementById('aiSummaryResultStatus');

        const statsArray = [
            { label: 'æ—¥æœŸèŒƒå›´', value: summary.dateRange },
            { label: 'æ€»å¤©æ•°', value: `${summary.totalDays} å¤©` },
            { label: 'æ€»å·¥æ—¶', value: `${summary.totalHours.toFixed(1)} h` },
            { label: 'æ€»å·¥ä½œå¤©æ•°', value: `${summary.totalWorkDays} å¤©` },
            { label: 'æ—¥å‡å·¥ä½œæ—¶é•¿', value: `${summary.averageDailyHours.toFixed(1)} h` },
            { label: 'å·¥ä½œæ—¥å æ¯”', value: `${summary.averageDailyWorkDays.toFixed(1)} %` },
            { label: 'å¤§å¤œç­æ¬¡æ•°', value: `${summary.bigCount} æ¬¡` },
            { label: 'å°å¤œç­æ¬¡æ•°', value: `${summary.smallCount} æ¬¡` },
            { label: 'è‡ªå®šä¹‰/é¢å¤–ç­æ¬¡', value: `${summary.customCount} æ¬¡` },
            { label: 'æœ€é•¿è¿ç»­å·¥ä½œ', value: `${summary.maxConsecutive} å¤©` },
            { label: `è¿ç»­7å¤©è¶…é™æ¬¡æ•° (é™${settings.limit}h)`, value: `${summary.violationCount} æ¬¡`, isViolation: summary.violationCount > 0 },
        ];

        let html = '';
        statsArray.forEach(stat => {
            const cls = stat.isViolation ? 'warn' : '';
            html += `<div class="stat-item ${cls}"><label>${stat.label}</label><div class="stat-value">${stat.value}</div></div>`;
        });
        document.getElementById('statsGrid').innerHTML = html;

        const start = new Date(document.getElementById('statStartDate').value);
        const end = new Date(document.getElementById('statEndDate').value);
        const allMonths = getMonthsInRange(start, end);

        renderMonthlyHoursChart(allMonths, start.toISOString().split('T')[0], end.toISOString().split('T')[0]);
        aiResultStatusEl.textContent = 'âœ… æ•°æ®åˆ†æå·²å®Œæˆã€‚ç‚¹å‡» "å¯åŠ¨ AI æ€»ç»“" æŒ‰é’®å¼€å§‹å¯¹è¯ã€‚';
        resetPanelChat('stats', aiResultStatusEl.textContent);
    }

    function renderMonthlyHoursChart(months, start, end) {
        if (chartInstance) chartInstance.destroy();
        const chartEl = document.getElementById('monthlyChart');
        if (!chartEl) return;
        
        const chartDataPoints = [];
        
        months.forEach(monthStr => {
            let monthTotalHours = 0;
            let monthWorkDays = 0;
            const [year, monthIndex] = monthStr.split('-').map(Number);
            // new Date(y, m, 0) is the last day of month m-1
            const lastDay = new Date(year, monthIndex, 0).getDate(); 
            
            for (let i = 1; i <= lastDay; i++) {
                const date = new Date(year, monthIndex - 1, i);
                // [ä¿®å¤ UTC åå·®]
                const dateStr = getLocalDateString(date);
                
                if (dateStr >= start && dateStr <= end) {
                    const hours = getDailyHours(dateStr);
                    if (hours > 0) monthWorkDays++;
                    monthTotalHours += hours;
                }
            }
            
            chartDataPoints.push({
                month: monthStr,
                totalHours: monthTotalHours,
                workDays: monthWorkDays
            });
        });

        const ctx = chartEl.getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDataPoints.map(p => p.month),
                datasets: [
                    {
                        label: 'æœˆæ€»å·¥æ—¶ (å°æ—¶)',
                        data: chartDataPoints.map(p => p.totalHours.toFixed(1)),
                        backgroundColor: 'rgba(25, 137, 250, 0.7)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'æœˆå·¥ä½œå¤©æ•° (å¤©)',
                        data: chartDataPoints.map(p => p.workDays),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.3)',
                        type: 'line',
                        yAxisID: 'y1',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'æ€»å·¥æ—¶ (h)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'å·¥ä½œå¤©æ•° (å¤©)' },
                        min: 0,
                        max: Math.max(...chartDataPoints.map(p => p.workDays), 10) + 2
                    }
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
    }

    function loadSettingsUI() {
      // Load values into UI elements
      document.getElementById('settingBigMain').value = settings.bigMain || defaultSettings.bigMain;
      document.getElementById('settingBigNext').value = settings.bigNext || defaultSettings.bigNext;
      document.getElementById('settingSmall').value = settings.small || defaultSettings.small;
      document.getElementById('settingLimit').value = settings.limit || defaultSettings.limit;
      document.getElementById('settingDefaultView').value = settings.defaultView || defaultSettings.defaultView;
      document.getElementById('settingUserId').value = getUserId();
      
      document.getElementById('settingAiEndpoint').value = settings.aiEndpoint || defaultSettings.aiEndpoint;
      document.getElementById('settingAiApiKey').value = settings.aiApiKey || defaultSettings.aiApiKey;
      document.getElementById('settingAiModel').value = settings.aiModel || defaultSettings.aiModel;
      
      // Update global currentView
      currentView = settings.defaultView || 'week';
      switchView(currentView);
    }
    
    async function saveSettings() {
      // Read values from UI and update settings object
      settings.bigMain = parseFloat(document.getElementById('settingBigMain').value) || defaultSettings.bigMain;
      settings.bigNext = parseFloat(document.getElementById('settingBigNext').value) || defaultSettings.bigNext;
      settings.small = parseFloat(document.getElementById('settingSmall').value) || defaultSettings.small;
      settings.limit = parseFloat(document.getElementById('settingLimit').value) || defaultSettings.limit;
      settings.defaultView = document.getElementById('settingDefaultView').value || defaultSettings.defaultView;
      // Note: UserId is primarily managed via localStorage and auth logic, setting it here mostly updates the UI
      localStorage.setItem('userId', document.getElementById('settingUserId').value);
      
      settings.aiEndpoint = document.getElementById('settingAiEndpoint').value || defaultSettings.aiEndpoint;
      settings.aiApiKey = document.getElementById('settingAiApiKey').value || defaultSettings.aiApiKey;
      settings.aiModel = document.getElementById('settingAiModel').value || defaultSettings.aiModel;

      // Force save all settings to sync the password hash if it was set during login
      await saveToStorageSafe({ mode: 'force' }); 
      
      currentView = settings.defaultView;
      switchView(currentView);
      renderCalendar();
      alert('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ã€‚');
    }

    async function resetSettings() {
      if (!confirm('ç¡®å®šè¦æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿè¿™å°†è¦†ç›–äº‘ç«¯è®¾ç½®ï¼')) return;
      settings = { ...defaultSettings };
      // Keep existing auth hash if it exists
      const currentHash = JSON.parse(localStorage.getItem('shifts_settings_local') || '{}').auth_hash;
      if (currentHash) {
          settings.auth_hash = currentHash;
      }
      loadSettingsUI();
      await saveToStorageSafe({ mode: 'force' });
      renderCalendar();
      alert('âœ… è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼å¹¶åŒæ­¥åˆ°äº‘ç«¯ã€‚');
    }

    // ============ AI åŠ©æ‰‹æ ¸å¿ƒé€»è¾‘ ============
    // Panel Chat History Management
    let panelChatHistory = {
        calendar: [],
        stats: []
    };
    let panelContexts = {
        calendar: { system: '', data: '' },
        stats: { system: '' , data: '' }
    };
    let isPanelTyping = { calendar: false, stats: false };
    
    function getPanelChatElements(panelId) {
        return {
            inputEl: document.getElementById(`${panelId}ChatInput`),
            inputContainerEl: document.getElementById(`${panelId}ChatInputContainer`),
            statusEl: document.getElementById(panelId === 'calendar' ? 'complianceAdviceStatus' : 'aiSummaryResultStatus'),
            historyEl: document.getElementById(`${panelId}ChatHistory`),
            sendBtn: document.getElementById(`${panelId}ChatInputContainer`).querySelector('button')
        };
    }
    
    function displayPanelMessage(panelId, role, content, save = true) {
        const historyEl = document.getElementById(`${panelId}ChatHistory`);
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message chat-${role}`;
        
        // è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç å—å’Œæ¢è¡Œ
        const formattedContent = content
            .replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            })
            .replace(/\n/g, '<br>');
            
        msgDiv.innerHTML = formattedContent;
        historyEl.appendChild(msgDiv);
        historyEl.scrollTop = historyEl.scrollHeight;
        
        if (save && role !== 'system') {
            panelChatHistory[panelId].push({ role, content });
        }
    }

    function resetPanelChat(panelId, initialMessage = 'å¯¹è¯å·²é‡ç½®ã€‚è¯·ç»§ç»­æé—®ã€‚') {
        panelChatHistory[panelId] = [];
        const { historyEl, inputContainerEl, statusEl } = getPanelChatElements(panelId);
        if (historyEl) { 
            historyEl.innerHTML = ''; 
            historyEl.classList.remove('visible'); // ç§»é™¤ visible ç±»
        }
        if (statusEl) { 
            statusEl.style.display = 'block';
            if (initialMessage) statusEl.textContent = initialMessage;
        }
        if (inputContainerEl) inputContainerEl.style.display = 'none';
    }

    // å°†ç³»ç»Ÿæ¶ˆæ¯å’Œä¸Šä¸‹æ–‡æ•°æ®åˆå¹¶æˆä¸€ä¸ª system æ¶ˆæ¯
    async function sendPanelChatMessage(panelId, initialPrompt = null) {
        const { inputEl, inputContainerEl, statusEl, historyEl, sendBtn } = getPanelChatElements(panelId);
        const userMessage = initialPrompt || inputEl.value.trim();
        if (!userMessage && !initialPrompt) return;
        if (isPanelTyping[panelId]) return;
        
        if (!settings.aiEndpoint || !settings.aiApiKey) {
            displayPanelMessage(panelId, 'assistant', 'âŒ é”™è¯¯ï¼šè¯·åœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æœåŠ¡ç»ˆç«¯ç‚¹å’Œ API å¯†é’¥ã€‚', false);
            return;
        }

        if (statusEl) statusEl.style.display = 'none';
        historyEl.classList.add('visible'); // ç¡®ä¿å¯è§ä¸”å‚ç›´
        inputContainerEl.style.display = 'flex';
        
        if (!initialPrompt) {
            displayPanelMessage(panelId, 'user', userMessage);
            inputEl.value = '';
            inputEl.style.height = 'auto';
        }
        
        isPanelTyping[panelId] = true;
        inputEl.disabled = true;
        sendBtn.disabled = true;

        // ä¿®å¤ï¼šåˆå¹¶ç³»ç»Ÿæç¤ºå’Œä¸Šä¸‹æ–‡æ•°æ®
        const combinedSystemContent = `${panelContexts[panelId].system}\n\nã€æ’ç­æ•°æ®/èƒŒæ™¯ä¿¡æ¯ã€‘\n${panelContexts[panelId].data}`;
        const combinedSystemMessage = { role: 'system', content: combinedSystemContent };
        
        const userPromptMessage = { role: 'user', content: userMessage };
        
        // æ„é€  API è¯·æ±‚çš„ messages æ•°ç»„ï¼š[åˆå¹¶çš„System, ...å†å²è®°å½•, UserPrompt]
        let messages = [combinedSystemMessage, ...panelChatHistory[panelId].filter(m => m.role !== 'system'), userPromptMessage];

        const aiMessageEl = document.createElement('div');
        aiMessageEl.className = 'chat-message chat-ai';
        aiMessageEl.innerHTML = 'AI æ­£åœ¨æ€è€ƒ...';
        historyEl.appendChild(aiMessageEl);
        historyEl.scrollTop = historyEl.scrollHeight;

        try {
            const fullResponse = await runChatCompletion(messages, true, (chunk) => {
                // æµå¼æ›´æ–°
                let currentContent = aiMessageEl.textContent === 'AI æ­£åœ¨æ€è€ƒ...' ? '' : aiMessageEl.textContent;
                currentContent += chunk;
                // ç®€å•çš„é˜²ä»£ç å—æ ¼å¼é”™è¯¯å¤„ç†ï¼Œåªå¤„ç†æ¢è¡Œ
                aiMessageEl.innerHTML = currentContent.replace(/\n/g, '<br>');
                historyEl.scrollTop = historyEl.scrollHeight;
            });
            
            // æœ€ç»ˆæ ¼å¼åŒ–å¹¶ä¿å­˜
            const finalFormattedContent = fullResponse
                .replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => {
                    return `<pre><code>${code.trim()}</code></pre>`;
                })
                .replace(/\n/g, '<br>');
                
            aiMessageEl.innerHTML = finalFormattedContent;
            displayPanelMessage(panelId, 'assistant', fullResponse, true); // ç¡®ä¿ä¿å­˜å®Œæ•´æ–‡æœ¬
        } catch (e) {
            const errorMsg = `âŒ AI åŠ©æ‰‹å¤±è´¥ï¼š${e.message || 'æœªçŸ¥é”™è¯¯'}`;
            aiMessageEl.innerHTML = errorMsg;
            aiMessageEl.style.color = 'red';
        } finally {
            isPanelTyping[panelId] = false;
            inputEl.disabled = false;
            sendBtn.disabled = false;
            // ç¡®ä¿è¾“å…¥æ¡†å›åˆ°ä¸€è¡Œ
            inputEl.style.height = 'auto';
        }
    }
    
    function handlePanelChatInput(event, panelId) {
        const inputEl = document.getElementById(`${panelId}ChatInput`);
        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
        
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendPanelChatMessage(panelId);
        }
    }


    // é€šç”¨çš„ AI API è°ƒç”¨
    async function runChatCompletion(messages, isStreaming = false, chunkCallback = null) {
        if (!settings.aiEndpoint || !settings.aiApiKey) {
            throw new Error('AI æœåŠ¡ç»ˆç«¯ç‚¹æˆ– API å¯†é’¥æœªé…ç½®ã€‚');
        }

        const response = await fetch(settings.aiEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${settings.aiApiKey}`
            },
            body: JSON.stringify({ model: settings.aiModel, messages, stream: isStreaming })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API è°ƒç”¨å¤±è´¥ [${response.status}]: ${errorText.substring(0, 100)}...`);
        }
        
        if (isStreaming) {
            if (!response.body) throw new Error("APIå“åº”æ²¡æœ‰æ­£æ–‡ï¼ˆå¯èƒ½ä¸æ”¯æŒæµå¼ä¼ è¾“ï¼‰ã€‚");
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            
            let fullText = "";
            let buffer = "";

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split('\n');
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine || trimmedLine === 'data: [DONE]') continue;
                        
                        try {
                            const json = JSON.parse(trimmedLine.substring(5));
                            const content = json.choices[0].delta.content || "";
                            fullText += content;
                            if (content && chunkCallback) {
                                chunkCallback(content);
                            }
                        } catch (e) {
                            // Ignore json parsing errors for incomplete chunks
                        }
                    }
                }
                
                // å¤„ç†æœ€åä¸€ä¸ª buffer
                if (buffer && buffer !== 'data: [DONE]') {
                    const json = JSON.parse(buffer.substring(5));
                    const content = json.choices[0].delta.content || "";
                    fullText += content;
                    if (content && chunkCallback) {
                        chunkCallback(content);
                    }
                }
                
                return fullText;
            } catch (e) {
                console.error("æµå¼è¯»å–é”™è¯¯:", e);
                throw e;
            }
        } else {
            const json = await response.json();
            return json.choices[0].message.content;
        }
    }


    // ========== Calendar AI é€»è¾‘ (å¯åŠ¨å¯¹è¯) ==========
    async function runCalendarAiAnalysis() {
        const panelId = 'calendar';
        
        // 1. é‡æ–°è¿è¡Œåˆè§„æ£€æŸ¥ä»¥ç¡®ä¿æ•°æ®æœ€æ–°
        checkCompliance(); 
        const violations = weekSummaries.filter(w => w.violation && w.end.startsWith(selectedMonth));
        
        if (violations.length === 0) {
            const statusEl = document.getElementById('complianceAdviceStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = 'ğŸ‰ æœ¬æœˆæ’ç­åˆè§„ï¼Œæ— éœ€ä¿®æ”¹å»ºè®®ã€‚æ‚¨å¯ä»¥ç»§ç»­æé—®ã€‚';
            resetPanelChat(panelId, statusEl.textContent);
        }

        // 2. æ„é€ ä¸Šä¸‹æ–‡æ•°æ®
        const violationDetails = violations.map(w => 
            `\n- ${w.start} to ${w.end}: ${w.total.toFixed(2)} å°æ—¶ (è¶…é™ ${ (w.total - settings.limit).toFixed(2) } å°æ—¶)`
        ).join('');
        
        // è·å–æœ¬æœˆæ‰€æœ‰æ’ç­è¯¦æƒ…
        const currentMonthShifts = getDetailedShifts(`${selectedMonth}-01`, getLocalDateString(getLastDayOfMonth()));
        const shiftDetails = currentMonthShifts.map(s => {
            if (s.shiftType === 'big') return `${s.date}: å¤§å¤œç­ (å«æ¬¡æ—¥) æ€»${s.totalHours.toFixed(1)}h`;
            if (s.shiftType === 'small') return `${s.date}: å°å¤œç­ æ€»${s.totalHours.toFixed(1)}h`;
            if (s.shiftType === 'custom') return `${s.date}: è‡ªå®šä¹‰ç­æ¬¡ æ€»${s.totalHours.toFixed(1)}h`;
            return null;
        }).filter(Boolean).join('; ');

        const contextData = `
            å½“å‰åˆ†ææœˆä»½ä¸º ${selectedMonth}ã€‚
            è§„åˆ™é™åˆ¶ï¼šè¿ç»­7å¤©å·¥æ—¶ä¸å¾—è¶…è¿‡ ${settings.limit} å°æ—¶ã€‚

            --- æ£€æµ‹åˆ°çš„è¿è§„è½®æ¬¡ ---
            å…±å‘ç° ${violations.length} æ¬¡è¶…é™ï¼š${violationDetails}

            --- æœ¬æœˆæ’ç­è®°å½•æ‘˜è¦ (ä»…ä¾›å‚è€ƒ) ---
            ${shiftDetails}
        `;
        
        // 3. è®¾ç½® System Prompt å’Œ Context
        panelContexts[panelId].system = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤œç­å·¥æ—¶åˆè§„æ”¹è¿›é¡¾é—®ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„è¿è§„æ’ç­è®°å½•ï¼Œæå‡º**å…·ä½“çš„ã€å¯æ“ä½œçš„**ä¿®æ”¹å»ºè®®ï¼Œä»¥æ¶ˆé™¤æ‰€æœ‰è¶…é™è½®æ¬¡ï¼Œå¹¶å°½é‡ä¿æŒåŸæ’ç­çš„å®Œæ•´æ€§ã€‚å»ºè®®åº”ä»¥**æ¸…æ™°çš„æ­¥éª¤**ï¼ˆä¾‹å¦‚ï¼šå°†Xæ—¥çš„ç­æ¬¡è°ƒæ•´ä¸ºä¼‘æ¯ï¼Œå°†Yæ—¥è°ƒæ•´ä¸ºZç­æ¬¡ï¼‰ç»™å‡ºã€‚`;
        panelContexts[panelId].data = contextData;

        // 4. å¯åŠ¨å¯¹è¯
        const initialPrompt = `è¯·æ ¹æ®ä»¥ä¸Šè¿è§„æƒ…å†µï¼Œæä¾›ä¸€ä¸ªä¿®æ”¹æ’ç­çš„å»ºè®®æ–¹æ¡ˆï¼Œä»¥ç¡®ä¿æ‰€æœ‰è¿ç»­7å¤©å·¥æ—¶ä¸è¶…é™ã€‚`;
        // é‡ç½®å¹¶å¯åŠ¨å¯¹è¯
        resetPanelChat(panelId);
        displayPanelMessage(panelId, 'user', `è¯·æ±‚æ’ç­ä¿®æ”¹å»ºè®®ï¼ˆåŸºäº ${violations.length} æ¬¡è¶…é™ï¼‰ã€‚æ•°æ®å·²æäº¤ç»™ AIã€‚`);
        sendPanelChatMessage(panelId, initialPrompt);
    }

    // ========== Stats AI é€»è¾‘ (å¯åŠ¨å¯¹è¯) ==========
    async function runAiAnalysis() {
        if (!currentStatsSummary.totalDays) {
            alert('è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´ï¼Œå¹¶ç‚¹å‡»â€œåˆ†æâ€æŒ‰é’®è·å–ç»Ÿè®¡æ•°æ®ã€‚');
            return;
        }
        
        const panelId = 'stats';
        const summary = currentStatsSummary;

        // 1. æ„é€ ä¸Šä¸‹æ–‡æ•°æ®
        const contextData = `
            ã€ç»Ÿè®¡åˆ†ææ•°æ®ã€‘
            æ—¥æœŸèŒƒå›´: ${summary.dateRange} (å…± ${summary.totalDays} å¤©)
            æ€»å·¥æ—¶: ${summary.totalHours.toFixed(1)} å°æ—¶
            æ€»å·¥ä½œå¤©æ•°: ${summary.totalWorkDays} å¤©
            å¤§å¤œç­: ${summary.bigCount} æ¬¡
            å°å¤œç­: ${summary.smallCount} æ¬¡
            æœ€é•¿è¿ç»­å·¥ä½œå¤©æ•°: ${summary.maxConsecutive} å¤©
            7å¤©è¶…é™æ¬¡æ•°: ${summary.violationCount} æ¬¡ (é™${settings.limit}h)
            --- è¯¦ç»†æ’ç­è®°å½•æ‘˜è¦ ---
            ${summary.detailedShiftsText}
        `;
        
        // 2. è®¾ç½® System Prompt å’Œ Context
        panelContexts[panelId].system = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤œç­å·¥ä½œè€…å¥åº·ä¸ç”Ÿæ´»è§„åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„æ’ç­ç»Ÿè®¡æ•°æ®ï¼Œä»å¥åº·ã€ä¼‘æ¯ã€æƒ…ç»ªå’Œç¤¾äº¤ç”Ÿæ´»ç­‰æ–¹é¢æä¾›ä¸ªæ€§åŒ–ã€å¯Œæœ‰åŒæƒ…å¿ƒçš„å»ºè®®ã€‚è¯·é‡ç‚¹å…³æ³¨ä¼‘æ¯æ¢å¤ã€è¥å…»è¡¥å……å’Œä½œæ¯è°ƒæ•´ï¼Œé¿å…ç›´æ¥æä¾›ä¿®æ”¹æ’ç­çš„å»ºè®®ã€‚`;
        panelContexts[panelId].data = contextData;

        // 3. å¯åŠ¨å¯¹è¯
        const initialPrompt = `è¯·åŸºäºä»¥ä¸Šç»Ÿè®¡æ•°æ®å’Œæ’ç­è®°å½•ï¼Œæä¾›ä¸€ä»½é’ˆå¯¹æ€§çš„å¤œç­å¥åº·ç®¡ç†å»ºè®®ã€‚`;
        // é‡ç½®å¹¶å¯åŠ¨å¯¹è¯
        resetPanelChat(panelId);
        displayPanelMessage(panelId, 'user', `è¯·æ±‚å¥åº·ç®¡ç†å»ºè®®ï¼ˆåŸºäº ${summary.dateRange} çš„ç»Ÿè®¡æ•°æ®ï¼‰ã€‚æ•°æ®å·²æäº¤ç»™ AIã€‚`);
        sendPanelChatMessage(panelId, initialPrompt);
    }

    // ============ AI ç§äººå¥åº·åŠ©æ‰‹ç±» (Chat Panel) ============
    class AIAssistant {
        static systemMessage = { role: 'system', content: '' };
        static contextData = ''; // å­˜å‚¨æ’ç­æ•°æ®
        static history = [];
        static isTyping = false;
        
        static get historyEl() { return document.getElementById('chatHistory'); }
        static get chatInputEl() { return document.getElementById('chatInput'); }
        static get sendBtnEl() { return document.getElementById('chatSendBtn'); }

        static initSystemMessage() {
            this.systemMessage.content = `ä½ æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„ç§äººå¥åº·åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„æ’ç­ä¿¡æ¯å’Œé—®é¢˜ï¼Œä»å¥åº·ã€ä½œæ¯ã€å¿ƒç†ç­‰æ–¹é¢æä¾›ä¸“ä¸šã€å®ç”¨çš„å»ºè®®ã€‚`;
            document.getElementById('chatConfigStatus').textContent = `AIæ¨¡å‹ï¼š${settings.aiModel}`;
        }

        static displayMessage(role, content, save = true) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message chat-${role}`;
            
            // è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç å—å’Œæ¢è¡Œ
            const formattedContent = content
                .replace(/```(.*?)\n([\s\S]*?)```/gs, (match, lang, code) => {
                    return `<pre><code>${code.trim()}</code></pre>`;
                })
                .replace(/\n/g, '<br>');
                
            msgDiv.innerHTML = formattedContent;
            this.historyEl.appendChild(msgDiv);
            this.historyEl.scrollTop = this.historyEl.scrollHeight;
            
            if (save && role !== 'system') {
                this.history.push({ role, content });
            }
        }
        
        static displayChunk(content) {
            const historyEl = this.historyEl;
            let lastMessage = historyEl.lastChild;
            
            if (!lastMessage || !lastMessage.classList.contains('chat-ai')) {
                lastMessage = document.createElement('div');
                lastMessage.className = 'chat-message chat-ai';
                historyEl.appendChild(lastMessage);
            }
            
            // ç”±äºæ˜¯æµå¼ä¼ è¾“ï¼Œè¿™é‡Œç›´æ¥è¿½åŠ å†…å®¹å¹¶å¤„ç†æ¢è¡Œ
            lastMessage.innerHTML += content.replace(/\n/g, '<br>');
            historyEl.scrollTop = historyEl.scrollHeight;
        }

        static async sendMessage(userMessage) {
            if (this.isTyping) return;
            this.isTyping = true;
            this.displayMessage('user', userMessage);
            
            this.chatInputEl.value = '';
            this.chatInputEl.disabled = true;
            this.sendBtnEl.disabled = true;

            // ä¿®å¤ï¼šåˆå¹¶ç³»ç»Ÿæ¶ˆæ¯å’Œä¸Šä¸‹æ–‡æ•°æ®
            let finalSystemContent = this.systemMessage.content;
            if (this.contextData) {
                finalSystemContent = `${this.systemMessage.content}\n\n${this.contextData}`;
            }
            const finalSystemMessage = { role: 'system', content: finalSystemContent };

            let messages = [
                finalSystemMessage, 
                ...this.history.filter(m => m.role !== 'system'), 
                { role: 'user', content: userMessage }
            ];

            try {
                const fullResponse = await runChatCompletion(messages, true, (chunk) => {
                    this.displayChunk(chunk);
                });
                
                // æœ€ç»ˆæ ¼å¼åŒ–å¹¶ä¿å­˜
                this.history.pop(); // ç§»é™¤ä¸´æ—¶ç”¨æˆ·æ¶ˆæ¯
                this.displayMessage('assistant', fullResponse, true);
                
            } catch (e) {
                this.displayMessage('assistant', `âŒ AI åŠ©æ‰‹å¤±è´¥ï¼š${e.message || 'æœªçŸ¥é”™è¯¯'}`, false);
            } finally {
                this.isTyping = false;
                this.chatInputEl.disabled = false;
                this.sendBtnEl.disabled = false;
                // ç¡®ä¿è¾“å…¥æ¡†å›åˆ°ä¸€è¡Œ
                this.chatInputEl.style.height = 'auto';
            }
        }

        static analyzeShiftData() {
            const startInput = document.getElementById('chatStartDate').value;
            const endInput = document.getElementById('chatEndDate').value;
            
            if (!startInput || !endInput) {
                this.displayMessage('assistant', 'è¯·å…ˆé€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´ã€‚', false);
                return;
            }

            const detailedShifts = getDetailedShifts(startInput, endInput);

            if (detailedShifts.length === 0) {
                AIAssistant.displayMessage('assistant', `âš ï¸ åœ¨ ${startInput} è‡³ ${endInput} èŒƒå›´å†…æœªæ‰¾åˆ°ä»»ä½•æ’ç­è®°å½•ã€‚è¯·æ£€æŸ¥æ‚¨é€‰æ‹©çš„æ—¥æœŸã€‚`, false);
                return;
            }

            const conciseShiftLines = detailedShifts.map(s => {
                let description = '';
                if (s.shiftType === 'big') description = `å¤§å¤œç­ (æœ¬æ—¥${(parseFloat(s.raw.hours) || 0).toFixed(1)}h + æ¬¡æ—¥${settings.bigNext.toFixed(1)}h)`;
                else if (s.shiftType === 'small') description = `å°å¤œç­ (${s.totalHours.toFixed(1)}h)`;
                else if (s.shiftType === 'custom') description = `è‡ªå®šä¹‰ç­æ¬¡ (${s.totalHours.toFixed(1)}h)`;
                return `${s.date}: ${description}`;
            }).join('\n');
            
            // ä¿®å¤ï¼šå°†ä¸Šä¸‹æ–‡æ•°æ®å­˜å…¥ contextData å˜é‡
            this.contextData = `
                ã€æ’ç­åˆ†ææ•°æ®ã€‘
                ç”¨æˆ·æä¾›çš„æ’ç­æ•°æ®èŒƒå›´ä¸º ${startInput} è‡³ ${endInput}ï¼Œå…·ä½“è®°å½•å¦‚ä¸‹ï¼š
                ${conciseShiftLines}
            `;
            this.history = [];

            const initialPrompt = `è¯·æ ¹æ®æˆ‘æä¾›çš„æ’ç­è®°å½•ï¼Œåˆ†æå…¶å¯¹æˆ‘çš„å¥åº·ï¼ˆç‰¹åˆ«æ˜¯ç¡çœ å’Œæƒ…ç»ªï¼‰å¯èƒ½é€ æˆçš„å½±å“ï¼Œå¹¶æå‡ºä¸€ä»½ä¸ªæ€§åŒ–çš„å¥åº·ç®¡ç†å’Œä½œæ¯è°ƒæ•´å»ºè®®ã€‚`;
            this.displayMessage('user', initialPrompt, true);
            this.sendMessage(initialPrompt);
        }
    }
    
    function initDateRangeForChat() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        const chatStartEl = document.getElementById('chatStartDate');
        const chatEndEl = document.getElementById('chatEndDate');
        
        if (!chatStartEl.value) chatStartEl.value = getLocalDateString(thirtyDaysAgo);
        if (!chatEndEl.value) chatEndEl.value = getLocalDateString(today);
    }
    
    function handleChatInput(event) {
        const inputEl = document.getElementById('chatInput');
        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
        
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            AIAssistant.sendMessage(inputEl.value.trim());
        }
    }

    function resetChatHistory() {
        if (!confirm('ç¡®å®šè¦é‡ç½® AI ç§äººå¥åº·åŠ©æ‰‹çš„æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) return;
        AIAssistant.history = [];
        AIAssistant.contextData = '';
        AIAssistant.historyEl.innerHTML = '';
        AIAssistant.initSystemMessage();
        AIAssistant.displayMessage('assistant', 'å¯¹è¯å·²é‡ç½®ã€‚è¯·æä¾›æ–°çš„æ’ç­èŒƒå›´æˆ–å¼€å§‹æé—®ã€‚', false);
    }
    
    // ============ åˆå§‹åŒ–é€»è¾‘ ============
    function init() {
      loadFromLocal();
      // [æ–°å¢] æ£€æŸ¥å¹¶æ›´æ–°UIçš„æƒé™çŠ¶æ€
      updateUIForAuth(getUserId(), isReadOnly ? 'guest' : 'owner'); 

      document.getElementById('monthInput').value = selectedMonth;
      
      loadSettingsUI();
      renderCalendar();
      
      initDateRangeForStats();

      // å¼‚æ­¥åŠ è½½äº‘ç«¯æ•°æ®
      loadFromCloud().then(success => {
          if (success) {
              isInitialLoadComplete = true; 
              // ç¡®ä¿å®æ—¶æ›´æ–°
              setupSupabaseRealtime();
          }
          // é‡æ–°æ¸²æŸ“ä»¥ç¡®ä¿äº‘ç«¯æ•°æ®å·²åŠ è½½
          renderCalendar();
      });

      // å®æ—¶è®¢é˜…ï¼ˆåœ¨ loadFromCloud æˆåŠŸåè°ƒç”¨ï¼‰
      function setupSupabaseRealtime() {
        if (!supabase || window.supabaseSubscription) return;
        
        const userId = getUserId();
        let lastSyncTimestamp = Date.now();
        
        const subscription = supabase.channel('shifts_and_settings')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts', filter: `user_id=eq.${userId}` }, async (payload) => {
            const now = Date.now();
            if (syncManager.isSyncing || now - lastSyncTimestamp < 2000) return;
            lastSyncTimestamp = now;
            console.log('æ”¶åˆ°äº‘ç«¯ç­æ¬¡æ›´æ–°', payload.eventType);
            await loadFromCloud();
            isInitialLoadComplete = true; // ç¡®ä¿å®æ—¶æ›´æ–°ä¹Ÿè®¾ç½®äº†æ ‡å¿—
            renderCalendar();
          })
          .on('postgres_changes', { event: '*', schema: 'public', table: 'settings', filter: `user_id=eq.${userId}` }, async (payload) => {
            const now = Date.now();
            if (syncManager.isSyncing || now - lastSyncTimestamp < 2000) return;
            lastSyncTimestamp = now;
            console.log('æ”¶åˆ°äº‘ç«¯è®¾ç½®æ›´æ–°', payload.eventType);
            await loadFromCloud();
            loadSettingsUI();
          })
          .subscribe((status) => { console.log('å®æ—¶è®¢é˜…çŠ¶æ€:', status); });
        
        window.supabaseSubscription = subscription;
      }
    }

    window.onload = init;

    window.onclick = (e) => { 
        if (e.target.id === 'extraModal') closeExtraModal(); 
        if (e.target.id === 'contextMenu') document.getElementById('contextMenu').style.display = 'none';
        
        // å¦‚æœä¸æ˜¯åœ¨å¤šé€‰æ¨¡å¼ä¸‹ï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯æ—¥å†å•å…ƒæ ¼ï¼Œåˆ™æ¸…é™¤å³é”®èœå•
        if (!isMultiSelectMode && !e.target.closest('.day-cell')) {
            document.getElementById('contextMenu').style.display = 'none';
        }

        // å¦‚æœç‚¹å‡»äº†æ—¥å†å•å…ƒæ ¼ï¼Œä½†ä¸åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™æ¸…é™¤å¤šé€‰çŠ¶æ€
        if (!isMultiSelectMode && e.target.closest('.day-cell')) {
            // Note: The single-click logic inside renderCalendar already handles clearing selections
        }
    };
  </script>
</body>
</html>
